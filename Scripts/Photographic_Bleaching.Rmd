---
title: "Photographic_Bleaching"
author: "EL Strand"
date: "6/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

### Loading in required libraries. 
```{r}
library("vegan")
library("ggpubr")
library("gridExtra")
library(tidyverse)
library("emmeans")
library("multcompView")
library("rstatix")
library("Rmisc")
library("lme4")
library("car")
library("MuMIn")
library(sjPlot)
```

### Reading in quality controlled version of ImageJ data.
Protocol for ImageJ Bleaching Score Analysis found [here](https://emmastrand.github.io/EmmaStrand_Notebook/ImageJ-Analysis-Protocols/).  
```{r}
Data <- read.csv("data/Physiology_variables/Bleaching_ImageJ_QC.csv", header=T, sep=",", na.string="NA") #read in data file
Sample.Info <- read.csv("metadata/Master_Fragment.csv", header=T, sep=",", na.string="NA") #read in data file 
Sample.Info <- Sample.Info[,c(7,5,9)]
Tank.Info <- read.csv("metadata/Tank_to_Treatment.csv", header=T, sep=",", na.string="NA") #read in data file 

# Double checking the Plug IDs are associated with the correct tanks. 
A <- Sample.Info$PLUG.ID
B <- Data$PLUG.ID
bad.id.tanks <- which(B %in% A ==FALSE)
bad.id.tanks

Data <-na.omit(Data) # removing all rows with NA values 
```

### Normalizing to color standards. 
```{r}
Data$Red.Norm.Coral <- Data$Red.Coral/Data$Red.Standard
Data$Green.Norm.Coral <- Data$Green.Coral/Data$Green.Standard
Data$Blue.Norm.Coral <- Data$Blue.Coral/Data$Blue.Standard
```

```{r}
blch.scor <- as.matrix(cbind(Data$Red.Norm.Coral,Data$Green.Norm.Coral,Data$Blue.Norm.Coral)) #create matrix
rownames(blch.scor) <- Data$PLUG.ID #name columns in dataframe

dist <- vegdist(blch.scor, method="euclidean") #calculate distance matrix of color scores

PCA.color <- princomp(dist) #run principal components Analysis
print(summary(PCA.color)) # view variance explained by PCs
screeplot(PCA.color, type = "line", main = "Scree plot")

Blch <- as.data.frame(-PCA.color$scores[,1]) #extract PC1
Blch$PLUG.ID <- rownames(blch.scor)

Blch  <- cbind(Blch, Data$Timepoint, Data$Temperature, Data$CO2, Data$Treatment, Data$Species) #make a dataframe of PC1 and experiment factors
colnames(Blch) <- c("Bleaching.Score", "PLUG.ID", "Timepoint", "Temperature", "CO2", "Treatment", "Species")
Blch$Group <- paste(Blch$Timepoint, Blch$Treatment, Blch$Species)
Blch$SpGroup <- paste(Blch$Treatment, Blch$Species)
```

### Output: Color Score dataframe and checking for outliers in the dataset. 
```{r}
write.table(Blch, file = "Physiology_variables/Bleaching_Score_Output.csv", append = FALSE, quote = TRUE, sep = ",",
            eol = "\n", na = "NA", dec = ".", row.names = TRUE,
            col.names = TRUE, qmethod = c("escape", "double"),
            fileEncoding = "")

x<- Blch #assign values to test data frame to look for outliers
par(mar=c(10,4,2,2)) #bottom, left, top and right margins respectively
boxplot(Bleaching.Score ~ Group, data = x, lwd = 1, ylab = 'PC1Color', las=2, cex=0.8) #plot boxplot of PC1 color score by treatment and timepoint

```

### Calculating means, sample size, and standard error for timepoint, species, and treatment groups. 
```{r}
# color.data defined in stats section 

All.Means <- summarySE(Blch, measurevar="Bleaching.Score", groupvars=c("Species", "Timepoint", "Treatment", "Temperature", "CO2")) %>% 
  filter(N>2) %>% na.omit()

#All.Means <- ddply(Color.Score, c('Timepoint','Species','Treatment'), summarize,
                  #  mean= mean(Bleaching.Score, na.rm=T), #mean pnet
                 #   N = sum(!is.na(Bleaching.Score)), # sample size
                  #  se = sd(Bleaching.Score, na.rm=T)/sqrt(N)) #SE

#All.Means$se[is.na(All.Means$se)] <- 0
#All.Means$Group <- paste(All.Means$Timepoint, All.Means$Treatment, All.Means$Species)
#All.Means$SpGroup <- paste(All.Means$Treatment, All.Means$Species)
#All.Means <- All.Means[-c(87:94),]

All.Means$Timepoint <- factor(All.Means$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week5", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16")) 
All.Means <- All.Means %>% subset(Timepoint!="Week5")
```

### Subsetting larger bleaching dataframe to species level.
```{r}
Mcap.Blch <- subset(All.Means, Species=="Montipora")
Pact.Blch <- subset(All.Means, Species=="Pocillopora")
```

# Statistics 

### Reading in all dataframes. This can be run separately from the above code. 
```{r}
Master <- read.csv("metadata/Master_Fragment.csv") %>% select(Site.Name, Plug_ID, Species, ANALYSIS, Timepoint, Treatment, Tank, Temperature, CO2)

Color.Score <- read.csv("data/Physiology_variables/Bleaching_Score_Output.csv") %>% select(PLUG.ID, Bleaching.Score, Timepoint) %>% dplyr::rename(Plug_ID = PLUG.ID) %>% 
  dplyr::rename(Blch.Time = Timepoint)
Color.Score$Blch.Time <- gsub("^.{0,4}", "", Color.Score$Blch.Time) # taking out the "Week" in every row
Color.Score$Blch.Time <- paste(Color.Score$Blch.Time, "week") # adding "week" after each number in every row 

color.data <- full_join(Master, Color.Score, by = "Plug_ID") %>% na.omit()
```

### Raw distribution score.
```{r}
color.data$Plug_ID <- as.character(color.data$Plug_ID)
color.data$Blch.Time <- as.factor(color.data$Blch.Time)

## Mcapitata 
mcap.color.stress <- color.data %>% subset(Species == "Mcapitata") %>% 
  subset(Blch.Time == "1 week" | Blch.Time == "2 week" |
         Blch.Time == "3 week" | Blch.Time == "4 week" |
         Blch.Time == "5 week" | Blch.Time == "6 week" |
         Blch.Time == "7 week" | Blch.Time == "8 week")

mcap.color.recovery <- color.data %>% subset(Species == "Mcapitata") %>% 
  subset(Blch.Time == "9 week" | Blch.Time == "10 week" |
         Blch.Time == "11 week" | Blch.Time == "12 week" |
         Blch.Time == "13 week" | Blch.Time == "14 week" |
         Blch.Time == "15 week" | Blch.Time == "16 week")

## Pacuta 
pacuta.color.stress <- color.data %>% subset(Species == "Pacuta") %>% 
  subset(Blch.Time == "1 week" | Blch.Time == "2 week" |
         Blch.Time == "3 week" | Blch.Time == "4 week" |
         Blch.Time == "5 week" | Blch.Time == "6 week" |
         Blch.Time == "7 week" | Blch.Time == "8 week")

pacuta.color.recovery <- color.data %>% subset(Species == "Pacuta") %>% 
  subset(Blch.Time == "9 week" | Blch.Time == "10 week" |
         Blch.Time == "11 week" | Blch.Time == "12 week")

hist(pacuta.color$Bleaching.Score) 
hist(mcap.color$Bleaching.Score) 
# both very left/negatively skewed 
```

## Mixed effect modeling 

### Checking raw data for both species 
100 was added to each color score value to shift the distribution to be all positive values instead of negative.

```{r}
## Mcap 
mcap.color.stress$Color.Transformed <- mcap.color.stress$Bleaching.Score+100
range(mcap.color.stress$Color.Transformed)
hist(mcap.color.stress$Color.Transformed)

mcap.color.recovery$Color.Transformed <- mcap.color.recovery$Bleaching.Score+100
range(mcap.color.recovery$Color.Transformed)
hist(mcap.color.recovery$Color.Transformed)

## Pacuta 
pacuta.color.stress$Color.Transformed <- pacuta.color.stress$Bleaching.Score+120
range(pacuta.color.stress$Color.Transformed)
hist(pacuta.color.stress$Color.Transformed)

pacuta.color.recovery$Color.Transformed <- pacuta.color.recovery$Bleaching.Score+120
range(pacuta.color.recovery$Color.Transformed)
hist(pacuta.color.recovery$Color.Transformed)
```

Data is heavily left skewed and calls for transformation.

### M.capitata

Originally, we had our random factors as `(1|Tank/Plug_ID)` because fragments were repeatedly measured and did not move tanks throughout the experiment. However, we got a `boundary (singular) fit: see ?isSingular` warning indicating that our model was over-fitted. **come back to this**. 
- [Dealing with singular fits in models](https://stats.stackexchange.com/questions/378939/dealing-with-singular-fit-in-mixed-models). This thread suggested using a Bayesian framework if we wanted to keep the random factors.    
- Alternatively, we could remove the most complex part of the random effects. However, our experimental design calls for this structure: `(1|Tank/Plug_ID)`. 

The data transformation that worked the best was the `Color.Transformed` data column squared. 

```{r}
## Stress 
Mcap_stress_sq <- lmer((Color.Transformed^(2)) ~ Blch.Time*Temperature*CO2 + (1|Tank/Plug_ID), na.action=na.omit, data=mcap.color.stress)

## Recovery 
Mcap_recovery_sq <- lmer((Color.Transformed^2) ~ Blch.Time*Temperature*CO2 + (1|Tank/Plug_ID), na.action=na.omit, data=mcap.color.recovery)

qqPlot(residuals(Mcap_stress_sq)) 
qqPlot(residuals(Mcap_recovery_sq)) 

hist(residuals(Mcap_stress_sq))
hist(residuals(Mcap_recovery_sq))

mcap.sq.stress.anova <- Anova(Mcap_stress_sq, ddf="lme4", type='III') 
mcap.sq.recovery.anova <- Anova(Mcap_recovery_sq, ddf="lme4", type='III') 

capture.output(mcap.sq.stress.anova, file = "Output/Statistics/Stress_statistics/ColorScore_Mcap_sq.txt")
capture.output(mcap.sq.recovery.anova, file = "Output/Statistics/Recovery_statistics/ColorScore_Mcap_sq.txt")
```

### P. acuta 

The data transformation that worked the best was the `Color.Transformed` data column squared. 

```{r}
## Stress 
Pacuta_stress_sq <- lmer((Color.Transformed^(2)) ~ Blch.Time*Temperature*CO2 + (1|Tank/Plug_ID), na.action=na.omit, data=pacuta.color.stress)

## Recovery 
Pacuta_recovery_sq <- lmer((Color.Transformed^2) ~ Blch.Time*Temperature*CO2 + (1|Tank/Plug_ID), na.action=na.omit, data=pacuta.color.recovery)

qqPlot(residuals(Pacuta_stress_sq)) 
qqPlot(residuals(Pacuta_recovery_sq)) 

hist(residuals(Pacuta_stress_sq))
hist(residuals(Pacuta_recovery_sq))

pacuta.sq.stress.anova <- Anova(Pacuta_stress_sq, ddf="lme4", type='III') 
pacuta.sq.recovery.anova <- Anova(Pacuta_recovery_sq, ddf="lme4", type='III') 

capture.output(pacuta.sq.stress.anova, file = "Output/Statistics/Stress_statistics/ColorScore_Pacuta_sq.txt")
capture.output(pacuta.sq.recovery.anova, file = "Output/Statistics/Recovery_statistics/ColorScore_Pacuta_sq.txt")
```

# Plotting 

Mcap and Pacuta together.
```{r}
species.names <- list(
  'Montipora'="Montipora capitata",
  'Pocillopora'="Pocillopora acuta")

species_labeller <- function(variable,value){
  return(species.names[value])}

cols <- c("blue", "lightblue", "salmon", "red3")

Blch_plot <- ggplot(All.Means, aes(x=Timepoint, y = Bleaching.Score, group = Treatment, color = Treatment)) +
  geom_line() + 
  geom_point(size=3) +
  #facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=Bleaching.Score-se, ymax=Bleaching.Score+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Color Score") + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = c(0.1,0.3)) +
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 12)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(legend.title = element_text(size = 13)) +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Blch_plot

ggsave(file="Output/Figures/Supplemental_figures/Photographic_Bleaching.pdf", Blch_plot, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Figures/Supplemental_figures/Photographic_Bleaching.png", Blch_plot, width = 11, height = 6, units = c("in"))
```

Pub figure 

```{r}
Blch_edited <- Blch %>% subset(!Timepoint == "Week5") 
Blch_edited$Timepoint <- factor(Blch_edited$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16"))

color_pub <- ggplot(All.Means, aes(x=Timepoint, y = Bleaching.Score, group = Treatment, color = Treatment)) +
  geom_jitter(data = Blch_edited, aes(x=Timepoint, y = Bleaching.Score, group = Treatment, color = Treatment), size=0.5, width=0.2, alpha=0.2) + 
  geom_line() + 
  geom_point(size=2.5) +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=Bleaching.Score-se, ymax=Bleaching.Score+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab("Color Score") + # y-axis label and y axis range
  theme(legend.position = c(0.6,0.1)) +
  geom_vline(xintercept = c(7.2), colour="grey", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 18, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")) + theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 10)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 12)); color_pub # Change axis line

ggsave(file="Output/Figures/Supplemental_figures/Color_score.png", color_pub, width = 16, height = 9, units = c("in"))
```

For Coral Stress Phenome Paper
```{r}
CSP_plot <- ggplot(All.Means, aes(x=Timepoint, y = Bleaching.Score, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=Bleaching.Score-se, ymax=Bleaching.Score+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Color Score") + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = c(0.09, 0.22)) +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); CSP_plot

ggsave(file="Output/Final_Figures/CSP-Photographic_Bleaching.png", CSP_plot, width = 11, height = 6, units = c("in"))
```

