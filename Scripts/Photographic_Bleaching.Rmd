---
title: "Photographic_Bleaching"
author: "EL Strand"
date: "6/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

Loading in required libraries. 
```{r}
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggpubr" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggpubr') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("plyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('plyr') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcompView" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcompView') 
if ("rstatix" %in% rownames(installed.packages()) == 'FALSE') install.packages('rstatix') 

#Read in required libraries
##### Include Versions of libraries
library("vegan")
library("ggpubr")
library("gridExtra")
library("plyr") 
library("emmeans")
library("multcompView")
library("rstatix")
library("Rmisc")
```

Reading in quality controlled version of ImageJ data.
Protocol for ImageJ Bleaching Score Analysis found [here](https://emmastrand.github.io/EmmaStrand_Notebook/ImageJ-Analysis-Protocols/).  
```{r}
Data <- read.csv("Physiology_variables/Bleaching_ImageJ_QC.csv", header=T, sep=",", na.string="NA") #read in data file
Sample.Info <- read.csv("Environmental_data/Master_Fragment.csv", header=T, sep=",", na.string="NA") #read in data file 
Sample.Info <- Sample.Info[,c(7,5,9)]
Tank.Info <- read.csv("Environmental_data/Tank_to_Treatment.csv", header=T, sep=",", na.string="NA") #read in data file 

# Double checking the Plug IDs are associated with the correct tanks. 
A <- Sample.Info$PLUG.ID
B <- Data$PLUG.ID
bad.id.tanks <- which(B %in% A ==FALSE)
bad.id.tanks

Data <-na.omit(Data) # removing all rows with NA values 
```

Normalizing to color standards. 
```{r}
Data$Red.Norm.Coral <- Data$Red.Coral/Data$Red.Standard
Data$Green.Norm.Coral <- Data$Green.Coral/Data$Green.Standard
Data$Blue.Norm.Coral <- Data$Blue.Coral/Data$Blue.Standard
```

```{r}
blch.scor <- as.matrix(cbind(Data$Red.Norm.Coral,Data$Green.Norm.Coral,Data$Blue.Norm.Coral)) #create matrix
rownames(blch.scor) <- Data$PLUG.ID #name columns in dataframe

dist <- vegdist(blch.scor, method="euclidean") #calculate distance matrix of color scores

PCA.color <- princomp(dist) #run principal components Analysis
summary(PCA.color) # view variance explained by PCs

Blch <- as.data.frame(-PCA.color$scores[,1]) #extract PC1
Blch$PLUG.ID <- rownames(blch.scor)

Blch  <- cbind(Blch, Data$Timepoint, Data$Temperature, Data$CO2, Data$Treatment, Data$Species) #make a dataframe of PC1 and experiment factors
colnames(Blch) <- c("Bleaching.Score", "PLUG.ID", "Timepoint", "Temperature", "CO2", "Treatment", "Species")
Blch$Group <- paste(Blch$Timepoint, Blch$Treatment, Blch$Species)
Blch$SpGroup <- paste(Blch$Treatment, Blch$Species)
```

Output: Bleaching Score dataframe and checking for outliers in the dataset. 
```{r}
write.table(Blch, file = "Physiology_variables/Bleaching_Score_Output.csv", append = FALSE, quote = TRUE, sep = ",",
            eol = "\n", na = "NA", dec = ".", row.names = TRUE,
            col.names = TRUE, qmethod = c("escape", "double"),
            fileEncoding = "")

x<- Blch #assign values to test data frame to look for outliers
par(mar=c(10,4,2,2)) #bottom, left, top and right margins respectively
boxplot(Bleaching.Score ~ Group, data = x, lwd = 1, ylab = 'PC1Color', las=2, cex=0.8) #plot boxplot of PC1 color score by treatment and timepoint

```

** Statistical Analysis and Plotting ** 
```{r}
# for use in plotting to avoid having to run PCA again
Color.Score <- read.csv("Physiology_variables/Bleaching_Score_Output.csv", header=T, sep=",", na.string="NA") #read in data file

mod1 <- aov(sqrt(Bleaching.Score+200) ~ Temperature*CO2*Timepoint*Species, data=Color.Score) #run an ANOVA 
hist(residuals(mod1)) #look at normality of data
boxplot(residuals(mod1)) #look at normality of data
summary(mod1)

#posthoc analyses
marginal <- emmeans(mod1, ~ Temperature*CO2*Timepoint*Species)

#letter display of posthoc results
phlett <- multcomp::cld(marginal,
          alpha=0.05,
          Letters=letters,
          adjust="tukey")

phlett <- phlett[order(phlett$Timepoint, phlett$Temperature, phlett$CO2, phlett$Species),]
phlett
```

Calculating means, sample size, and standard error for timepoint, species, and treatment groups. 
```{r}
All.Means <- summarySE(Color.Score, measurevar="Bleaching.Score", groupvars=c("Species", "Timepoint", "Treatment", "Temperature", "CO2")) %>% 
  filter(N>2) %>% na.omit()

#All.Means <- ddply(Color.Score, c('Timepoint','Species','Treatment'), summarize,
                  #  mean= mean(Bleaching.Score, na.rm=T), #mean pnet
                 #   N = sum(!is.na(Bleaching.Score)), # sample size
                  #  se = sd(Bleaching.Score, na.rm=T)/sqrt(N)) #SE

#All.Means$se[is.na(All.Means$se)] <- 0
#All.Means$Group <- paste(All.Means$Timepoint, All.Means$Treatment, All.Means$Species)
#All.Means$SpGroup <- paste(All.Means$Treatment, All.Means$Species)
#All.Means <- All.Means[-c(87:94),]

All.Means$Timepoint <- factor(All.Means$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week5", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16")) 
All.Means <- All.Means %>% subset(Timepoint!="Week5")
```

Plotting bleaching intensity for both species, and for all timepoints and treatments. 
```{r}
cols <- c("lightblue", "blue", "salmon", "red3")

Fig.All <- ggplot(All.Means, aes(x=Timepoint, y=mean, group=SpGroup)) + 
  geom_line(aes(linetype= Species, colour=Treatment, group=SpGroup), position = position_dodge(width = 0.1), alpha=0.5) + # colour, group both depend on cond2
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=0, size=0.5, position = position_dodge(width = 0.1)) +
  geom_point(aes(colour=Treatment, shape=Species), size = 1, position = position_dodge(width = 0.1)) +
  scale_colour_manual(values=cols) +
  #annotate("text", x=43, y=1.85, label = "a", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=132, y=2.15, label = "b", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(43,43), y=c(2.45,2.2), label = "ab", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(141,141), y=c(3.15,3.4), label = "c", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=35, y=0.5, label = ".", size = 1) + #add text to the graphic for posthoc letters
  xlab("Timepoint") +
  ylab(expression(paste("Color Score"))) +
  ylim(-110, 20) +
  theme_bw() + #Set the background color
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), #Set the text angle
        axis.line = element_line(color = 'black'), #Set the axes color
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        plot.background=element_blank(),  #Set the plot background
        legend.position= "right") + #remove legend background
  ggtitle("Photographic Bleaching") +
  theme(plot.title = element_text(face = 'bold', 
                                  size = 10, 
                                  hjust = 0))
Fig.All

#pdf("Physiology_variables/Bleaching_All.pdf")
#print(Fig.All, newpage = FALSE)
#dev.off()

#png("Physiology_variables/Bleaching_All.png")
#print(Fig.All, newpage = FALSE)
#dev.off()
```

Subsetting larger bleaching dataframe to species level.
```{r}
Mcap.Blch <- subset(All.Means, Species=="Montipora")
Pact.Blch <- subset(All.Means, Species=="Pocillopora")
```

Plotting Mcap and Pacuta together.
```{r}
species.names <- list(
  'Montipora'="Montipora capitata",
  'Pocillopora'="Pocillopora acuta")

species_labeller <- function(variable,value){
  return(species.names[value])}

Blch_plot <- ggplot(All.Means, aes(x=Timepoint, y = Bleaching.Score, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free", labeller = species_labeller) +
  geom_errorbar(aes(ymin=Bleaching.Score-se, ymax=Bleaching.Score+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab("Bleaching Score") + # y-axis label and y axis range
  theme_classic() + 
  ggtitle("Color Score") +
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Blch_plot

ggsave(file="Output/Final_Figures/Photographic_Bleaching.pdf", Blch_plot, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Photographic_Bleaching.png", Blch_plot, width = 11, height = 6, units = c("in"))
```


Calculating M.cap means and plotting bleaching score
```{r}
Fig.MC <- ggplot(Mcap.Blch, aes(x=Timepoint, y=mean, group=Treatment)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=.1, position = position_dodge(width = 0.1)) +
  geom_point(aes(colour=Treatment), size = 2, position = position_dodge(width = 0.1)) +
  geom_line(aes(colour=Treatment, group=Treatment), position = position_dodge(width = 0.2), alpha=0.4) + # colour, group both depend on cond2
  scale_colour_manual(values=cols) +
  #annotate("text", x=43, y=1.85, label = "a", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=132, y=2.15, label = "b", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(43,43), y=c(2.45,2.2), label = "ab", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(141,141), y=c(3.15,3.4), label = "c", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=35, y=0.5, label = ".", size = 1) + #add text to the graphic for posthoc letters
  xlab("Timepoint") +
  ylab(expression(paste("Color Score"))) +
  ylim(-110,20)+
  theme_bw() + #Set the background color
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3), #Set the text angle
        axis.line = element_line(color = 'black'), #Set the axes color
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        plot.background=element_blank(),  #Set the plot background
        legend.position='none') + #remove legend background
  ggtitle("A) M. capitata") +
  theme(plot.title = element_text(face = 'bold.italic', 
                                  size = 14, 
                                  hjust = 0)) +
  geom_vline(xintercept = c(8.45), colour="black", linetype="dotted")

Fig.MC

```

Calculating P. acuta means and plotting bleaching score
```{r}
Fig.PA <- ggplot(Pact.Blch, aes(x=Timepoint, y=mean, group=Treatment)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=.1, position = position_dodge(width = 0.1)) +
  geom_point(aes(colour=Treatment), size = 2, position = position_dodge(width = 0.1)) +
  geom_line(aes(colour=Treatment, group=Treatment), position = position_dodge(width = 0.2), alpha=0.4) + # colour, group both depend on cond2
  scale_colour_manual(values=cols) +
  #annotate("text", x=43, y=1.85, label = "a", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=132, y=2.15, label = "b", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(43,43), y=c(2.45,2.2), label = "ab", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=c(141,141), y=c(3.15,3.4), label = "c", size = 3) + #add text to the graphic for posthoc letters
  #annotate("text", x=35, y=0.5, label = ".", size = 1) + #add text to the graphic for posthoc letters
  xlab("Timepoint") +
  ylab(expression(paste("Color Score"))) +
  ylim(-110,20)+
  theme_bw() + #Set the background color
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), #Set the text angle
        axis.line = element_line(color = 'black'), #Set the axes color
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        plot.background=element_blank()) +  #Set the plot background
       # legend.position='none') + #remove legend background
  ggtitle("B) P. acuta") +
  theme(plot.title = element_text(face = 'bold.italic', 
                                  size = 14, 
                                  hjust = 0)) + 
  geom_vline(xintercept = c(8.45), colour="black", linetype="dotted") 

Fig.PA


Colorscr <- ggarrange(Fig.MC, Fig.PA,ncol = 2, nrow = 1)
ggsave("Output/All.Color.Score.pdf", Colorscr, width=10, height=4)

Colorscr <- ggarrange(Fig.MC, Fig.PA,ncol = 2, nrow = 1)
ggsave("Output/All.Color.Score.png", Colorscr, width=10, height=4)
```

