---
title: "Chlorophyll_a-c"
author: "EL Strand"
date: "7/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("plotrix")) install.packages("plotrix")
if (!require("dplyr")) install.packages("dplyr")
if (!require("plyr")) install.packages("plyr")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("ggplot2")) install.packages("ggplot2")

# load packages
library(tidyverse)
library(plotrix)
library(dplyr)
library(plyr)
library(Rmisc)
library(ggplot2)
```

Reading in datafiles and merging into one large dataframe. 
```{r}
# List chlorophyll data files
chl_path <- "Physiology_variables/Chlorophyll-a_c/"                      # Path to chlorophyll data directory
all_chl_files <- list.files(path = chl_path, pattern = "*.csv")          # List all files in directory
chl_platemaps <- list.files(path = chl_path, pattern = "platemap")       # List platemap files
chl_data_files <- setdiff(all_chl_files, chl_platemaps)                  # List absorbance data files

# Read in all files into tibble
df <- tibble(file = chl_data_files) %>%
  mutate(platemap = map(file, ~ read_csv(paste0(chl_path, tools::file_path_sans_ext(.), "_platemap.csv"))),
         chl_data = map(file, ~ read_csv(paste0(chl_path, .))))

# Merge platemap and data for each plate
df <- df %>%
  mutate(merged = map2(platemap, chl_data, ~ right_join(.x, .y))) %>%
  unnest(merged)

Chl_raw_data <- df[,c(1,4:8)]
Chl_raw_data <- gather(Chl_raw_data, "Wavelength", "Absorbance", 4:6) %>% filter(!is.na(colony_id))
  
index <- c("20200717_plate1.csv", "20200723_plate2.csv", "20200723_plate3.csv")
plate_numbers <- c("1", "2", "3")
Chl_raw_data$Plate.Number <- plate_numbers[match(Chl_raw_data$file, index)]

Chl_raw_data$Wavelength <- gsub("Chl:","", Chl_raw_data$Wavelength) 
Chl_raw_data <- select(Chl_raw_data, -file, -Well)
```

Calculating Chlorophyll a and c values. 
```{r}
# average all technical replicates for each plate/sample/wavelength, including all acetone blanks together 
Chl_means <- summarySE(Chl_raw_data, measurevar="Absorbance", groupvars=c("Plate.Number", "colony_id", "Wavelength")) %>%
  select(colony_id, Wavelength, Absorbance) %>% spread(Wavelength, Absorbance)

# get the acetone blank 750 absorbace, and subtract from 630 and 663 values for each sample  
# and accounting for path length (0.584 cm) from Warren 2007
Chl_means <- Chl_means %>%
  mutate(blank750 = `Chl.750`[colony_id == "BK"]) %>%
  mutate(adj630 = (`Chl.630` - blank750)/0.584,
         adj663 = (`Chl.663` - blank750)/0.584)

# calculate chla and chlc2 values based on equations from Jeffrey and Humphrey 1975; units Âµg/ml
Chl_means <- Chl_means %>%
  mutate(chla.ug.ml = 11.43 * adj663 - 0.64 * adj630,
         chlc2.ug.ml = 27.09 * adj630 - 3.63 * adj663)

Chl_means
```

Standardize to surface area and homogenate volume. 
```{r}
# Load homogenate volume
homog.vol <- read_csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(colony_id = Sample_ID)
  select(colony_id, surface.area.cm2)
chl <- full_join(df, homog.vol)

# Load surface area
sa <- read_csv("Physiology_variables/Physiology_Master.csv") %>% dplyr::rename(colony_id = Plug_ID) %>%
  select(colony_id, Homogenate_Vol_mL)
chl <- full_join(chl, sa)

# Multiply chlorophyll by the homogenate volume and divide by surface area
chl <- chl %>%
  mutate(chla.ug.cm2 = chla.ug.ml * homog_vol_ml / surface.area.cm2,
         chlc2.ug.cm2 = chlc2.ug.ml * homog_vol_ml / surface.area.cm2)

# remove blanks and NAs
chl <- filter(chl, !colony_id %in% c("NA", "BK"))

# write chlorophyll data to file
chl %>%
  select(colony_id, chla.ug.cm2, chlc2.ug.cm2) %>%
  write_csv(path = "Output/chlorophyll.csv")
```

Standardize to surface area and homogenate volume. 
```{r}
# Load surface area and homogenate volume values; merge dataframes from chla, chlc means 
Surface_area <- read.csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(colony_id = Sample_ID) %>%
  select(colony_id, surface.area.cm2)
Homogenate_volume <- read.csv("Physiology_variables/Physiology_Master.csv") %>% dplyr::rename(colony_id = Plug_ID) %>%
  select(colony_id, Homogenate_Vol_mL)

Chl_standardized <- join_all(list(Chl_means, Surface_area, Homogenate_volume), by='colony_id', type='left') %>%
  select(colony_id, surface.area.cm2, Homogenate_Vol_mL, chla.ug.ml, chlc2.ug.ml)

# Multiply chlorophyll by the homogenate volume and divide by surface area
Chl_standardized <- Chl_standardized %>%
  mutate(chla.ug.cm2 = chla.ug.ml * Homogenate_Vol_mL / surface.area.cm2,
         chlc2.ug.cm2 = chlc2.ug.ml * Homogenate_Vol_mL / surface.area.cm2) 
  
# remove blanks and NAs
Chl_standardized <- filter(Chl_standardized, !colony_id %in% c("NA", "BK"))

# write chlorophyll data to file
Chl_standardized %>% 
  select(colony_id, chla.ug.cm2, chlc2.ug.cm2) %>% 
  write_csv(path = "Output/chlorophyll.csv")
```

Reading in master fragment information. 
```{r}
Master_fragment <- read.csv("Environmental_data/Master_Fragment_20200616_QC.csv") %>% dplyr::rename(colony_id = PLUG.ID)
Master_fragment$colony_id <- as.character(Master_fragment$colony_id)
Chl <- read.csv("Physiology_variables/Chlorophyll-a_c/chlorophyll.csv") 
Chl$colony_id <- as.character(Chl$colony_id)

Chl_final <- full_join(Master_fragment, Chl, by="colony_id") %>% select(colony_id, Species, TREATMENT, Sample.Date, chla.ug.cm2, chlc2.ug.cm2) %>%
  filter(!is.na(chla.ug.cm2))
```

Reading in bleaching test information. 
```{r}
Phys_testing <- read.csv("Physiology_variables/phys_testing.csv")
Phys_testing$colony_id <- as.character(Phys_testing$colony_id)
Chl_final <- full_join(Chl_final, Phys_testing, by="colony_id")

Chl_final <- gather(Chl_final, "Measurement", "Value", 5:6) # changing columns to rows to allow for easier facet_grid in graphing section
```

Graphing bleaching test data.
```{r}
ggplot(Chl_final, aes(x=status, y=Value, fill=status)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "none") + 
  facet_grid(Measurement ~ Species, scales = "free")
```

```{r}
cols <- c("lightblue", "blue", "salmon", "red3")

ggplot(Chl_final, aes(x=TREATMENT, y=Value, fill=TREATMENT)) + geom_boxplot() +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  scale_fill_manual(values=cols) +
  theme(legend.position = "none") + 
  facet_grid(Measurement ~ Species, scales = "free")
```

```{r}
ggplot(Chl_final, aes(x=bleaching_score, y=Value, color=Measurement)) + geom_point() + 
  xlab("Bleaching Score") + theme_bw() + 
  facet_grid(Measurement ~ Species, scales = "free") + 
  theme(legend.position = "none")
```
 
 
 