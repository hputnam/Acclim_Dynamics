---
title: "Chlorophyll_a-c"
author: "EL Strand"
date: "7/17/2020"
output: html_document
---

Clears workspace. 
```{r}
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("plotrix")) install.packages("plotrix")
if (!require("dplyr")) install.packages("dplyr")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("formattable")) install.packages("formattable")
if (!require("data.table")) install.packages("data.table")
if (!require("htmltools")) install.packages("htmltools")
if (!require("webshot")) install.packages("webshot")

# load packages
library(tidyverse)
library(plotrix)
library(dplyr)
library(Rmisc)
library(ggplot2)
library(gridExtra)
library(formattable)
library(data.table)
library(htmltools)
library(webshot)
```


Reading in datafiles and merging into one large dataframe. 
```{r}
df.platemaps <-
  list.files(path = 'Physiology_variables/Chlorophyll-a_c',pattern = "platemap.csv", full.names = TRUE) %>% 
  # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.csv, .id = "file.ID") %>% # join all files together in one data frame by file ID
 group_by(file.ID) 

df.platemaps$file.ID <- gsub("Physiology_variables/Chlorophyll-a_c/", "", df.platemaps$file.ID)
df.platemaps$file.ID <- gsub("_platemap.csv", "", df.platemaps$file.ID)

df.data <-
  list.files(path = 'Physiology_variables/Chlorophyll-a_c',pattern = "data.csv", full.names = TRUE) %>% 
  # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.csv, .id = "file.ID") %>% # join all files together in one data frame by file ID
 group_by(file.ID)

df.data$file.ID <- gsub("Physiology_variables/Chlorophyll-a_c/", "", df.data$file.ID)
df.data$file.ID <- gsub("_data.csv", "", df.data$file.ID)


# Merge platemap and data for each plate
df <- left_join(df.data,df.platemaps)
str(df)
```

# Calculate chlorophyll concentrations
```{r}
# average all technical replicates for each the sample duplicates per plate
df <- df %>%
  filter(!is.na(Plug_ID)) #remove empty wells (colony_id is NA)
  
df.1 <- df %>%
  dplyr::group_by(file.ID, Plug_ID) %>% #group by day and sample
  dplyr::summarise(mean_A630 = mean(X630), #calculate means
                   mean_A663 = mean(X663),
                   mean_A750 = mean(X750))
  

# get the acetone blank 750 absorbace for each file (i.e., plate), and subtract from 630 and 663 values for each sample
df.1 <- df.1 %>%
  dplyr::mutate(adj630 = mean_A630 - mean_A750,
         adj663 = mean_A663 - mean_A750)

# calculate chla and chlc2 values based on equations from Jeffrey and Humphrey 1975
# units Âµg/ml
df.1 <- df.1 %>%
  dplyr::mutate(chla.ug.ml = (11.43 * adj663) - (0.64 * adj630),
        chlc2.ug.ml = (27.09 * adj630) - (3.63 * adj663))

# path length adjustments for chlorophyll in 96 well quartz plate (0.584 cm)
df.1 <- df.1 %>%
  dplyr::mutate(chla.ug.ml = chla.ug.ml*0.584,
        chlc2.ug.ml = chlc2.ug.ml*0.584)
```


Standardize to surface area and homogenate volume. 
```{r}
# Load homogenate volume
# Load surface area
sa <- read_csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>%
  select(Plug_ID, surface.area.cm2)
sa$Plug_ID <- as.factor(sa$Plug_ID)
str(sa)

df.chl <- left_join(sa, df.1)

# Load homogenate volume
homog.vol <- read.csv("Physiology_variables/homogenate_vol.csv") %>%
  select(Plug_ID, vol_mL)
homog.vol$Plug_ID <- as.factor(homog.vol$Plug_ID)
str(homog.vol)

df.chl <- left_join(df.chl, homog.vol)

# Account for homogenate volume and normalize to surface area
df.chl <- df.chl %>%
  mutate(chla.ug.cm2 = (chla.ug.ml * vol_mL) / surface.area.cm2,
         chlc2.ug.cm2 = (chlc2.ug.ml * vol_mL) / surface.area.cm2)

# remove blanks and NAs
df.chl <- filter(df.chl, !Plug_ID %in% c("NA", "BK"))
```

Reading in master fragment information. Taking out P-1488 (See notes in results markdown). 
```{r}
Master_fragment <- read.csv("Environmental_data/Master_Fragment.csv", header=T, sep=",", na.string="NA") %>% 
  subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular") %>% # need to keep "Physiology" and "Physiology/Molecular"
  select(Plug_ID, Species, Treatment, Temperature, CO2, Timepoint) 
  Master_fragment$Plug_ID <- as.character(Master_fragment$Plug_ID)
str(df.chl)

Chl_final <- left_join(df.chl, Master_fragment, by="Plug_ID") %>% na.omit(Species)
Chl_final$Timepoint <- factor(Chl_final$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))

# taking out sample 1488 
Chl_final <- Chl_final %>% filter(!Plug_ID == "1488")
filter(Chl_final, Plug_ID == "1488") # checking to see that worked; output should be 0

Chl_final %>%
  select(Plug_ID, Species, Timepoint, Temperature, Treatment, CO2, chla.ug.cm2, chlc2.ug.cm2) %>%
  write_csv(path = "Output/chlorophyll.csv")
```


Quality control. 
```{r}
range(Chl_final$chla.ug.ml)
range(Chl_final$chlc2.ug.cm2)

dplyr::filter(Chl_final, chlc2.ug.cm2 > 1.5) # high values for chl c2; think about re-doing?
dplyr::filter(Chl_final, chla.ug.cm2 < 0) # output should be zero since negative values are not possible. 
dplyr::filter(Chl_final, chlc2.ug.cm2 < 0) # output should be zero since negative values are not possible. 

Chl.duplicates <- Chl_final %>% dplyr::group_by(Plug_ID) %>% 
  dplyr::summarise(n = n()) %>% filter(n > 1)
Chl.duplicates
# output should be zero bc NA and blanks taken out 

### Checking that all master plug IDs match CHl Plug IDs
Master_PlugID <- Master_fragment %>% select(Plug_ID)
Chl_IDs <- Chl_final %>% select(Plug_ID)

# rows that appear in the Chl_IDs spreadsheet but not in the master 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a Chl_IDs spreadsheet data point but were not in master ; output should be zero
# any output is likely the plug ID written incorrectly during sample processing
Chl_mismatched <- setdiff(Chl_IDs, Master_PlugID) 
Chl_mismatched # 20201202 output is 0

# rows that appear in the master spreadsheet but not in the Chl_IDs 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a master spreadsheet data point but were not in Chl_IDs ; output should be zero
Chl2_mismatched2 <- setdiff(Master_PlugID, Chl_IDs) 
Chl2_mismatched2

# Missing list (16): "1603", "1739", "2008", "2200", "2512", "2522", "2523", "2528", "2740", "2752", "2859", "2880", "2976", "2981", "2984", "3003"
# Corals we won't have Chl_IDs for: 1488
```


Visually checking for effect of plate. 
Only on Chl.c2
```{r}
## Chl c plotting
chlplotting <- Chl_final %>% na.omit()

ggplot(chlplotting, aes(x=file.ID, y=chlc2.ug.cm2, fill=Treatment)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "right") + 
  facet_wrap(~Species, scales = "free_y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(chlplotting, aes(x=file.ID, y=chlc2.ug.cm2, fill=Species)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "right") + 
  facet_wrap(~Treatment, scales = "free_y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



Calculating mean values for each timepoint and treatment group.
```{r}
## first two tables are not correct 
#mean.chl.a <- Chl_final %>%
 # dplyr::group_by(Species, Timepoint, Temperature, CO2, Treatment) %>%
 # dplyr::summarise(mean= mean(chla.ug.cm2), #mean 
       #            N = sum(chla.ug.cm2), # sample size
          #         se = sd(chla.ug.cm2)/sqrt(N)) #SE

#mean.chl.c <- Chl_final %>%
  #dplyr::group_by(Species, Timepoint, Temperature, CO2, Treatment) %>%
#  dplyr::summarise(mean= mean(chlc2.ug.cm2), #mean 
#                   N = sum(chlc2.ug.cm2), # sample size
   #                se = sd(chlc2.ug.cm2)/sqrt(N)) #SE
#mean.chl.c
#### the above tables aren't calculating this correctly ; sample sizes are off. come back to this. I prefer the below summarySE function instead 

## use the following 
Chl_long <- Chl_final %>% select(Plug_ID, surface.area.cm2, vol_mL, chla.ug.cm2, chlc2.ug.cm2, Species, Treatment, Temperature, CO2, Timepoint) %>%
  gather("Measurement", "Value", 4:5)
Chl_means <- summarySE(Chl_long, measurevar="Value", groupvars=c("Timepoint", "Treatment", "Temperature", "CO2", "Species", "Measurement")) %>% filter(N>2) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  )) %>%
  mutate(Measurement = case_when(
    Measurement == "chla.ug.cm2" ~ "Chlorophyll-a",
    Measurement == "chlc2.ug.cm2" ~ "Chlorophyll-c2"
  )) 

Chlc2_means <- summarySE(Chl_final, measurevar="chlc2.ug.cm2", groupvars=c("Timepoint", "Treatment", "Temperature", "CO2", "Species"))
Chlc2_means
Chla_means <- summarySE(Chl_final, measurevar="chla.ug.cm2", groupvars=c("Timepoint", "Treatment", "Temperature", "CO2", "Species"))
Chla_means

Chl_means$Timepoint <- factor(Chl_means$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))
Chlc2_means$Timepoint <- factor(Chlc2_means$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))
Chla_means$Timepoint <- factor(Chla_means$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))

# Looking at sample sizes 
dplyr::filter(Chlc2_means, N > 6) # this output should be zero b/c the biggest sample size is 6
dplyr::filter(Chlc2_means, N < 6) 

dplyr::filter(Chla_means, N > 6) # this output should be zero b/c the biggest sample size is 6
dplyr::filter(Chla_means, N < 6) # this should be the exact same as above, just double checking
```

Write means and sample sizes for AFDW to file
```{r}
improvement_formatter <- formatter("span", style = x ~ style(font.weight = "bold", 
              color = ifelse(x > 5, "black", ifelse(x < 6, "red", "black"))))

Chl_ss <- arrange(Chl_means, N, Timepoint) %>% 
  write_csv(path = "Output/Chl_means_samplesizes.csv")
Chl_ss

Chl.samples.sizes <- formattable(Chl_ss, align =c("l","c","c","c","c", "c", "c", "c", "r"), 
            list(`Indicator Name` = formatter("span", style = ~ style(color = "grey",font.weight = "bold")), `N` = improvement_formatter)) 
Chl.samples.sizes

# I was having trouble with the below command and exporting correcty; function will run but not sure where the png is saving
# export command for formattable
export_formattable <- function(f, file, width = "100%", height = NULL, 
                               background = "white", delay = 0.2)
    {
      w <- as.htmlwidget(f, width = width, height = height)
      path <- html_print(w, background = background, viewer = NULL)
      url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
      webshot(url,
              file = file,
              selector = ".formattable_widget",
              delay = delay)
}

export_formattable(Chl.samples.sizes, file = "Output/Chl_means_samplesizes.png")
```

Plotting timeseries with corrected means table. 

```{r}
cols <- c("lightblue", "blue", "pink", "red")

CHL <- ggplot(Chl_means, aes(x=Timepoint, y = Value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=Value-se, ymax=Value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Concentration" ~(ug ~cm^-2))) +
  #ggtitle("Chlorophyll a and c2 concentration") +
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); CHL


ggsave(file="Output/Final_Figures/Chlorophyll.pdf", CHL, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Chlorophyll.png", CHL, width = 11, height = 6, units = c("in"))
```

############## Bleaching Fragment Test prior to running the rest of the samples.

This was a test batch of 12 samples to make sure we would get a signal from both healthy and bleached samples. 

Reading in bleaching test information. 
```{r}
Phys_testing <- read.csv("Physiology_variables/phys_testing.csv")
Phys_testing$Plug_ID <- as.character(Phys_testing$Plug_ID)

Chl_testing <- full_join(Chl_final, Phys_testing, by="Plug_ID") %>% filter(!is.na(status))

Chl_testing <- gather(Chl_testing, "Measurement", "Value", 9:10) # changing columns to rows to allow for easier facet_grid in graphing section
```

Graphing bleach test data. 
```{r}
Bleached1.chl <- ggplot(Chl_testing, aes(x=status, y=Value, fill=status)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "left") + 
  facet_grid(Measurement ~ Species, scales = "free")
Bleached1.chl

Bleached2.chl <- ggplot(Chl_testing, aes(x=bleaching_score, y=Value, color=status)) + geom_point() + 
  xlab("Bleaching Score") + theme_bw() + 
  facet_grid(Measurement ~ Species, scales = "free") + 
  theme(legend.position = "left")
Bleached2.chl

Chl.Blch.Figs <- arrangeGrob(Bleached1.chl, Bleached2.chl, ncol=2)

ggsave(file="Output/Phystest_Chl.pdf", Chl.Blch.Figs, width = 15, height = 10, units = c("in"))
```




