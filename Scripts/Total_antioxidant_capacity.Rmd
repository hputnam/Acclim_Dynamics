---
title: "Total_antioxidant_capacity"
author: "EL Strand"
date: "8/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

Load in required libraries. 
```{r}
## install packages if you dont already have them
if (!require("dplyr")) install.packages("dplyr")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("broom")) install.packages("broom")

# load packages
library(dplyr)
library(ggplot2)
library(tidyverse)
library(broom)
```

Based on Total Antioxidant Capacity kit found in protocols folder. 

Reading in datafiles. 
```{r}
## Bleaching Test Plate 2
plate2_TAC_platemap <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20200806_Plate2_TAC_platemap.csv") 
  plate2_TAC_platemap$Plug_ID <- as.character(plate2_TAC_platemap$Plug_ID)
plate2_TAC_final <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20200806_plate2_final.csv", header=T) %>% dplyr::rename(Abs_final = X490.490)
plate2_TAC_initial <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20200806_plate2_initial.csv", header=T) %>% dplyr::rename(Abs_initial = X490.490)

plate2_TAC <- full_join(plate2_TAC_platemap, plate2_TAC_initial, by="Well") %>%
  full_join(plate2_TAC_final) %>%
  filter(!is.na(Plug_ID))

TAC_standards1 <- plate2_TAC %>% filter(grepl("Standard", Plug_ID)) %>% dplyr::rename(Standard = Plug_ID) # new dataframe (standards) with the standard values and renaming that column

## 20201007 
# Plate 1
Oct7plate1_platemap <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_Plate1_TAC_platemap.csv") 
  Oct7plate1_platemap$Plug_ID <- as.character(Oct7plate1_platemap$Plug_ID)
  Oct7plate1_platemap$plate.number <- rep(1,nrow(Oct7plate1_platemap))
Oct7_plate1_final <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate1_final.csv", header=T) %>% dplyr::rename(Abs_final = X490.490)
Oct7_plate1_initial <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate1_initial.csv", header=T) %>% dplyr::rename(Abs_initial = X490.490)

Oct7_plate1 <- full_join(Oct7plate1_platemap, Oct7_plate1_initial, by="Well") %>%
  full_join(Oct7_plate1_final) %>%
  filter(!is.na(Plug_ID))

# Plate 2
Oct7plate2_platemap <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_Plate2_TAC_platemap.csv") 
  Oct7plate2_platemap$Plug_ID <- as.character(Oct7plate2_platemap$Plug_ID)
  Oct7plate2_platemap$plate.number <- rep(2,nrow(Oct7plate2_platemap))
Oct7_plate2_final <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate2_final.csv", header=T) %>% dplyr::rename(Abs_final = X490.490)
Oct7_plate2_initial <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate2_initial.csv", header=T) %>% dplyr::rename(Abs_initial = X490.490)

Oct7_plate2 <- full_join(Oct7plate2_platemap, Oct7_plate2_initial, by="Well") %>%
  full_join(Oct7_plate2_final) %>%
  filter(!is.na(Plug_ID))

# Plate 3
Oct7plate3_platemap <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_Plate3_TAC_platemap.csv") 
  Oct7plate3_platemap$Plug_ID <- as.character(Oct7plate3_platemap$Plug_ID)
  Oct7plate3_platemap$plate.number <- rep(3,nrow(Oct7plate3_platemap))
Oct7_plate3_final <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate3_final.csv", header=T) %>% dplyr::rename(Abs_final = X490.490)
Oct7_plate3_initial <- read.csv("Physiology_variables/Total_Antioxidant_Capacity/20201007_plate3_initial.csv", header=T) %>% dplyr::rename(Abs_initial = X490.490)

Oct7_plate3 <- full_join(Oct7plate3_platemap, Oct7_plate3_initial, by="Well") %>%
  full_join(Oct7_plate3_final) %>%
  filter(!is.na(Plug_ID))

Oct7 <- union(Oct7_plate1, Oct7_plate2) %>% union(Oct7_plate3)

# Oct 7 standards 
Oct7_st <- Oct7 %>% filter(grepl("Standard", Plug_ID)) %>% dplyr::rename(Standard = Plug_ID)
```

Plot standard curve. 
```{r}
st.name <- c("Standard1", "Standard2", "Standard3", "Standard4", "Standard5", "Standard6", "Standard7", "Standard8", "Standard9", "Standard10")
concentration <- c("1", "0.5", "0.25", "0.125", "0.0625", "0.03125", "0.01560", "0.00780", "0.00390", "0")

## Bleaching Test Plate 2
TAC_standards1 <- TAC_standards1 %>%
  mutate(Abs_net = Abs_final - Abs_initial) %>% 
  dplyr::group_by(Standard) %>%
  summarise(Abs_net = mean(Abs_net)) %>%
  mutate(Abs_net.adj = Abs_net - Abs_net[Standard == "Standard10"])

TAC_standards1$conc_mM <- concentration[match(TAC_standards1$Standard, st.name)]
  TAC_standards1$conc_mM <- as.numeric(TAC_standards1$conc_mM)

TAC_mod_lin1 <- lm(conc_mM ~ Abs_net.adj, data = TAC_standards1)
summary(TAC_mod_lin1)

std_curve_plot1 <- TAC_standards1 %>%
  ggplot(aes(x = conc_mM, y = Abs_net.adj)) +
  geom_point(color = "blue", size = 1.5) + 
  theme_bw() + 
  labs(title = paste("Adj R2 = ", signif(summary(TAC_mod_lin1)$adj.r.squared, 5),
                     "; TAC Standard Curve Bleaching Test")) + 
  geom_smooth(method = "lm")
std_curve_plot1

## 20201007
Oct7_st <- Oct7_st %>%
  mutate(Abs_net = Abs_final - Abs_initial) %>% 
  dplyr::group_by(Standard) %>%
  summarise(Abs_net = mean(Abs_net)) %>%
  mutate(Abs_net.adj = Abs_net - Abs_net[Standard == "Standard10"])

Oct7_st$conc_mM <- concentration[match(Oct7_st$Standard, st.name)]
  Oct7_st$conc_mM <- as.numeric(Oct7_st$conc_mM)

TAC_mod_lin2 <- lm(conc_mM ~ Abs_net.adj, data = Oct7_st)
summary(TAC_mod_lin2)

std_curve_plot2 <- Oct7_st %>%
  ggplot(aes(x = conc_mM, y = Abs_net.adj)) +
  geom_point(color = "blue", size = 1.5) + 
  theme_bw() + 
  labs(title = paste("Adj R2 = ", signif(summary(TAC_mod_lin2)$adj.r.squared, 5),
                     "; TAC Standard Curve Oct 7 Standards")) + 
  geom_smooth(method = "lm")
std_curve_plot2
```

Calculate Total Antioxidant Capacity based on the standard curve model from above.
“mM uric acid equivalents” (UAE) is the first calculation based on the fitted model. 
“μM Copper Reducing Equivalents” (CRE) is the second calculation which is the reported value and equivalent to Total Antioxidant Capacity or Power. This calculation is done by: 
1.) uric acid equivalence (UAE) concentration * 2189 μM Cu++/ mM uric acid = uM (umol/L) CRE
2.) umol/L CRE * Volume of the sample (this kit is 20 uL aka 2.0 x 10^-5 L) = CRE umol 
3.) Concentration of protein (mg/mL) * 1000mL = mg/L of protein
4.) umol CRE / mg/L protein = uM/mg CRE

```{r}
## Bleaching Test Plate 2 
Blch_TAC <- plate2_TAC %>% filter(!grepl("Standard", Plug_ID)) %>%
  mutate(Abs_net = Abs_final - Abs_initial) %>%
  dplyr::group_by(Plug_ID) %>%
  summarise(Abs_net = mean(Abs_net)) %>%
  mutate(Abs_net.adj = Abs_net - TAC_standards1$Abs_net[TAC_standards1$Standard == "Standard10"],
         uae.mM = map_dbl(Abs_net.adj, ~ predict(TAC_mod_lin1, newdata = data.frame(Abs_net.adj = .))))

std_curve_plot1 +
  geom_point(data = Blch_TAC, aes(x = Abs_net.adj, y = uae.mM), pch = "X", cex = 3, alpha = 0.3) +
    labs(title = "Bleaching Test Plate 2 samples projected on standard curve 1")

## October 7 Plates (3)
Oct7 <- Oct7 %>% filter(!grepl("Standard", Plug_ID)) %>%
  mutate(Abs_net = Abs_final - Abs_initial) %>%
  dplyr::group_by(Plug_ID) %>%
  summarise(Abs_net = mean(Abs_net)) %>%
  mutate(Abs_net.adj = Abs_net - Oct7_st$Abs_net[Oct7_st$Standard == "Standard10"],
         uae.mM = map_dbl(Abs_net.adj, ~ predict(TAC_mod_lin2, newdata = data.frame(Abs_net.adj = .))))
std_curve_plot2 +
  geom_point(data = Oct7, aes(x = Abs_net.adj, y = uae.mM), pch = "X", cex = 3, alpha = 0.3) +
    labs(title = "Oct 7 samples projected on standard curve 2")
```

Reading in to surface area, soluble protein, and homogenate volume. 
```{r}
sa <- read_csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>% select(Plug_ID, surface.area.cm2)
  sa$Plug_ID <- as.character(sa$Plug_ID)
Homogenate_volume <- read.csv("Physiology_variables/homogenate_vol.csv") %>% select(Plug_ID, vol_mL)
  Homogenate_volume$Plug_ID <- as.character(Homogenate_volume$Plug_ID)

Master_fragment <- read.csv("Environmental_data/Master_Fragment.csv", header=T, sep=",", na.string="NA") %>% select(Plug_ID, Species, Timepoint, Temperature, Treatment, CO2)
  Master_fragment$Plug_ID <- as.character(Master_fragment$Plug_ID)

prot <- read_csv("output/soluble_protein.csv") 
  prot$Plug_ID <- as.character(prot$Plug_ID)
prot <- prot %>% 
  mutate(prot_mg.mL = prot_ug.mL*1000) %>% # future TAC calculations need protein values in mg/mL
  select(Plug_ID, prot_mg.mL)

metadata <- full_join(sa, Homogenate_volume, by='Plug_ID', type='left') %>% 
  full_join(Master_fragment) %>%
  full_join(prot)
```

Steps 2-4 of calculation above based on extraction UAE values from standard curve. 
```{r}
# combine Blch TAC and Oct7 files to avoid repetition?
Test <- left_join(Blch_TAC, prot) %>% select(Plug_ID, uae.mM, prot_mg.mL) %>%
  mutate(CRE.umol.L = uae.mM*2189, # Step 1 of calculation described above
         CRE.umol = CRE.umol.L*0.00002, # Step 2
         prot.mg.L = prot_mg.mL*1000, # Step 3
         CRE.uM.mg = CRE.umol/prot.mg.L) # Step 4

Oct7 <- left_join(Oct7, prot) %>% select(Plug_ID, uae.mM, prot_mg.mL) %>%
  mutate(CRE.umol.L = uae.mM*2189, 
         CRE.umol = CRE.umol.L*0.00002, 
         prot.mg.L = prot_mg.mL*1000, 
         CRE.uM.mg = CRE.umol/prot.mg.L)
```

Combining TAC values for all plates and write TAC output file.
```{r}
TAC <- union(Test, Oct7) %>%
  write_csv(., path = "Output/antioxidant_capacity.csv")

TAC_final <- TAC %>% select(Plug_ID, CRE.uM.mg) 
TAC_final <- full_join(TAC_final, metadata)
```

Visualizing data across treatment and time. 
```{r}
```

Statistical analyses. 
```{r}
```

############# Bleaching Test Information prior to processing all of the samples ############# 

Reading in bleaching test info. 
```{r}
Phys_testing <- read.csv("Physiology_variables/phys_testing.csv")
  Phys_testing$Plug_ID <- as.character(Phys_testing$Plug_ID)
  
TAC_testing <- full_join(Blch_TAC, Phys_testing, by="Plug_ID")
```

Graphing bleaching test information.
```{r}
Bleached1 <- ggplot(TAC_testing, aes(x=status, y=CRE.umol.mgprot, fill=status)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "") + 
  facet_wrap(~Species)
Bleached1

Bleached2 <- ggplot(TAC_testing, aes(x=bleaching_score, y=CRE.umol.mgprot)) + geom_point() + 
  xlab("Bleaching Score") + theme_bw() + 
  facet_wrap(~Species) + 
  theme(legend.position = "")
Bleached2
```


