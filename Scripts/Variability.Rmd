---
title: "Variability"
author: "EL Strand"
date: "2/25/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace. 
```{r}
rm(list=ls()) 
```

Read in libraries. 
```{r}
library(ggplot2); library(gridExtra)
library(plyr)
library(dplyr)
library(stats)
library(tidyr)
library(vegan)
library(broom)
library(robustbase)
```


Read in dataframes. Run "Statistics.Rmd" script first to create the physiology results dataframe. 
```{r}
phys <- read.csv("Output/results_physiology.csv") %>% group_by(Species, Timepoint, Treatment) %>% 
  filter(n() >= 3) %>% ungroup()
color <- read.csv("Output/results_colorscore.csv")
growth <- read.csv("Output/results_growth.csv")

cols <- c("lightblue", "blue", "salmon", "red3")
```

Viewing distributions of variables. 
```{r}
hist(color$Bleaching.Score) #not normal; heavily negatively skewed
hist(phys$Pnet_umol.cm2.hr); hist(phys$Pgross_umol.cm2.hr); hist(phys$Rdark_umol.cm2.hr)
hist(phys$Host_AFDW.mg.cm2); hist(phys$Sym_AFDW.mg.cm2); hist(phys$Ratio_AFDW.mg.cm2)
hist(phys$chlc2.ug.cm2)
hist(phys$prot_mg.cm2); hist(phys$cre.umol.mgprot)
```

## Calculating Univariate MAD (Median Absolute Deviation).
1.4826 constant value is used for normal distributions -- come back to color score and growth for this one.  

```{r}
## Physiology 
phys.mad <- phys %>% select(-chla.ug.cm2) %>% unite(Big.Group, Group, Species, remove = FALSE, sep = " ") %>%
  subset(Big.Group != "Recovery HTAC Pacuta") %>% gather("Response", "Response.Value", 11:19) %>%
  group_by(Species, Treatment, Timepoint, Response) %>% 
  mutate(mad = mad(Response.Value, center = median(Response.Value), constant = 1.4826, na.rm = TRUE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Response.Value))*100)) %>% 
  #gather("Measurement", "Value", 13:14) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))
  
phys.mad$Timepoint <- factor(phys.mad$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week", "12 week", "16 week"))

## Color Score 
color.mad <- color %>% group_by(Species, Treatment, Blch.Time) %>%
  mutate(mad = mad(Bleaching.Score, center = median(Bleaching.Score), constant = 1.4826, na.rm = FALSE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Bleaching.Score))*100)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

color.mad$Timepoint <- factor(color.mad$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week5", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16"))

## Growth 
growth.mad <- growth %>% group_by(Species, Treatment, Growth.Time) %>%
  mutate(mad = mad(Growth.Rate, center = median(Growth.Rate), constant = 1.4826, na.rm = FALSE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Growth.Rate))*100)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

growth.mad$Timepoint <- factor(growth.mad$Timepoint, levels = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week10", "Week12", "Week14", "Week16"))
```

Plot CV 
```{r}
total.CV <- ggplot(phys.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Species ~ Response) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Total CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); total.CV

ggsave(file="Output/Final_Figures/CV-total.png", total.CV, width = 11, height = 10, units = c("in"))
```


Plot MAD
```{r}
## Resp 
resp.mad <- phys.mad %>% subset(Response == "Pnet_umol.cm2.hr" | Response == "Pgross_umol.cm2.hr" | Response == "Rdark_umol.cm2.hr") %>% na.omit()

Resp.MAD <- ggplot(resp.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Resp / Photo MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Resp.MAD

Resp.CV <- ggplot(resp.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Resp / Photo CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Resp.CV
  
Resp <- arrangeGrob(Resp.MAD, Resp.CV, ncol=1)
ggsave(file="Output/Final_Figures/MAD-Resp.png", Resp, width = 11, height = 12, units = c("in"))
```

```{r}
## Chl
chl.mad <- phys.mad %>% subset(Response == "chlc2.ug.cm2") %>% na.omit()

CHLMAD <- ggplot(chl.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Chlorophyll c2 MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); CHLMAD

CHL.CV <- ggplot(chl.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Chl CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); CHL.CV
  
Chl <- arrangeGrob(CHLMAD, CHL.CV, ncol=1)

ggsave(file="Output/Final_Figures/MAD-Chl.png", Chl, width = 11, height = 8, units = c("in"))
```
The missing values are because it can't calculate MAD with NAs in the group but removing the NAs removes the entire sample. Come back to this if we want to visualize this individually. 
```{r}
## TAC and Prot
Tac.prot.mad <- phys.mad %>% subset(Response == "cre.umol.mgprot" | Response == "prot_mg.cm2")

PROT.TAC.MAD <- ggplot(Tac.prot.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("TAC and Protein MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); PROT.TAC.MAD

PROT.TAC.CV <- ggplot(Tac.prot.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("TAC and Protein CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); PROT.TAC.CV

ProtTAC <- arrangeGrob(PROT.TAC.MAD, PROT.TAC.CV, ncol=1)

ggsave(file="Output/Final_Figures/MAD-Prot-TAC.png", ProtTAC, width = 11, height = 12, units = c("in"))
```

AFDW
```{r}
## AFDW 
AFDW.mad <- phys.mad %>% subset(Response == "Host_AFDW.mg.cm2" | Response == "Sym_AFDW.mg.cm2" | Response == "Ratio_AFDW.mg.cm2") %>% na.omit()

AFDW.MAD <- ggplot(AFDW.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Tissue Biomass MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); AFDW.MAD

AFDW.CV <- ggplot(AFDW.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation") + ggtitle("Tissue Biomass CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); AFDW.CV

AFDW <- arrangeGrob(AFDW.MAD, AFDW.CV, ncol=1)
ggsave(file="Output/Final_Figures/MAD-AFDW.png", AFDW, width = 11, height = 12, units = c("in"))
```

## Phys multivariate MAD and CV.  
Euclidean distances is chosen because we have continuous numerical values and we want to reflect absolute distances.  
- binary=FALSE: no to presence-absence standardization  
- diag=FALSE: no to computing diagonals  ## COME BACK TO THIS 
- upper=FALSE: no to returning only upper diagonal 
- na.rm=FASLE: no removing NA values (we've already done this in a previous step)

```{r}
multi.phys.mad <- phys %>% select(-chla.ug.cm2, -Group, -Rdark_umol.cm2.hr, -Pnet_umol.cm2.hr, -Pgross_umol.cm2.hr, -Phase) %>% unite(Group, Timepoint, Treatment, remove = FALSE, sep = " ")
multi.phys.mad <- multi.phys.mad[complete.cases(multi.phys.mad), ] #only taking complete cases 
multi.phys.mad$Timepoint <- factor(multi.phys.mad$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week", "12 week", "16 week"))

mcap.multi.phys <- multi.phys.mad %>% filter(Species=="Mcapitata") 
mcap.multi.phys.info <- mcap.multi.phys %>% select(1:9)
mcap.multi.phys.data <- mcap.multi.phys %>% select(c(10:15))

pact.multi.phys <- multi.phys.mad %>% filter(Species=="Pacuta") 
pact.multi.phys.data <- pact.multi.phys %>% select(c(10:15))

#Scale and center datasets
Mcap.data.scaled <- scale(mcap.multi.phys.data, center = T, scale = T) # scaled variables
Pact.data.scaled <- scale(mcap.multi.phys.data, center = T, scale = T) # scaled variables

#Distance matrix 
Mcap.dist <- vegdist(Mcap.data.scaled, method="euclidean", binary=FALSE, diag=FALSE, upper=FALSE, na.rm = FALSE)
Pact.dist <- vegdist(Pact.data.scaled, method="euclidean", binary=FALSE, diag=FALSE, upper=FALSE, na.rm = FALSE)
```

Multivariate homogenity of groups dispersons (variances):    
helpful link [here](https://rdrr.io/rforge/vegan/man/betadisper.html).

```{r}
##Mcap 
Mcap.disper <- betadisper(Mcap.dist, mcap.multi.phys.info$Group, type = c("median","centroid"), bias.adjust = FALSE)

boxplot(Mcap.disper, ylab = "Distance to centroid")

Mcap.disper$distances

Mcap.out <- as.data.frame(Mcap.disper$distances)
Mcap.out$Plug_ID <- mcap.multi.phys.info$Plug_ID

Mcap <- full_join(mcap.multi.phys.info, Mcap.out, by='Plug_ID') %>% dplyr::rename(Dist = "Mcap.disper$distances")

hist(Mcap$Dist)

##Pacuta
#Pact.disper <- betadisper(Pact.dist, pact.multi.phys$Group, type = c("median","centroid"), bias.adjust = FALSE)
```

Testing this on subsets 

M. capitata
```{r}
## Day 1 ATAC
oneday.ATAC <- mcap.multi.phys %>% subset(Group == "Day 1 ATAC") %>% select(c(10:15))
oneday.ATAC.scaled <- scale(oneday.ATAC, center = T, scale = T) # scaled variables

oneday <- mcap.multi.phys %>% subset(Timepoint == "Day 1") %>% select(c(10:15))
oneday.scaled <- scale(oneday, center = T, scale = T) # scaled variables; n = 8 

week6.ATAC <- mcap.multi.phys %>% subset(Group == "6 week HTHC") %>% select(c(10:15))
week6.ATAC.scaled <- scale(week6.ATAC, center = T, scale = T) # scaled variables
```



Calculating MAD the same as above but using the multivariate distance to the median. 
Mcap distance to the median is not normal distribution. Come back to this constant value 
```{r}
Mcap.mad <- Mcap %>% group_by(Treatment, Timepoint) %>% 
  mutate(mad = mad(Dist, center = median(Dist), constant = 1.4826, na.rm = TRUE, low = FALSE, high = FALSE)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

Mcap.Multi.MAD <- ggplot(Mcap.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Multivariate MAD score") + ggtitle("Multivariate Physiological MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); Mcap.Multi.MAD
```

CVm - CV equation is different than univariate so CVm is needed. 
1. Decide about scaled vs. not scaled. This is currently using scaled data 
2. Figure out to subset 
3. Take out groups less than/= 2?

```{r}
# scaled data and info together
Mcap.data.scaled.df <- as.data.frame(Mcap.data.scaled)
Mcap.data.scaled.df$Plug_ID <- Mcap$Plug_ID
Mcap.CVm <- full_join(Mcap, Mcap.data.scaled.df, by="Plug_ID")

## testing one subset # Day 1 Mcap ATAC n=4 
oneday.ATAC.scaled.matrix <- data.matrix(oneday.ATAC.scaled)
covMcd(oneday.ATAC.scaled.matrix) # Error in covMcd(oneday.ATAC.scaled.matrix) : n <= p -- you can't be serious!
## testing one timepoint together # Day 1 n=8
oneday.scaled.matrix <- data.matrix(oneday.scaled)
one.daycovMcd <- covMcd(oneday.scaled.matrix) # This worked --- the only difference here is the sample size....
summary(one.daycovMcd)
## testing one subset # Week 6 Mcap ATAC n=6
week6.ATAC.scaled.matrix <- data.matrix(week6.ATAC.scaled)
covMcd(week6.ATAC.scaled.matrix) # Error in covMcd(week6.ATAC.scaled.matrix) : n <= p -- you can't be serious!

## I think n = sample size; p = number of variables (6) so the number of observations has to be bigger than the number of variables 
## n=8 was the only one that worked... 


## the entire dataset 
covMcd(Mcap.data.scaled) # This worked 



# creating 34 dataframes based on 'Group' and then selecting the data columns in each of them
split.frames <- split(Mcap.CVm, Mcap.CVm$Group)
new_list <- lapply(split.frames, function(x) x %>% select(11:16)) 
matrix_list <- lapply(new_list, function(x) data.matrix(x))

new_list$`1 week ATAC` # example view of one of the dataframes
matrix_list$`1 week ATAC` # example view of the matrices ; we want a matrix here 
str(matrix_list$`1 week ATAC`)
str(Mcap.data.scaled)

onewk <- mcap.multi.phys %>% subset(Group == "6 week ATAC")





#### Richelle data ; stuck on subsetting her groups
mmc4 <- read.csv("mmc4.txt", sep="\t") %>% select(-protein)
mmc4 <- data.matrix(mmc4)
## use sample info to subset for e and then do covMcd and CVm equation
colnames(mmc4) <- samplex

sample.info <- data.frame(c(colnames(mmc4)))
sample.info$site <- sample.info$c.colnames.mmc4..
sample.info <- sample.info[-1,]
#sample <- substr(sample.info$c.colnames.mmc4..,3,3)
sample <- sub("\\..*", "", sample.info$c.colnames.mmc4..) # keep everything before the period 
samplex <- str_sub(sample.info$c.colnames.mmc4..,-6,-6)

#sample <- gsub("..*$", "", sample.info$c.colnames.mmc4..)
sample <- gsub("X([0-9]+)_.*", "\\1", sample.info$c.colnames.mmc4..)

sub(" xxx.*", "", x)

u <- covMcd(mmc4)

head(u$cov)

CVm <- sqrt((t(u$cov)*sum(u$cov))/((t(u$cov)*u$cov)^2))


boxplot(CVm)

covMcd(matrix_list$`1 week ATAC`) # this still doesn't work with just one matrix.. 

for(i in 1:length(matrix_list)){
  covMcd(i$Value)
}


phys.cov <- covMcd(Mcap.data.scaled)
summary(phys.cov)

phys.cov.scaled <- covMcd(mcap.multi.phys.data)
summary(phys.cov.scaled)

Multi.mad <- phys.cov$cov
MMad.T <- t(Multi.mad)
```

Trying multivariate with GE counts matrix. 
```{r}
library(data.table)
library(janitor)
counts <- read.csv("Mcap.mRNA.fa.salmon.allSamples.numreads.matrix", sep='\t')
transp.counts <- transpose(counts)

colnames(transp.counts) <- rownames(counts)
rownames(transp.counts) <- colnames(counts)
transp.counts <- slice(transp.counts, 2:133)

transp.counts.matrix <- as.matrix(transp.counts)
transp.counts.scaled <- scale(transp.counts.matrix, center = T, scale = T)
# stuck on Error in colMeans(x, na.rm = TRUE) : 'x' must be numeric
```


