---
title: "Variability"
author: "EL Strand"
date: "2/25/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace. 
```{r}
rm(list=ls()) 
```

Read in libraries. 
```{r}
library(ggplot2); library(gridExtra)
library(plyr)
library(dplyr)
library(stats)
library(tidyr)
library(vegan)
library(broom)
library(robustbase)
```


Read in dataframes. Run "Statistics.Rmd" script first to create the physiology results dataframe. 
```{r}
phys <- read.csv("Output/results_physiology.csv") 
color <- read.csv("Output/results_colorscore.csv")
growth <- read.csv("Output/results_growth.csv")

cols <- c("lightblue", "blue", "salmon", "red3")
```

Viewing distributions of variables. 
```{r}
hist(color$Bleaching.Score) #not normal; heavily negatively skewed
hist(phys$Pnet_umol.cm2.hr); hist(phys$Pgross_umol.cm2.hr); hist(phys$Rdark_umol.cm2.hr)
hist(phys$Host_AFDW.mg.cm2); hist(phys$Sym_AFDW.mg.cm2); hist(phys$Ratio_AFDW.mg.cm2)
hist(phys$chlc2.ug.cm2)
hist(phys$prot_mg.cm2); hist(phys$cre.umol.mgprot)
```

## Calculating Univariate MAD (Median Absolute Deviation).
1.4826 constant value is used for normal distributions -- come back to color score and growth for this one.  

```{r}
## Physiology 
phys.mad <- phys %>% select(-chla.ug.cm2) %>% unite(Big.Group, Group, Species, remove = FALSE, sep = " ") %>%
  subset(Big.Group != "Recovery HTAC Pacuta") %>% gather("Response", "Response.Value", 11:19) %>%
  group_by(Species, Treatment, Timepoint, Response) %>% 
  mutate(mad = mad(Response.Value, center = median(Response.Value), constant = 1.4826, na.rm = TRUE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Response.Value))*100)) %>% 
  #gather("Measurement", "Value", 13:14) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))
  
phys.mad$Timepoint <- factor(phys.mad$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week", "12 week", "16 week"))
ggplot(phys.mad, aes(x=Treatment, y=mad, color=Treatment)) + geom_boxplot() + facet_grid(Species ~ Response) + theme_bw()

## Color Score 
color.mad <- color %>% group_by(Species, Treatment, Blch.Time) %>%
  mutate(mad = mad(Bleaching.Score, center = median(Bleaching.Score), constant = 1.4826, na.rm = FALSE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Bleaching.Score))*100)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

color.mad$Timepoint <- factor(color.mad$Timepoint, levels = c("Week1", "Week2", "Week3", "Week4", "Week5", "Week6", "Week7", "Week8", "Week9", "Week10", "Week11", "Week12", "Week13", "Week14", "Week15", "Week16"))

## Growth 
growth.mad <- growth %>% group_by(Species, Treatment, Growth.Time) %>%
  mutate(mad = mad(Growth.Rate, center = median(Growth.Rate), constant = 1.4826, na.rm = FALSE, low = FALSE, high = FALSE)) %>%
  mutate(cv = ((mad/mean(Growth.Rate))*100)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

growth.mad$Timepoint <- factor(growth.mad$Timepoint, levels = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week10", "Week12", "Week14", "Week16"))
```

Plot CV 
```{r}
total.CV <- ggplot(phys.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Species ~ Response) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Total CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); total.CV

ggsave(file="Output/Final_Figures/CV-total.png", total.CV, width = 11, height = 10, units = c("in"))
```


Plot MAD
```{r}
## Resp 
resp.mad <- phys.mad %>% subset(Response == "Pnet_umol.cm2.hr" | Response == "Pgross_umol.cm2.hr" | Response == "Rdark_umol.cm2.hr") %>% na.omit()

Resp.MAD <- ggplot(resp.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Resp / Photo MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Resp.MAD

Resp.CV <- ggplot(resp.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Resp / Photo CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Resp.CV
  
Resp <- arrangeGrob(Resp.MAD, Resp.CV, ncol=1)
ggsave(file="Output/Final_Figures/MAD-Resp.png", Resp, width = 11, height = 12, units = c("in"))
```

```{r}
## Chl
chl.mad <- phys.mad %>% subset(Response == "chlc2.ug.cm2") %>% na.omit()

CHLMAD <- ggplot(chl.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Chlorophyll c2 MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); CHLMAD

CHL.CV <- ggplot(chl.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("Chl CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  #geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); CHL.CV
  
Chl <- arrangeGrob(CHLMAD, CHL.CV, ncol=1)

ggsave(file="Output/Final_Figures/MAD-Chl.png", Chl, width = 11, height = 8, units = c("in"))
```

```{r}
## TAC and Prot
Tac.prot.mad <- phys.mad %>% subset(Response == "cre.umol.mgprot" | Response == "prot_mg.cm2") %>% na.omit()

PROT.TAC.MAD <- ggplot(Tac.prot.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("TAC and Protein MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); PROT.TAC.MAD

PROT.TAC.CV <- ggplot(Tac.prot.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation (%)") + ggtitle("TAC and Protein CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); PROT.TAC.CV

ProtTAC <- arrangeGrob(PROT.TAC.MAD, PROT.TAC.CV, ncol=1)

ggsave(file="Output/Final_Figures/MAD-Prot-TAC.png", ProtTAC, width = 11, height = 12, units = c("in"))
```

AFDW
```{r}
## AFDW 
AFDW.mad <- phys.mad %>% subset(Response == "Host_AFDW.mg.cm2" | Response == "Sym_AFDW.mg.cm2" | Response == "Ratio_AFDW.mg.cm2") %>% na.omit()

AFDW.MAD <- ggplot(AFDW.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species, scales = "free") +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Median Absolute Deviation") + ggtitle("Tissue Biomass MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); AFDW.MAD

AFDW.CV <- ggplot(AFDW.mad, aes(x=Timepoint, y = cv, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Response ~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Coefficient of Variation") + ggtitle("Tissue Biomass CV") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); AFDW.CV

AFDW <- arrangeGrob(AFDW.MAD, AFDW.CV, ncol=1)
ggsave(file="Output/Final_Figures/MAD-AFDW.png", AFDW, width = 11, height = 12, units = c("in"))
```

## Phys multivariate MAD and CV.  
Euclidean distances is chosen because we have continuous numerical values and we want to reflect absolute distances.  
- binary=FALSE: no to presence-absence standardization  
- diag=FALSE: no to computing diagonals  ## COME BACK TO THIS 
- upper=FALSE: no to returning only upper diagonal 
- na.rm=FASLE: no removing NA values (we've already done this in a previous step)

```{r}
multi.phys.mad <- phys %>% select(-chla.ug.cm2, -Group, -Rdark_umol.cm2.hr, -Pnet_umol.cm2.hr, -Pgross_umol.cm2.hr, -Phase) %>% unite(Group, Timepoint, Treatment, remove = FALSE, sep = " ")
multi.phys.mad <- multi.phys.mad[complete.cases(multi.phys.mad), ] #only taking complete cases 
multi.phys.mad$Timepoint <- factor(multi.phys.mad$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week", "12 week", "16 week"))

mcap.multi.phys <- multi.phys.mad %>% filter(Species=="Mcapitata") 
mcap.multi.phys.info <- mcap.multi.phys %>% select(1:9)
mcap.multi.phys.data <- mcap.multi.phys %>% select(c(10:15))

pact.multi.phys <- multi.phys.mad %>% filter(Species=="Pacuta") 
pact.multi.phys.data <- pact.multi.phys %>% select(c(10:15))

#Scale and center datasets
Mcap.data.scaled <- scale(mcap.multi.phys.data, center = T, scale = T) # scaled variables
Pact.data.scaled <- scale(mcap.multi.phys.data, center = T, scale = T) # scaled variables

#Distance matrix 
Mcap.dist <- vegdist(Mcap.data.scaled, method="euclidean", binary=FALSE, diag=FALSE, upper=FALSE, na.rm = FALSE)
Pact.dist <- vegdist(Pact.data.scaled, method="euclidean", binary=FALSE, diag=FALSE, upper=FALSE, na.rm = FALSE)
```

Multivariate homogenity of groups dispersons (variances):    
helpful link [here](https://rdrr.io/rforge/vegan/man/betadisper.html).

```{r}
##Mcap 
Mcap.disper <- betadisper(Mcap.dist, mcap.multi.phys.info$Group, type = c("median","centroid"), bias.adjust = FALSE)

boxplot(Mcap.disper, ylab = "Distance to centroid")

Mcap.disper$distances

Mcap.out <- as.data.frame(Mcap.disper$distances)
Mcap.out$Plug_ID <- mcap.multi.phys.info$Plug_ID

Mcap <- full_join(mcap.multi.phys.info, Mcap.out, by='Plug_ID') %>% dplyr::rename(Dist = "Mcap.disper$distances")

hist(Mcap$Dist)

##Pacuta
Pact.disper <- betadisper(Pact.dist, pact.multi.phys$Group, type = c("median","centroid"), bias.adjust = FALSE)
```

Calculating MAD the same as above but using the multivariate distance to the median. 
Mcap distance to the median is not normal distribution. Come back to this constant value 
```{r}
Mcap.mad <- Mcap %>% group_by(Treatment, Timepoint) %>% 
  mutate(mad = mad(Dist, center = median(Dist), constant = 1.4826, na.rm = TRUE, low = FALSE, high = FALSE)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))

Mcap.Multi.MAD <- ggplot(Mcap.mad, aes(x=Timepoint, y = mad, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + ylab("Multivariate MAD score") + ggtitle("Multivariate Physiological MAD") +
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(colour = "black")); Mcap.Multi.MAD
```

CVm - CV equation is different than univariate so CVm is needed. 
1. Decide about scaled vs. not scaled. This is currently using scaled data 
2. Figure out to subset 
3. Take out groups less than/= 2?

```{r}
# scaled data and info together
Mcap.data.scaled.df <- as.data.frame(Mcap.data.scaled)
Mcap.data.scaled.df$Plug_ID <- Mcap$Plug_ID
Mcap.CVm <- full_join(Mcap, Mcap.data.scaled.df, by="Plug_ID")

# creating 36 dataframes based on 'Group' and then selecting the data columns in each of them
split.frames <- split(Mcap.CVm, Mcap.CVm$Group)
new_list <- lapply(split.frames, function(x) x%>% select(11:16))
subset_list <- lapply(new_list, function(x) Filter(function(y) nrow(y) >= 2, x))

for(i in 1:length(new_list)){
  covMcd(i)
}


phys.cov <- covMcd(Mcap.data.scaled)
summary(phys.cov)

phys.cov.scaled <- covMcd(mcap.multi.phys.data)
summary(phys.cov.scaled)

Multi.mad <- phys.cov$cov
MMad.T <- t(Multi.mad)
```



