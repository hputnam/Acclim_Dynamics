---
title: "ITS2 analysis"
author: "HM Putnam"
date: "2/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("lubridate")) install.packages("lubridate")
if (!require("vegan")) install.packages("vegan")
if (!require("ggfortify")) install.packages("ggfortify")

# load packages
library(tidyverse)
library(lubridate)
library(vegan)
library(ggfortify)

```

```{r}
#read in ITS2 profile counts data generated by SymPortal
data <- read.csv("ITS2_seq/R_Input/ITS2_Profiles.csv", sep=",", header=TRUE)
rownames(data) <-data$sample_name
otumat <- as.matrix(data[,-c(1)])
#otumat <- as.matrix(t(otumat))

#read in sample metadata
meta <- read.csv("ITS2_seq/R_Input/ITS2_ids.csv", sep=",", header=TRUE)
```

```{r}
#Pacuta
Pact <- merge(data, meta, by="sample_name")
Pact <- subset(Pact, Species == "Pacuta")
Pact_meta <- Pact[,15:20]
str(Pact_meta)
Pact_meta$SAMPLING.DATE <- as.factor(Pact_meta$SAMPLING.DATE)
rownames(Pact) <- Pact$sample_name
Pact <- as.matrix(Pact[,2:14])

Rel.Sym.Data <- Pact/rowSums(Pact) #calculate the Relative Abundance
N <- rowSums(Rel.Sym.Data) # calculate row sums of the relative abundnaces, should sum to 1
N #Display Row Sums, should all be 1

#Transform Relative Abundance Matrix using sqrt
Trans.Rel.Sym.Data <- sqrt(Rel.Sym.Data) #sqrt transform the matrix
Trans.Rel.Sym.Data #view data

##### PCA #####

sym.pca.res <- prcomp(Trans.Rel.Sym.Data, retx=TRUE) #principal components analysis on sym data
summary(sym.pca.res) #analysis summary

#use scree diagram to determine break in majority versus minority variation explaination components
screeplot(sym.pca.res, type="lines")

#plot the PCA
autoplot(sym.pca.res)
autoplot(sym.pca.res, data = Pact_meta, colour = 'TREATMENT', shape='SAMPLING.DATE')

```

```{r}
#Mcap
Mcap <- merge(data, meta, by="sample_name")
Mcap <- subset(Mcap, Species == "Mcapitata")
Mcap_meta <- Mcap[,15:20]
str(Mcap_meta)
Mcap_meta$SAMPLING.DATE <- as.factor(Mcap_meta$SAMPLING.DATE)
rownames(Mcap) <- Mcap$sample_name
Mcap <- as.matrix(Mcap[,2:14])

Rel.Sym.Data <- Mcap/rowSums(Mcap) #calculate the Relative Abundance
N <- rowSums(Rel.Sym.Data) # calculate row sums of the relative abundnaces, should sum to 1
N #Display Row Sums, should all be 1

#Transform Relative Abundance Matrix using sqrt
Trans.Rel.Sym.Data <- sqrt(Rel.Sym.Data) #sqrt transform the matrix
Trans.Rel.Sym.Data #view data

##### PCA #####

sym.pca.res <- prcomp(Trans.Rel.Sym.Data, retx=TRUE) #principal components analysis on sym data
summary(sym.pca.res) #analysis summary
plot(sym.pca.res)

#use scree diagram to determine break in majority versus minority variation explaination components
screeplot(sym.pca.res, type="lines")

#plot the PCA
autoplot(sym.pca.res)
autoplot(sym.pca.res, data = Mcap_meta, colour = 'TREATMENT', shape='SAMPLING.DATE')
```

```{r}
#All Data
Rel.data <- data/rowSums(data[,2:12])
Rel.data$sample_name <- rownames(Rel.data)
all.data <- merge(Rel.data, meta, by="sample_name")
all.data <- all.data[,-1]

Profile <- colnames(all.data[,1:12])
Profile 

df <- all.data %>%
  pivot_longer(cols = C1d.C42.2.C1.C3cg:D1.D4.D6.D1ab,
               names_to = c("Profile"),
               values_to="rel.abun")

df$TIME.POINT <- as.numeric(df$TIME.POINT)
df$group <- paste0(df$SAMPLING.DATE,sep="_",df$Rep)
str(df)

ggplot(data = df, mapping = aes(x = group, y = rel.abun, fill = Profile)) +
    geom_bar(position="fill", stat="identity") +
    facet_wrap(facets =  vars(Species, TREATMENT), ncol = 4)+
    ylab("Relative Abundance")+
    theme_classic()+
    theme(axis.text.x = element_text(size=rel(0.3),angle = 90))+
    guides(shape = guide_legend(override.aes = list(size = 0.2)))+
    guides(color = guide_legend(override.aes = list(size = 0.2)))+
    theme(legend.title = element_text(size = 6), 
               legend.text = element_text(size = 4))

ggsave("Output/Final_Figures/rel.abund.its2.pdf")
ggsave("Output/Final_Figures/rel.abund.its2.png")

```


```{r}
## PERMANOVA
#MCAP
Mcap <- all.data %>%
  filter(Species == "Mcapitata")

MC.mat <- Mcap[,1:12]
MC.info <- Mcap[,13:19]

MC.permanova <- adonis(MC.mat ~ TREATMENT*TIME.POINT, data=MC.info, method = "bray", permutations=999)
MC.permanova


Pact <- all.data %>%
  filter(Species == "Pacuta")

PA.mat <- Pact[,1:12]
PA.info <- Pact[,13:19]

PA.permanova <- adonis(PA.mat ~ TREATMENT*TIME.POINT, data=PA.info, method = "bray", permutations=999)
PA.permanova

```