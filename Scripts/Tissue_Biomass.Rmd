---
title: "Tissue_Biomass"
author: "EL Strand"
date: "7/18/2020"
output:
  html_document: default
  pdf_document: default
---
Clears workspace. 
```{r}
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("plotrix")) install.packages("plotrix")
if (!require("dplyr")) install.packages("dplyr")
if (!require("plyr")) install.packages("plyr")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("formattable")) install.packages("formattable")
if (!require("data.table")) install.packages("data.table")
if (!require("htmltools")) install.packages("htmltools")
if (!require("webshot")) install.packages("webshot")

# load packages
library(tidyverse)
library(plotrix)
library(dplyr)
library(plyr)
library(Rmisc)
library(gridExtra)
library(formattable)
library(data.table)
library(htmltools)
library(webshot)
library(agricolae)
```

Dry Weight - organic and inorganic compounds
Ash-Free Dry Weight - organic compounds 

## Read in Ash-Free Dry Weight raw data, surface area, homogenate volume, and master datasheets
```{r}
AFDW_raw <- read.csv("Physiology_variables/AFDW_data.csv") %>% filter(!is.na(Plug_ID))
AFDW_raw$Plug_ID <- as.character(AFDW_raw$Plug_ID)

# Load surface area and homogenate volume values; merge dataframes from chla, chlc means 
Surface_area <- read.csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>%
  select(Plug_ID, surface.area.cm2)
Homogenate_volume <- read.csv("Physiology_variables/homogenate_vol.csv") %>%
  select(Plug_ID, vol_mL)
Master_fragment <- read.csv("Environmental_data/Master_Fragment.csv") %>% subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular") %>% # need to keep "Physiology" and "Physiology/Molecular"
  select(Plug_ID, Species, Treatment, Temperature, CO2, Timepoint, Tank, Site.Name) 
  Master_fragment$Plug_ID <- as.character(Master_fragment$Plug_ID)

AFDW_raw_metadata <- join_all(list(AFDW_raw, Surface_area, Homogenate_volume, Master_fragment), by='Plug_ID', type='left')
AFDW_raw_metadata$Species <- as.character(AFDW_raw_metadata$Species)
AFDW_raw_metadata$Species[AFDW_raw_metadata$Species == "Mcapitata"] <- "Montipora capitata"
AFDW_raw_metadata$Species[AFDW_raw_metadata$Species == "Pacuta"] <- "Pocillopora acuta"
```

Checking to see if any samples from the master weren't done or any that were done aren't on the master. 
```{r}
Master_PlugID <- Master_fragment %>% select(Plug_ID)
AFDW_IDs <- AFDW_raw %>% select(Plug_ID)

# rows that appear in the AFDW spreadsheet but not in the master 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a AFDW spreadsheet data point but were not in master ; output should be zero
# any output is likely the plug ID written incorrectly during sample processing
AFDW_mismatched <- setdiff(AFDW_IDs, Master_PlugID) 
AFDW_mismatched

# rows that appear in the master spreadsheet but not in the AFDW 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a master spreadsheet data point but were not in AFDW ; output should be zero
AFDW_mismatched2 <- setdiff(Master_PlugID, AFDW_IDs) 
AFDW_mismatched2

# Missing list: "2008", "2512", "2522", "2523", "2752", "2880", "2976", "3003", "1603", "1739", "2200", "2528", "2740", "2859", "2981", "2984"
# Corals we won't have AFDW for: 1174, 1327, 1488 
```

### Calculate mass per mL
```{r}
#different volumes for sym (5ml - just spun down) and host (4ml)
sym <- 5
host <- 4
AFDW <- AFDW_raw_metadata %>%
  mutate(dry.pan.mass.g.ml = case_when(partner=="Host" ~ dry.pan.mass.g/sym, partner=="Sym" ~ dry.pan.mass.g/host),
         burnt.pan.mass.g.ml = case_when(partner=="Host" ~ burnt.pan.mass.g/sym, partner=="Sym" ~ burnt.pan.mass.g/host))
```

# Calculating Tissue Biomass (AFDW)
```{r}
# Calculating Dry Weight and Ash-Free Dry Weight; standardizing by homogenate volume and surface area
AFDW <- AFDW %>%
  mutate(dry.bioimass.g.ml = (dry.pan.mass.g.ml - burnt.pan.mass.g.ml),
         dry.bioimass.g = dry.pan.mass.g.ml * vol_mL,
         burnt.bioimass.g = burnt.pan.mass.g.ml * vol_mL,
         DW.mg.cm2 = ((dry.bioimass.g)*1000) / surface.area.cm2,
         AFDW.mg.cm2 = ((dry.bioimass.g-burnt.bioimass.g)*1000) / surface.area.cm2)

# Calculating AFDW biomass ratio 
AFDW.final <- AFDW %>% select(Plug_ID, partner, Species, Treatment, Tank, Site.Name, Temperature, CO2, Timepoint, AFDW.mg.cm2) %>%
  spread(partner, AFDW.mg.cm2) %>% mutate(Ratio_S.H=Sym/Host)

# Taking out 1116 because it was an outlier. 
filter(AFDW.final, Ratio_S.H>3)

# Calculating means 
AFDW.host.means <- summarySE(AFDW.final, measurevar = c("Host"), groupvars = c("Treatment", "Timepoint", "Species"))
AFDW.sym.means <- summarySE(AFDW.final, measurevar = c("Sym"), groupvars = c("Treatment", "Timepoint", "Species"))
AFDW.ratio.means <- summarySE(AFDW.final, measurevar = c("Ratio_H.S"), groupvars = c("Treatment", "Timepoint", "Species"))
```

Quality control.
```{r}
ggplot(AFDW, aes(x=partner, y=AFDW.mg.cm2)) + geom_boxplot()

dplyr::filter(AFDW, AFDW.mg.cm2 > 5) # unusually high values for AFDW; think about re-doing?
dplyr::filter(AFDW, AFDW.mg.cm2 < 0) # output should be zero since negative values are not possible. 

AFDW.duplicates <- AFDW.final %>% dplyr::group_by(Plug_ID) %>% 
  dplyr::summarise(n = n()) %>% filter(n > 4)
AFDW.duplicates # Output should be zero 
```

### Double checking sample sizes. 
```{r}
# Looking at sample sizes 
dplyr::filter(AFDW.host.means, N > 6) # this output should be zero b/c the biggest sample size is 6
#seven <- AFDW_long %>% subset(Timepoint=="4 week") %>% subset(Treatment=="ATHC") %>% subset(partner=="Host") %>% subset(Measurement=="AFDW.mg.cm2") %>% subset(Species=="Mcapitata")
#seven

dplyr::filter(AFDW.final, Plug_ID=="2863")
```

### Export datafile.
```{r}
# write AFDW data to file
AFDW.final %>%
  select(Plug_ID, Host, Sym, Ratio_S.H) %>%
  write_csv(path = "Output/Tissue_Biomass.csv")

P.AFDW.final <- AFDW.final %>% subset(Species == "Pocillopora acuta")
M.AFDW.final <- AFDW.final %>% subset(Species == "Montipora capitata")
```

# Statistics 

## Raw data distribution view.
```{r}
hist(pacuta_full_data$Host) # normal
hist(pacuta_full_data$Sym) # right/positively skewed 
hist(pacuta_full_data$Ratio_S.H) # extremely right/positively skewed

hist(mcap_full_data$Host) # right/positively skewed
hist(mcap_full_data$Sym) # right/positively skewed
hist(mcap_full_data$Ratio_S.H) # normal 
```

## Model selection P.acuta

#### Host AFDW = Model with just tank

```{r}
#### P acuta -- this needs to be done with Pacuta_stress_data b/c recovery timepoints are small or not existent.
## Host 
Pacuta_Host_LMER <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=P.AFDW.final) 
Pacuta_Host_LMER.reef <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=P.AFDW.final)
model.sel(Pacuta_Host_LMER, Pacuta_Host_LMER.reef) # model selection function 
## Model with tank AIC = 420.7; with tank and reef AIC = 421.2 
## Just tank chosen

## summary of the model chosen from above
summary(Pacuta_Host_LMER)
qqPlot(residuals(Pacuta_Host_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_Host_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(P.AFDW.final$Host ~ P.AFDW.final$Timepoint*P.AFDW.final$Temperature*P.AFDW.final$CO2)
```

#### Sym AFDW = Model with tank and reef 

```{r}
Pacuta_Sym_LMER <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=P.AFDW.final) 
Pacuta_Sym_LMER.reef <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=P.AFDW.final)
model.sel(Pacuta_Sym_LMER, Pacuta_Sym_LMER.reef) # model selection function 
## Tank and reef model AIC = 271.9; just tank AIC = 277.2. Tank and reef model chosen 

## summary of the model chosen from above
## plot(Mcap_Chl_LMER) in console to view diagnostic plots
summary(Pacuta_Sym_LMER)
qqPlot(residuals(Pacuta_Sym_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_Sym_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(P.AFDW.final$Sym ~ P.AFDW.final$Timepoint*P.AFDW.final$Temperature*P.AFDW.final$CO2)
```

#### Ratio AFDW = Model with tank 

```{r}
Pacuta_SHRatio_LMER <- lmer(log(Ratio_S.H) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=P.AFDW.final) #GLMM
Pacuta_SHRatio_LMER.reef <- lmer(log(Ratio_S.H) ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=P.AFDW.final)
model.sel(Pacuta_SHRatio_LMER, Pacuta_SHRatio_LMER.reef) # model selection function 
## Ratio model with tank AIC = 351.7; model with tank and reef AIC = 354.5 

isSingular(Pacuta_SHRatio_LMER, tol = 1e-4) # this produced TRUE, the GLMM is overfitting the model

## summary of the model chosen from above
## plot(Mcap_Chl_LMER) in console to view diagnostic plots
summary(Pacuta_SHRatio_LMER)
qqPlot(residuals(Pacuta_SHRatio_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_SHRatio_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(P.AFDW.final$Ratio_S.H ~ P.AFDW.final$Timepoint*P.AFDW.final$Temperature*P.AFDW.final$CO2)
```

## Model selection M.capitata 

#### Host AFDW = Model with tank 

```{r}
## Host 
Mcap_Host_LMER <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=M.AFDW.final) 
Mcap_Host_LMER.reef <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=M.AFDW.final)
model.sel(Mcap_Host_LMER, Mcap_Host_LMER.reef) # model selection function 
## Model with just tank AIC = 584.8; model with tank and reef AIC = 587.9 

isSingular(Mcap_Host_LMER, tol = 1e-4) # this produced TRUE, the GLMM is overfitting the model

## summary of the model chosen from above
## plot(Mcap_Chl_LMER) in console to view diagnostic plots
summary(Mcap_Host_LMER)
qqPlot(residuals(Mcap_Host_LMER)) # qqplot and histogram 
hist(residuals(Mcap_Host_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(M.AFDW.final$Host ~ M.AFDW.final$Timepoint*M.AFDW.final$Temperature*M.AFDW.final$CO2)
```

#### Sym AFDW = Model with tank 

```{r}
Mcap_Sym_LMER <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=M.AFDW.final) 
Mcap_Sym_LMER.reef <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=M.AFDW.final)
model.sel(Mcap_Sym_LMER, Mcap_Sym_LMER.reef) # model selection function 
## Model with tank AIC = 540.2; model with tank and reef AIC = 543.2 

## summary of the model chosen from above
## plot(Mcap_Chl_LMER) in console to view diagnostic plots
summary(Mcap_Sym_LMER)
qqPlot(residuals(Mcap_Sym_LMER)) # qqplot and histogram 
hist(residuals(Mcap_Sym_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(M.AFDW.final$Sym ~ M.AFDW.final$Timepoint*M.AFDW.final$Temperature*M.AFDW.final$CO2)

## Type III Wald chisquare tests
Anova(Mcap_Sym_LMER, ddf="lme4", type='III') 
```


#### Ratio AFDW = Model with tank 

```{r}
Mcap_SHRatio_LMER <- lmer(Ratio_S.H ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=M.AFDW.final) 
Mcap_SHRatio_LMER.reef <- lmer(Ratio_S.H ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=M.AFDW.final)
model.sel(Mcap_SHRatio_LMER, Mcap_SHRatio_LMER.reef) # model selection function 
## Model with tank AIC = 250.1; model with tank and reef AIC = 253.3 

isSingular(Mcap_SHRatio_LMER, tol = 1e-4) # this produced TRUE, the GLMM is overfitting the model

## summary of the model chosen from above
## plot(Mcap_Chl_LMER) in console to view diagnostic plots
summary(Mcap_SHRatio_LMER)
qqPlot(residuals(Mcap_SHRatio_LMER)) # qqplot and histogram 
hist(residuals(Mcap_SHRatio_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(M.AFDW.final$Ratio_S.H ~ M.AFDW.final$Timepoint*M.AFDW.final$Temperature*M.AFDW.final$CO2)

## Type III Wald chisquare tests
Anova(Mcap_SHRatio_LMER, ddf="lme4", type='III') 
```


## ANOVA & Tukey Post Hoc Test

Type III Wald chi square tests chosen for now. 

Type III Analysis of Variance Table with Satterthwaite's method
anova(Pacuta_Host_LMER, ddf="Satterthwaite", type='III')

### P. acuta 

```{r}
Host.AFDW.aov.pacuta <- Anova(Pacuta_Host_LMER, ddf="lme4", type='III') 
Sym.AFDW.aov.pacuta <- Anova(Pacuta_Sym_LMER.reef, ddf="lme4", type='III') 
Ratio.AFDW.aov.pacuta <- Anova(Pacuta_SHRatio_LMER, ddf="lme4", type='III') 
```

```{r}
host.tukey <- TukeyHSD(x=Host.AFDW.aov.pacuta, conf.level = 0.95)

HSD.test(Host.AFDW.aov.pacuta, 'P.AFDW.final$Temperature')

```

### M. capitata

```{r}
Host.AFDW.aov.mcap <- Anova(Mcap_Host_LMER, ddf="lme4", type='III') 
Sym.AFDW.aov.mcap <- Anova(Mcap_Sym_LMER, ddf="lme4", type='III') 
Ratio.AFDW.aov.mcap <- Anova(Mcap_SHRatio_LMER, ddf="lme4", type='III') 
```

```{r}


```



# Graphing data

## Host vs Sym 
```{r}
cols <- c("lightblue", "blue", "salmon", "red3")

HostSym_plot <- ggplot(AFDW_long, aes(x=Treatment, y=Value, fill=partner)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "left") + 
  facet_grid(Measurement ~ Species, scales = "free")
HostSym_plot

ggsave(file="Output/Tissue_Biomass_HostvSym.pdf", HostSym_plot, width = 11, height = 6, units = c("in"))
```

## Host and Sym 
```{r}

AFDW_plot <- ggplot(AFDW.ratio.means, aes(x=Timepoint, y = Value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(partner ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=Value-se, ymax=Value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Ash Free Dry Weight" ~(mg ~cm^-2))) +
  #ggtitle("Tissue Biomass") +
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); AFDW_plot

ggsave(file="Output/Final_Figures/Tissue_Biomass.pdf", AFDW_plot, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Tissue_Biomass.png", AFDW_plot, width = 11, height = 6, units = c("in"))
```

## Ratio 

```{r}
AFDW_Ratio_plot <- ggplot(Ratio.means, aes(x=Timepoint, y = Ratio_AFDW.mg.cm2, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~ Species, scales = "free") +
  geom_errorbar(aes(ymin=Ratio_AFDW.mg.cm2-se, ymax=Ratio_AFDW.mg.cm2+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  #ylab("expression(AFDW ~(mg ~cm^-2))") +
  ylab("Ash Free Dry Weight S:H Ratio") +
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); AFDW_Ratio_plot

ggsave(file="Output/Final_Figures/Tissue_Biomass-Ratio.pdf", AFDW_Ratio_plot, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Tissue_Biomass-Ratio.png", AFDW_Ratio_plot, width = 11, height = 6, units = c("in"))

```


AFDW things to address:
1. Mcap outlier in HTHC at Day 2 - 1197. But this occurs with both the Host and Sym fraction and similar pattern holds in respiration rates. 
2. Won't have AFDW values for 1327, 1174, or 1488. 
3. 16 missing corals contribute to the wide ranges at day 2 and 1 week.

############## Bleaching Fragment Test prior to running the rest of the samples.

This was a test batch of 12 samples to make sure we would get a signal from both healthy and bleached samples. 

Reading in bleaching test information. 
```{r}
Phys_testing <- read.csv("Physiology_variables/phys_testing.csv")
Phys_testing$Plug_ID <- as.character(Phys_testing$Plug_ID)
AFDW$Plug_ID <- as.character(AFDW$Plug_ID)

AFDW_testing <- full_join(AFDW, Phys_testing, by="Plug_ID") %>% 
select(Plug_ID, partner, Species, Treatment, Timepoint, DW.mg.cm2, AFDW.mg.cm2, status, bleaching_score) %>% filter(!is.na(status))

AFDW_testing <- gather(AFDW_testing, "Measurement", "Value", 6:7) # changing columns to rows to allow for easier facet_grid in graphing section
```

Graphing bleach test data. 
```{r}
Bleached1 <- ggplot(AFDW_testing, aes(x=status, y=Value, fill=partner)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "left") + 
  facet_grid(Measurement ~ Species, scales = "free")
Bleached1

Bleached2 <- ggplot(AFDW_testing, aes(x=bleaching_score, y=Value, color=partner)) + geom_point() + 
  xlab("Bleaching Score") + theme_bw() + 
  facet_grid(Measurement ~ Species, scales = "free") + 
  theme(legend.position = "left")
Bleached2

AFDW.Blch.Figs <- arrangeGrob(Bleached1, Bleached2, ncol=2)

ggsave(file="Output/Phystest_AFDW.pdf", AFDW.Blch.Figs, width = 15, height = 10, units = c("in"))
```


