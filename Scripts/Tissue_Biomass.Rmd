---
title: "Tissue_Biomass"
author: "EL Strand"
date: "7/18/2020"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---
Clears workspace. 
```{r}
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("plotrix")) install.packages("plotrix")
if (!require("dplyr")) install.packages("dplyr")
if (!require("plyr")) install.packages("plyr")
if (!require("Rmisc")) install.packages("Rmisc")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("formattable")) install.packages("formattable")
if (!require("data.table")) install.packages("data.table")
if (!require("htmltools")) install.packages("htmltools")
if (!require("webshot")) install.packages("webshot")

# load packages
library(tidyverse)
library(plotrix)
library(dplyr)
library(plyr)
library(Rmisc)
library(gridExtra)
library(formattable)
library(data.table)
library(htmltools)
library(webshot)
library(agricolae)
library(lme4)
library(car)
library(sjPlot)
```

Dry Weight - organic and inorganic compounds
Ash-Free Dry Weight - organic compounds 

## Read in Ash-Free Dry Weight raw data, surface area, homogenate volume, and master datasheets
```{r}
AFDW_raw <- read.csv("Physiology_variables/AFDW_data.csv") %>% filter(!is.na(Plug_ID))
AFDW_raw$Plug_ID <- as.character(AFDW_raw$Plug_ID)

# Load surface area and homogenate volume values; merge dataframes from chla, chlc means 
Surface_area <- read.csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>%
  select(Plug_ID, surface.area.cm2)
Homogenate_volume <- read.csv("Physiology_variables/homogenate_vol.csv") %>%
  select(Plug_ID, vol_mL)
Master_fragment <- read.csv("Environmental_data/Master_Fragment.csv") %>% subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular") %>% # need to keep "Physiology" and "Physiology/Molecular"
  select(Plug_ID, Species, Treatment, Temperature, CO2, Timepoint, Tank, Site.Name) 
  Master_fragment$Plug_ID <- as.character(Master_fragment$Plug_ID)

cell.density <- read.csv("Output/cell_counts.csv") %>% select(Plug_ID, cells, haemo.cells.cm2)
cell.density$Plug_ID <- as.factor(cell.density$Plug_ID)

AFDW_raw_metadata <- join_all(list(AFDW_raw, Surface_area, Homogenate_volume, Master_fragment, cell.density), by='Plug_ID', type='left')
AFDW_raw_metadata$Species <- as.character(AFDW_raw_metadata$Species)
AFDW_raw_metadata$Species[AFDW_raw_metadata$Species == "Mcapitata"] <- "Montipora capitata"
AFDW_raw_metadata$Species[AFDW_raw_metadata$Species == "Pacuta"] <- "Pocillopora acuta"
```

Checking to see if any samples from the master weren't done or any that were done aren't on the master. 
```{r}
Master_PlugID <- Master_fragment %>% select(Plug_ID)
AFDW_IDs <- AFDW_raw %>% select(Plug_ID)

# rows that appear in the AFDW spreadsheet but not in the master 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a AFDW spreadsheet data point but were not in master ; output should be zero
# any output is likely the plug ID written incorrectly during sample processing
AFDW_mismatched <- setdiff(AFDW_IDs, Master_PlugID) 
AFDW_mismatched

# rows that appear in the master spreadsheet but not in the AFDW 
  ## dplyr::setdiff(y, z)  : rows that appear in y but not in z
# output is the corals that have a master spreadsheet data point but were not in AFDW ; output should be zero
AFDW_mismatched2 <- setdiff(Master_PlugID, AFDW_IDs) 
AFDW_mismatched2

# Missing list: "2008", "2512", "2522", "2523", "2752", "2880", "2976", "3003", "1603", "1739", "2200", "2528", "2740", "2859", "2981", "2984"
# Corals we won't have AFDW for: 1174, 1327, 1488 
```

### Calculate mass per mL
```{r}
#different volumes for sym (5ml - just spun down) and host (4ml)
sym <- 5
host <- 4
AFDW <- AFDW_raw_metadata %>%
  mutate(dry.pan.mass.g.ml = case_when(partner=="Host" ~ dry.pan.mass.g/sym, partner=="Sym" ~ dry.pan.mass.g/host),
         burnt.pan.mass.g.ml = case_when(partner=="Host" ~ burnt.pan.mass.g/sym, partner=="Sym" ~ burnt.pan.mass.g/host))
```

# Calculating Tissue Biomass (AFDW)
```{r}
# Calculating Dry Weight and Ash-Free Dry Weight; standardizing by homogenate volume and surface area
AFDW <- AFDW %>%
  mutate(dry.bioimass.g.ml = (dry.pan.mass.g.ml - burnt.pan.mass.g.ml),
         dry.bioimass.g = dry.pan.mass.g.ml * vol_mL,
         burnt.bioimass.g = burnt.pan.mass.g.ml * vol_mL,
         DW.mg.cm2 = ((dry.bioimass.g)*1000) / surface.area.cm2,
         AFDW.mg.cm2 = ((dry.bioimass.g-burnt.bioimass.g)*1000) / surface.area.cm2,
         AFDW.mg.cells.cm2 = ((dry.bioimass.g-burnt.bioimass.g)*1000) / haemo.cells.cm2,
         AFDW.mg.cells = ((dry.bioimass.g-burnt.bioimass.g)*1000) / cells)

## Removing Day 1 and 2
## Setting the order of levels for timepoint so that it is in timepoint order not alphabetical
AFDW <- AFDW %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2")
AFDW$Timepoint <- factor(AFDW$Timepoint, levels=c("1 week","2 week","4 week","6 week","8 week","12 week","16 week"))

# Calculating AFDW biomass ratio 
AFDW.cm2 <- AFDW %>% select(-X) %>% distinct() %>% select(Plug_ID, partner, Species, Treatment, Temperature, CO2, Timepoint, Tank, AFDW.mg.cm2) %>% 
  spread(partner, AFDW.mg.cm2) %>% mutate(Ratio_S.H=Sym/Host) %>% gather("partner", "value", 8:10) %>% na.omit()

AFDW.cells.cm2 <- AFDW %>% select(-X) %>% distinct() %>% 
  select(Plug_ID, partner, Species, Treatment, Temperature, CO2, Timepoint, Tank, AFDW.mg.cells.cm2) %>% spread(partner, AFDW.mg.cells.cm2) %>% 
  gather("partner", "value", 7:9) %>% na.omit()

AFDW.cells <- AFDW %>% select(-X) %>% distinct() %>% 
  select(Plug_ID, partner, Species, Treatment, Temperature, CO2, Timepoint, Tank, AFDW.mg.cells) %>% spread(partner, AFDW.mg.cells) %>% 
  gather("partner", "value", 7:9) %>% na.omit()

# Taking out 1116 because it was an outlier. 
# filter(AFDW.final, Ratio_S.H>3)
week8HTHC <- AFDW.cells.cm2 %>% subset(Timepoint == "8 week" & Species == "Montipora capitata" & Treatment == "HTHC")

# Calculating means for each group and filtering out those groups with sample size less than 3
AFDW.means.cm2 <- summarySE(AFDW.cm2, measurevar = c("value"), groupvars = c("Treatment", "Timepoint", "Species", "partner"))
AFDW.means.cm2 <- AFDW.means.cm2 %>% filter(N > 3) %>%
  mutate(partner = case_when(
    partner == "Sym" ~ "Symbiont",
    partner == "Ratio_S.H" ~ "S:H Ratio",
    partner == "Host" ~ "Host" # need to include this otherwise Host changes to NA
  ))
AFDW.means.cm2$partner <- factor(AFDW.means.cm2$partner, levels=c("Host", "Symbiont", "S:H Ratio"))

AFDW.means.cells.cm2 <- summarySE(AFDW.cells.cm2, measurevar = c("value"), groupvars = c("Treatment", "Timepoint", "Species", "partner"))
AFDW.means.cells.cm2 <- AFDW.means.cells.cm2 %>% filter(N > 3) %>%
  mutate(partner = case_when(
    partner == "Sym" ~ "Symbiont",
    partner == "Host" ~ "Host" # need to include this otherwise Host changes to NA
  ))
AFDW.means.cells.cm2$partner <- factor(AFDW.means.cells.cm2$partner, levels=c("Host", "Symbiont"))

AFDW.means.cells <- summarySE(AFDW.cells, measurevar = c("value"), groupvars = c("Treatment", "Timepoint", "Species", "partner"))
AFDW.means.cells <- AFDW.means.cells %>% filter(N > 3) %>%
  mutate(partner = case_when(
    partner == "Sym" ~ "Symbiont",
    partner == "Host" ~ "Host" # need to include this otherwise Host changes to NA
  ))
AFDW.means.cells$partner <- factor(AFDW.means.cells$partner, levels=c("Host", "Symbiont"))

```

Quality control.
```{r}
ggplot(AFDW, aes(x=partner, y=AFDW.mg.cm2)) + geom_boxplot()

dplyr::filter(AFDW, AFDW.mg.cm2 > 5) # unusually high values for AFDW; think about re-doing?
dplyr::filter(AFDW, AFDW.mg.cm2 < 0) # output should be zero since negative values are not possible. 

# AFDW.duplicates <- AFDW %>% dplyr::group_by(Plug_ID) %>% 
#   dplyr::summarise(n = n()) %>% filter(n > 4)
# AFDW.duplicates # Output should be zero 
```

### Double checking sample sizes. 
```{r}
# # Looking at sample sizes 
# dplyr::filter(AFDW.host.means, N > 6) # this output should be zero b/c the biggest sample size is 6
# #seven <- AFDW_long %>% subset(Timepoint=="4 week") %>% subset(Treatment=="ATHC") %>% subset(partner=="Host") %>% subset(Measurement=="AFDW.mg.cm2") %>% subset(Species=="Mcapitata")
# #seven
# 
# dplyr::filter(AFDW.final, Plug_ID=="2863")
```

### Export datafile.
```{r}
# write AFDW data to file
AFDW.cm2 %>%
  write_csv(path = "Output/Tissue_Biomass.csv")
```

# Graphing data

## Host vs Sym 
```{r}
# 
# HostSym_plot <- ggplot(AFDW_long, aes(x=Treatment, y=Value, fill=partner)) + geom_boxplot(alpha=0.5) +
#   geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
#   theme(legend.position = "left") + 
#   facet_grid(Measurement ~ Species, scales = "free")
# HostSym_plot
# 
# ggsave(file="Output/Tissue_Biomass_HostvSym.pdf", HostSym_plot, width = 11, height = 6, units = c("in"))
```

## Plotting
```{r}
cols <- c("blue", "lightblue", "salmon", "red3")

AFDW.means.cm2 <- AFDW.means.cm2 %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")
AFDW.means.cells.cm2 <- AFDW.means.cells.cm2 %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")
AFDW.means.cells <- AFDW.means.cells %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

AFDW_plot <- ggplot(AFDW.means.cm2, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(partner ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  theme(axis.title.y = element_text(hjust=0.9)) +
  ylab(expression("Ash Free Dry Weight" ~(mg ~cm^-2))) +
  #ggtitle("Tissue Biomass") +
  theme(legend.position = "none") +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); AFDW_plot

ggsave(file="Output/Final_Figures/Tissue_Biomass_cm2.pdf", AFDW_plot, width = 8, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Tissue_Biomass_cm2.png", AFDW_plot, width = 8, height = 6, units = c("in"))

AFDW_plot_cellscm2 <- ggplot(AFDW.means.cells.cm2, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(partner ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Ash Free Dry Weight (mg / cells.cm2")) +
  #ggtitle("Tissue Biomass") +
  theme(legend.position = "none") +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); AFDW_plot_cellscm2

ggsave(file="Output/Final_Figures/Tissue_Biomass_cellscm2.pdf", AFDW_plot_cellscm2, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Tissue_Biomass_cellscm2.png", AFDW_plot_cellscm2, width = 11, height = 6, units = c("in"))

AFDW_plot_cells <- ggplot(AFDW.means.cells, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(partner ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Ash Free Dry Weight" ~(mg ~cells^-1))) +
  #ggtitle("Tissue Biomass") +
  theme(legend.position = "none") +
 # geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); AFDW_plot_cells 

ggsave(file="Output/Final_Figures/Tissue_Biomass_cells.pdf", AFDW_plot_cells, width = 11, height = 6, units = c("in"))
ggsave(file="Output/Final_Figures/Tissue_Biomass_cells.png", AFDW_plot_cells, width = 11, height = 6, units = c("in"))


Pact.AFDW.cells <- AFDW.means.cells %>% subset(Species == "Pocillopora acuta" & partner == "Symbiont") %>%
  subset(!Timepoint == "12 week" & !Timepoint == "16 week") %>%
  ggplot(aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  theme_classic() + 
  ylab(expression("Symbiont AFDW" ~(mg ~cells^-1))) +
  theme(legend.position = c(0.15,0.7)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.text = element_text(size = 13)) +
  theme(legend.title = element_text(size = 15)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")); Pact.AFDW.cells

ggsave(file="Output/Tissue_Biomass_cells_Pacuta.png", Pact.AFDW.cells, width = 7, height = 5, units = c("in"))

Pact.AFDW.cm2 <- AFDW.means.cm2 %>% subset(Species == "Pocillopora acuta" & partner == "Symbiont") %>%
  subset(!Timepoint == "12 week" & !Timepoint == "16 week") %>%
  ggplot(aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  facet_grid(~Species) +
  geom_line() + geom_point() +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  theme_classic() + 
   theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  ylab(expression("Symbiont AFDW" ~(mg ~cm^-2))) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 35, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.text = element_text(size = 13)) +
  theme(legend.title = element_text(size = 15)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 17, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")); Pact.AFDW.cm2

ggsave(file="Output/Tissue_Biomass_cm2_Pacuta.png", Pact.AFDW.cm2, width = 7, height = 5, units = c("in"))
```

M.cap and P.acuta ignore treatment, species comparison.

```{r}
Spp.cm2 <- AFDW.cm2 %>% subset(!Timepoint == "12 week" & !Timepoint == "16 week")
Spp.means.cm2 <- summarySE(Spp.cm2, measurevar = c("value"), groupvars = c("Species", "partner"))

Spp.cm2.plot <- ggplot(Spp.means.cm2, aes(x=Species, y = value, group = partner, shape = partner)) + geom_point(size=3) + geom_line() +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  theme_classic() + 
  expand_limits(y = 0) +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  ylab(expression(AFDW ~mg ~cm^-2)) +
  theme(legend.position = c(0.95,0.9)) +
  theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.text = element_text(size = 13)) +
  theme(legend.title = element_text(size = 15)) 
  
ggsave(file="Output/Tissue_Biomass_cm2.png", Spp.cm2.plot, width = 5, height = 3, units = c("in"))
```



## Ratio 

```{r}
# AFDW_Ratio_plot <- ggplot(AFDW.ratio.means, aes(x=Timepoint, y = Ratio_S.H, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() +
#   facet_grid(~ Species, scales = "free") +
#   geom_errorbar(aes(ymin=Ratio_S.H-se, ymax=Ratio_S.H+se), width=.2) +
#   scale_color_manual(values = cols) + 
#   xlab("Timepoint") + 
#   theme_classic() + 
#   #ylab("expression(AFDW ~(mg ~cm^-2))") +
#   ylab("Ash Free Dry Weight S:H Ratio") +
#   theme(legend.position = "left") +
#   geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
#   theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) +
#   theme(panel.border = element_blank(),
#   panel.grid.major = element_blank(),
#   panel.grid.minor = element_blank(),
#   strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
#   # Change axis line
#   axis.line = element_line(colour = "black")); AFDW_Ratio_plot
# 
# ggsave(file="Output/Final_Figures/Tissue_Biomass-Ratio.pdf", AFDW_Ratio_plot, width = 11, height = 6, units = c("in"))
# ggsave(file="Output/Final_Figures/Tissue_Biomass-Ratio.png", AFDW_Ratio_plot, width = 11, height = 6, units = c("in"))

```

# Statistics 

Reading in dataframe so you don't have the run the script every time. 
```{r}
biomass <- read.csv("Output/Tissue_Biomass.csv") %>% spread(partner, value)

biomass.pacuta <- biomass %>% subset(Species == "Pocillopora acuta") %>% 
  subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

biomass.mcap <- biomass %>% subset(Species == "Montipora capitata") %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week" | Timepoint == "12 week" | Timepoint == "16 week")

hist(biomass.pacuta$Host) 
hist(biomass.pacuta$Sym) 
hist(biomass.pacuta$Ratio_S.H) 

hist(biomass.mcap$Host) 
hist(biomass.mcap$Sym) 
hist(biomass.mcap$Ratio_S.H) 
```

#### Host AFDW 

```{r}
HOST_LMER <- lmer(Host ~ Timepoint*Temperature*CO2*Species + (1|Tank), na.action=na.omit, data=biomass)
Pacuta_Host_LMER <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.pacuta) 
Mcap_Host_LMER <- lmer(Host ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.mcap) 

qqPlot(residuals(Pacuta_Host_LMER)) 
qqPlot(residuals(Mcap_Host_LMER)) 
qqPlot(residuals(HOST_LMER)) 

hist(residuals(Pacuta_Host_LMER)) 
hist(residuals(Mcap_Host_LMER)) 
hist(residuals(HOST_LMER)) 

## Type III Wald chisquare tests
pacuta.host.anova <- Anova(Pacuta_Host_LMER, ddf="lme4", type='III') 
mcap.host.anova <- Anova(Mcap_Host_LMER, ddf="lme4", type='III') 
spp.host.anova <- Anova(HOST_LMER, ddf="lme4", type='III') 

tab_model(Pacuta_Host_LMER, Mcap_Host_LMER,
          dv.labels = c("P.acuta Host", "M.cap Host"), string.ci = "Conf. Int (95%)",
          string.p = "P-Value", file = "Output/Statistics/AFDW_Host.doc")

capture.output(pacuta.host.anova, file = "Output/Statistics/AFDW_Host_Pacuta.txt")
capture.output(mcap.host.anova, file = "Output/Statistics/AFDW_Host_Mcap.txt")
capture.output(spp.host.anova, file = "Output/Statistics/AFDW_Host.txt")

species.t <- t.test(Host~Species, data = biomass)
capture.output(species.t, file = "Output/Statistics/AFDW_Host_TTEST.txt")
```

#### Sym AFDW  

```{r}
Pacuta_Sym_LMER <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.pacuta) 
Mcap_Sym_LMER <- lmer(Sym ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.mcap) 

qqPlot(residuals(Pacuta_Sym_LMER)) 
qqPlot(residuals(Mcap_Sym_LMER)) 

hist(residuals(Pacuta_Sym_LMER)) 
hist(residuals(Mcap_Sym_LMER)) 

## Type III Wald chisquare tests
pacuta.sym.anova <- Anova(Pacuta_Sym_LMER, ddf="lme4", type='III') 
mcap.sym.anova <- Anova(Mcap_Sym_LMER, ddf="lme4", type='III') 

tab_model(Pacuta_Sym_LMER, Mcap_Sym_LMER,
          dv.labels = c("P.acuta Sym", "M.cap Sym"), string.ci = "Conf. Int (95%)",
          string.p = "P-Value", file = "Output/Statistics/AFDW_Sym.doc")

capture.output(pacuta.sym.anova, file = "Output/Statistics/AFDW_Sym_Pacuta.txt")
capture.output(mcap.sym.anova, file = "Output/Statistics/AFDW_Sym_Mcap.txt")

species.t.sym <- t.test(Sym~Species, data = biomass)
capture.output(species.t.sym, file = "Output/Statistics/AFDW_Sym_TTEST.txt")
```

#### Ratio AFDW

```{r}
Pacuta_Ratio_LMER <- lmer(log(Ratio_S.H) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.pacuta) 
Mcap_Ratio_LMER <- lmer(Ratio_S.H ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=biomass.mcap) 

qqPlot(residuals(Pacuta_Ratio_LMER)) 
qqPlot(residuals(Mcap_Ratio_LMER)) 

hist(residuals(Pacuta_Ratio_LMER)) 
hist(residuals(Mcap_Ratio_LMER)) 

## Type III Wald chisquare tests
pacuta.ratio.anova <- Anova(Pacuta_Ratio_LMER, ddf="lme4", type='III') 
mcap.ratio.anova <- Anova(Mcap_Ratio_LMER, ddf="lme4", type='III') 

tab_model(Pacuta_Ratio_LMER, Mcap_Ratio_LMER,
          dv.labels = c("P.acuta Ratio", "M.cap Ratio"), string.ci = "Conf. Int (95%)",
          string.p = "P-Value", file = "Output/Statistics/AFDW_Ratio.doc")

capture.output(pacuta.ratio.anova, file = "Output/Statistics/AFDW_Ratio_Pacuta.txt")
capture.output(mcap.ratio.anova, file = "Output/Statistics/AFDW_Ratio_Mcap.txt")

species.t.ratio <- t.test(`Ratio_S.H`~Species, data = biomass)
capture.output(species.t.ratio, file = "Output/Statistics/AFDW_Ratio_TTEST.txt")
```


AFDW things to address:
1. Mcap outlier in HTHC at Day 2 - 1197. But this occurs with both the Host and Sym fraction and similar pattern holds in respiration rates. 
2. Won't have AFDW values for 1327, 1174, or 1488. 
3. 16 missing corals contribute to the wide ranges at day 2 and 1 week.

############## Bleaching Fragment Test prior to running the rest of the samples.

This was a test batch of 12 samples to make sure we would get a signal from both healthy and bleached samples. 

Reading in bleaching test information. 
```{r}
Phys_testing <- read.csv("Physiology_variables/phys_testing.csv")
Phys_testing$Plug_ID <- as.character(Phys_testing$Plug_ID)
AFDW$Plug_ID <- as.character(AFDW$Plug_ID)

AFDW_testing <- full_join(AFDW, Phys_testing, by="Plug_ID") %>% 
select(Plug_ID, partner, Species, Treatment, Timepoint, DW.mg.cm2, AFDW.mg.cm2, status, bleaching_score) %>% filter(!is.na(status))

AFDW_testing <- gather(AFDW_testing, "Measurement", "Value", 6:7) # changing columns to rows to allow for easier facet_grid in graphing section
```

Graphing bleach test data. 
```{r}
Bleached1 <- ggplot(AFDW_testing, aes(x=status, y=Value, fill=partner)) + geom_boxplot(alpha=0.5) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + xlab("") + theme_bw() + 
  theme(legend.position = "left") + 
  facet_grid(Measurement ~ Species, scales = "free")
Bleached1

Bleached2 <- ggplot(AFDW_testing, aes(x=bleaching_score, y=Value, color=partner)) + geom_point() + 
  xlab("Bleaching Score") + theme_bw() + 
  facet_grid(Measurement ~ Species, scales = "free") + 
  theme(legend.position = "left")
Bleached2

AFDW.Blch.Figs <- arrangeGrob(Bleached1, Bleached2, ncol=2)

ggsave(file="Output/Phystest_AFDW.pdf", AFDW.Blch.Figs, width = 15, height = 10, units = c("in"))
```


