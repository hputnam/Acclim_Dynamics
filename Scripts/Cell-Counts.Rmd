----
title: "Endosymbiont Density (cell counts) Analysis"
author: "Author: Emma Strand; emma_strand@uri.edu"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

Code modified from R. Cunning, H. Putnam, and E5 group; link [here](https://github.com/urol-e5/timeseries/blob/master/timepoint_1/scripts/Sym-Density.Rmd).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages.
```{r}
rm(list=ls())

library(plyr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggpubr)
library(purrr)
library(Rmisc)
library(lme4)
library(car)
library(sjPlot)
library(ggstatsplot)
library(emmeans)
```


# Holobiont Integration sample processing 

## Loading meta data frames. 

```{r}
# Surface area data
sa <- read.csv("data/Physiology_variables/Respirometry/coral_surface_area.csv", sep = ",") %>% 
  dplyr::rename(Plug_ID = Sample_ID) %>% select(Plug_ID, surface.area.cm2)
sa$Plug_ID <- as.character(sa$Plug_ID)

# Tissue homogenate volume data
homog_vols <- read.csv("data/Physiology_variables/homogenate_vol.csv", sep = ",") %>% select(Species, Plug_ID, vol_mL)
homog_vols$Plug_ID <- as.character(homog_vols$Plug_ID)

# Coral sample metadata
metadata <- read.csv("metadata/Master_Fragment.csv", sep = ",") %>% select(Species, Plug_ID, Tank, Treatment, Temperature, CO2, Timepoint, ANALYSIS, Sample.Date) %>%
  subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular")
metadata$Plug_ID <- as.character(metadata$Plug_ID)

# Join homogenate volumes and surface area with sample metadata
metadata <- full_join(metadata, homog_vols) %>% full_join(sa) %>% filter(!is.na(vol_mL)) %>% 
  filter(!is.na(ANALYSIS)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))
```

## Import haemocytometer dataframe. 

```{r}
## Haemocytometer data 
haemo.raw <- read.csv("data/Physiology_variables/cell-counts/cell_counts.csv")
   haemo.raw$Plug_ID <- as.character(haemo.raw$Plug_ID)
```

## Calculate counts for haemocytometer counts

```{r}
# Calculate mean counts for each sample
haemo <- haemo.raw %>%
  select(Plug_ID, Squares_Counted, matches("Count[0-6]")) %>%
  gather("rep", "count", -Plug_ID, -Squares_Counted) %>% filter(!is.na(count)) %>%
  dplyr::group_by(Plug_ID) %>% 
  mutate(count.mean = mean(count))

# Join mean counts with sample metadata
haemo <- full_join(haemo, metadata) 

# Normalize counts by homogenate volume and surface area
haemo <- haemo %>%
  mutate(cells.mL = count.mean * 10000 / Squares_Counted,
         cells = cells.mL * vol_mL,
         haemo.cells.cm2 = cells / surface.area.cm2)

haemo <- haemo %>% filter(!is.na(haemo.cells.cm2))
haemo$Timepoint <- factor(haemo$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))

## figure out outliers 
haemo %>% ggplot(aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) + 
  facet_grid(Species ~Treatment) + theme_classic() + geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3))

### write output script 
haemo <- haemo %>% unite(Group, Treatment, Timepoint, sep = " ", remove = FALSE) %>%
  write_csv(., file = "Output/cell_counts.csv")
```

## Checking distribution and variation.
```{r}
cols <- c("blue", "lightblue", "salmon", "red3")

ggplot(haemo, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) + 
  facet_grid(Species ~Treatment) + theme_classic() + geom_point() + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3))

# plug IDs that had above 1 million cells per cm2; double check that these counts and the variation looks OK
# above <- haemo %>% filter(haemo.cells.cm2 > 1500000) %>% distinct()

week6ATHC <- haemo %>% subset(Treatment == "ATHC" & Species == "Montipora capitata" & Timepoint == "6 week")
week4HTAC <- haemo %>% subset(Treatment == "HTAC" & Species == "Montipora capitata" & Timepoint == "4 week")
```



## Calculate means from each timepoint and group. 

```{r}
haemo.means <- haemo %>% filter(haemo.cells.cm2 < 1500000) 

haemo.for.means.calc <- haemo %>%
  select(Treatment, Species, Timepoint, haemo.cells.cm2) %>% distinct()

count.means <- summarySE(haemo, measurevar = c("haemo.cells.cm2"), groupvars = c("Treatment", "Timepoint", "Species"))
count.means2 <- summarySE(haemo.means, measurevar = c("haemo.cells.cm2"), groupvars = c("Treatment", "Timepoint", "Species"))

count.means.test <- summarySE(haemo.for.means.calc, measurevar = c("haemo.cells.cm2"), groupvars = c("Treatment", "Timepoint", "Species"))

count.means.stress <- count.means %>% 
  subset(!Timepoint == "Day 1" & !Timepoint == "Day 2" & !Timepoint == "12 week" & !Timepoint == "16 week") %>% filter(N > 12) # N is higher because grouping number of counts in previous dataframe. mean here is still mean of the pop where each individual has an average count of six counts

count.means.stress2 <- count.means2 %>% 
  subset(!Timepoint == "Day 1" & !Timepoint == "Day 2" & !Timepoint == "12 week" & !Timepoint == "16 week") %>% filter(N > 12) # N is higher because grouping number of counts in previous dataframe. mean here is still mean of the pop where each individual has an average count of six counts

count.means.test.stress <- count.means.test %>%
  subset(!Timepoint == "Day 1" & !Timepoint == "Day 2" & !Timepoint == "12 week" & !Timepoint == "16 week") %>% filter(N > 3)

count.means.test.full <- count.means.test %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2") %>% filter(N > 3)

count.means.full <- count.means %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2") %>% filter(N > 12)
count.means.full2 <- count.means2 %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2") %>% filter(N > 12)
```

## Visualize data 

```{r}
points.stress <- haemo.for.means.calc %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2" & !Timepoint == "12 week" & !Timepoint == "16 week") %>%
  mutate(haemo.cells.10cm2 = haemo.cells.cm2/100000)

count.means.test.stress.plot <- count.means.test.stress %>% 
  mutate(haemo.cells.10cm2 = haemo.cells.cm2/100000,
         se10 = se/100000)

cellcounts_plot <- ggplot(count.means.test.stress.plot, aes(x=Timepoint, y = haemo.cells.10cm2, group = Treatment, color = Treatment)) +
 geom_jitter(data = points.stress, 
              aes(x=Timepoint, y=haemo.cells.10cm2, group = Treatment, color = Treatment), 
              size=2, width=0.2, alpha=0.15) + 
  geom_line(size=1) + 
  geom_errorbar(aes(ymin=haemo.cells.10cm2-se10, ymax=haemo.cells.10cm2+se10), width=.2, size=1) +
  geom_point(size=3) +
  facet_grid(~Species, scales = "free") +
    scale_color_manual(values = cols) + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~x10^5 ~cm^-2))) +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0),
        axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = c(0.94,0.8),
        panel.grid.minor = element_blank(),
        strip.text.x = element_text(size = 20, color = "black", face = "bold.italic"), # Change axis line
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 13),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        legend.title = element_text(size = 15)); cellcounts_plot

ggsave(file="Output/Figures/Counts_stress.png", cellcounts_plot, width = 11, height = 6, units = c("in"))
```

```{r}
cellcounts_plot_full <- ggplot(count.means.test.full, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=haemo.cells.cm2-se, ymax=haemo.cells.cm2+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  theme(legend.position = c(0.6,0.7)) +
  geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 20, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")) + theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 13)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 15)); cellcounts_plot_full # Change axis line

ggsave(file="Output/Supplemental_figures/full_cellcounts.png", cellcounts_plot_full, width = 11, height = 6, units = c("in"))


count.means.test.recovery <- count.means.test.full %>%
  subset(Species == "Montipora capitata") %>%
  subset(Timepoint == "8 week" | Timepoint == "12 week" | Timepoint == "16 week") %>%
  mutate(haemo.cells.10cm2 = haemo.cells.cm2/100000,
         se10 = se/100000)

points.recovery <- haemo.for.means.calc %>% subset(Timepoint == "8 week" | Timepoint == "12 week" | Timepoint == "16 week") %>%
  mutate(haemo.cells.10cm2 = haemo.cells.cm2/100000) %>% subset(Species == "Montipora capitata")

cellcounts_plot_recovery <- ggplot(count.means.test.recovery, aes(x=Timepoint, y = haemo.cells.10cm2, group = Treatment, color = Treatment)) +
 geom_jitter(data = points.recovery, 
              aes(x=Timepoint, y=haemo.cells.10cm2, group = Treatment, color = Treatment), 
              size=2, width=0.2, alpha=0.15) + 
  geom_line(size=1) + 
  geom_errorbar(aes(ymin=haemo.cells.10cm2-se10, ymax=haemo.cells.10cm2+se10), width=.2, size=1) +
  geom_point(size=3) +
  facet_grid(~Species, scales = "free") +
    scale_color_manual(values = cols) + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~x10^5 ~cm^-2))) +
  geom_vline(xintercept = c(1.35), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0),
        axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        legend.position = "none",
        panel.grid.minor = element_blank(),
        strip.text.x = element_text(size = 20, color = "black", face = "bold.italic"), # Change axis line
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 13),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        legend.title = element_text(size = 15))

ggsave(file="Output/Figures/cellcounts_recovery.png", cellcounts_plot_recovery, width = 5, height = 4, units = c("in"))
```

## Presentation figures 

```{r}
cellcounts_plot.ppt <- cellcounts_plot + geom_point(size = 3) +  theme(legend.position = "none") +
  theme(axis.title = element_text(size = 20)) +
  theme(legend.text = element_text(size = 15)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 15))

ggsave(file="Output/Cell_counts_ppt.png", cellcounts_plot.ppt, width = 11, height = 6, units = c("in"))
```


## Statistics 

Subsetting into time points 

```{r}
mcap.counts <- haemo %>% subset(Species == "Montipora capitata") %>% 
  subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

mcap.counts.recovery <- haemo %>% subset(Species == "Montipora capitata") %>% 
  subset(Timepoint == "12 week" | Timepoint == "16 week")

pacuta.counts <- haemo %>% subset(Species == "Pocillopora acuta") %>% 
  subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

hist(mcap.counts$haemo.cells.cm2) 
hist(pacuta.counts$haemo.cells.cm2) 
hist(mcap.counts.recovery$haemo.cells.cm2) 
```

### Linear mixed models 

```{r}
Pacuta_counts_LMER2 <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta.counts, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

Mcap_counts_LMER2 <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap.counts, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

Mcap_counts_recovery_LMER2 <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap.counts.recovery, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

qqPlot(residuals(Pacuta_counts_LMER2)) 
qqPlot(residuals(Mcap_counts_LMER2)) 
qqPlot(residuals(Mcap_counts_recovery_LMER2)) 

hist(residuals(Pacuta_counts_LMER2)) 
hist(residuals(Mcap_counts_LMER2)) 
hist(residuals(Mcap_counts_recovery_LMER2)) 

## Type III Wald chisquare tests
pacuta.counts.anova <- Anova(Pacuta_counts_LMER2, ddf="lme4", type='III') 
mcap.counts.anova <- Anova(Mcap_counts_LMER2, ddf="lme4", type='III') 
mcap.counts.recovery.anova <- Anova(Mcap_counts_recovery_LMER2, ddf="lme4", type='III') 

capture.output(pacuta.counts.anova, file = "Output/Statistics/Stress_statistics/Counts/Counts_Pacuta.txt")
capture.output(mcap.counts.anova, file = "Output/Statistics/Stress_statistics/Counts/Counts_Mcap.txt")
capture.output(mcap.counts.recovery.anova, file = "Output/Statistics/Recovery_statistics/Counts_Mcap_recovery.txt")

# Tukey Pacuta Stress 
tukey.pacuta.counts <- emmeans(Pacuta_counts_LMER2, list(pairwise ~ Timepoint*Temperature*CO2), adjust = "tukey")
tukey.pacuta.counts.df <- as.data.frame(tukey.pacuta.counts$`pairwise differences of Timepoint, Temperature, CO2`)
write_xlsx(tukey.pacuta.counts.df, "Output/Statistics/Stress_statistics/Counts/Counts_Pacuta_TUKEY.xlsx")

# Tukey Mcap Stress
tukey.mcap.stress.counts <- emmeans(Mcap_counts_LMER2, list(pairwise ~ Timepoint*Temperature*CO2), adjust = "tukey")
tukey.mcap.stress.counts.df <- as.data.frame(tukey.mcap.stress.counts$`pairwise differences of Timepoint, Temperature, CO2`)
write_xlsx(tukey.mcap.stress.counts.df, "Output/Statistics/Stress_statistics/Counts/Counts_Mcap_TUKEY.xlsx")

# Tukey Mcap Recovery
tukey.mcap.rec.counts <- emmeans(Mcap_counts_LMER2, list(pairwise ~ Timepoint*Temperature*CO2), adjust = "tukey")
tukey.mcap.rec.counts.df <- as.data.frame(tukey.mcap.rec.counts$`pairwise differences of Timepoint, Temperature, CO2`)
write_xlsx(tukey.mcap.rec.counts.df, "Output/Statistics/Recovery_statistics/Counts_Mcap_recovery_TUKEY.xlsx")

spp.haemo.t <- t.test(haemo.cells.cm2~Species, data = counts.ttest)
capture.output(spp.haemo.t, file = "Output/Statistics/Stress_statistics/Counts_TTEST.txt")
```

### Species comparison 

```{r}
species.counts <- haemo %>% subset(Timepoint == "1 week") 
spp.counts.t <- t.test(haemo.cells.cm2~Species, data = species.counts)

capture.output(spp.counts.t, file = "Output/Statistics/Species_comparison/Counts.txt")
```


