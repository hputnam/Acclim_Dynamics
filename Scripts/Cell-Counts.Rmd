---
title: "Cell Counts"
author: "EL Strand"
date: "5/24/2021"
output: html_document
---

Code modified from R. Cunning, H. Putnam, and E5 group; link [here](https://github.com/urol-e5/timeseries/blob/master/timepoint_1/scripts/Sym-Density.Rmd).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages.
```{r}
rm(list=ls())

library(plyr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggpubr)
library(purrr)
library(Rmisc)
```

# Holobiont Integration sample processing 

## Loading meta data frames. 

```{r}
# Surface area data
sa <- read.csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>% select(Plug_ID, surface.area.cm2)
sa$Plug_ID <- as.character(sa$Plug_ID)

# Tissue homogenate volume data
homog_vols <- read_csv("Physiology_variables/homogenate_vol.csv") %>% select(Species, Plug_ID, vol_mL)
homog_vols$Plug_ID <- as.character(homog_vols$Plug_ID)

# Coral sample metadata
metadata <- read_csv("Environmental_data/Master_Fragment.csv") %>% select(Species, Plug_ID, Tank, Treatment, Temperature, CO2, Timepoint, ANALYSIS, Sample.Date) %>%
  subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular")
metadata$Plug_ID <- as.character(metadata$Plug_ID)

# Join homogenate volumes and surface area with sample metadata
metadata <- full_join(metadata, homog_vols) %>% full_join(sa) %>% filter(!is.na(vol_mL)) %>% 
  filter(!is.na(ANALYSIS)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))
```

## Import haemocytometer dataframe. 

```{r}
## Haemocytometer data 
haemo.raw <- read_csv("Physiology_variables/cell-counts/cell_counts.csv")
   haemo.raw$Plug_ID <- as.character(haemo.raw$Plug_ID)
```

## Calculate mean counts for both haemocytometer and cellometer.

### Haemocytometer

```{r}
# Calculate mean counts for each sample
haemo <- haemo.raw %>%
  select(Plug_ID, Squares_Counted, matches("Count[0-6]")) %>%
  gather("rep", "count", -Plug_ID, -Squares_Counted) %>% filter(!is.na(count)) %>%
  dplyr::group_by(Plug_ID) %>% 
  mutate(count.mean = mean(count))

# Join mean counts with sample metadata
haemo <- full_join(haemo, metadata) 

# Normalize counts by homogenate volume and surface area
haemo <- haemo %>%
  mutate(cells.mL = count.mean * 10000 / Squares_Counted,
         cells = cells.mL * vol_mL,
         haemo.cells.cm2 = cells / surface.area.cm2)

haemo <- haemo %>% filter(!is.na(haemo.cells.cm2))
haemo$Timepoint <- factor(haemo$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))
```

Calculate means from each timepoint and group. 
```{r}
count.means <- summarySE(haemo, measurevar = c("haemo.cells.cm2"), groupvars = c("Treatment", "Timepoint", "Species"))
```


```{r}
cols <- c("lightblue", "blue", "pink", "red")

cellcounts_plot <- ggplot(count.means, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=haemo.cells.cm2-se, ymax=haemo.cells.cm2+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black")); cellcounts_plot

ggsave(file="Output/Cell_counts.pdf", cellcounts_plot, width = 15, height = 10, units = c("in"))
```

