---
title: "Cell Counts"
author: "EL Strand"
date: "5/24/2021"
output: html_document
---

Code modified from R. Cunning, H. Putnam, and E5 group; link [here](https://github.com/urol-e5/timeseries/blob/master/timepoint_1/scripts/Sym-Density.Rmd).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages.
```{r}
rm(list=ls())

library(plyr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggpubr)
library(purrr)
library(Rmisc)
library(lme4)
library(car)
library(sjPlot)
```


# Holobiont Integration sample processing 

## Loading meta data frames. 

```{r}
# Surface area data
sa <- read.csv("Physiology_variables/Respirometry/coral_surface_area.csv") %>% dplyr::rename(Plug_ID = Sample_ID) %>% select(Plug_ID, surface.area.cm2)
sa$Plug_ID <- as.character(sa$Plug_ID)

# Tissue homogenate volume data
homog_vols <- read_csv("Physiology_variables/homogenate_vol.csv") %>% select(Species, Plug_ID, vol_mL)
homog_vols$Plug_ID <- as.character(homog_vols$Plug_ID)

# Coral sample metadata
metadata <- read_csv("Environmental_data/Master_Fragment.csv") %>% select(Species, Plug_ID, Tank, Treatment, Temperature, CO2, Timepoint, ANALYSIS, Sample.Date) %>%
  subset(ANALYSIS=="Physiology" | ANALYSIS=="Physiology/Molecular")
metadata$Plug_ID <- as.character(metadata$Plug_ID)

# Join homogenate volumes and surface area with sample metadata
metadata <- full_join(metadata, homog_vols) %>% full_join(sa) %>% filter(!is.na(vol_mL)) %>% 
  filter(!is.na(ANALYSIS)) %>%
  mutate(Species = case_when(
    Species == "Mcapitata" ~ "Montipora capitata",
    Species == "Pacuta" ~ "Pocillopora acuta"
  ))
```

## Import haemocytometer dataframe. 

```{r}
## Haemocytometer data 
haemo.raw <- read_csv("Physiology_variables/cell-counts/cell_counts.csv")
   haemo.raw$Plug_ID <- as.character(haemo.raw$Plug_ID)
```

## Calculate counts for haemocytometer counts

```{r}
# Calculate mean counts for each sample
haemo <- haemo.raw %>%
  select(Plug_ID, Squares_Counted, matches("Count[0-6]")) %>%
  gather("rep", "count", -Plug_ID, -Squares_Counted) %>% filter(!is.na(count)) %>%
  dplyr::group_by(Plug_ID) %>% 
  mutate(count.mean = mean(count))

# Join mean counts with sample metadata
haemo <- full_join(haemo, metadata) 

# Normalize counts by homogenate volume and surface area
haemo <- haemo %>%
  mutate(cells.mL = count.mean * 10000 / Squares_Counted,
         cells = cells.mL * vol_mL,
         haemo.cells.cm2 = cells / surface.area.cm2)

haemo <- haemo %>% filter(!is.na(haemo.cells.cm2))
haemo$Timepoint <- factor(haemo$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week","12 week","16 week"))

haemo %>%
  write_csv(., file = "Output/cell_counts.csv")
```

## Checking distribution and variation.
```{r}
cols <- c("lightblue", "blue", "pink", "red")

ggplot(haemo, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) + 
  facet_grid(Species ~Treatment) + theme_classic() + geom_point() + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3))

# plug IDs that had above 1 million cells per cm2; double check that these counts and the variation looks OK
above <- haemo %>% filter(haemo.cells.cm2 > 1500000) %>% select(Plug_ID) %>% distinct()
# 2 more counts on M2867 and M2876

week6ATHC <- haemo %>% subset(Treatment == "ATHC" & Species == "Montipora capitata" & Timepoint == "6 week")
week4HTAC <- haemo %>% subset(Treatment == "HTAC" & Species == "Montipora capitata" & Timepoint == "4 week")
```



## Calculate means from each timepoint and group. 

```{r}
count.means <- summarySE(haemo, measurevar = c("haemo.cells.cm2"), groupvars = c("Treatment", "Timepoint", "Species"))

count.means <- count.means %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2" & !Timepoint == "12 week" & !Timepoint == "16 week") %>% filter(N > 12) # N is higher because grouping number of counts in previous dataframe. mean here is still mean of the pop where each individual has an average count of six counts

count.means.full <- count.means %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2") 
```

## Visualize data 

```{r}
cellcounts_plot <- ggplot(count.means, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=haemo.cells.cm2-se, ymax=haemo.cells.cm2+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("") + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  theme(legend.position = "none") +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  axis.line = element_line(colour = "black")); cellcounts_plot # Change axis line

ggsave(file="Output/Final_figures/Cell_counts.png", cellcounts_plot, width = 11, height = 6, units = c("in"))

cellcounts_plot_full <- ggplot(count.means.full, aes(x=Timepoint, y = haemo.cells.cm2, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=haemo.cells.cm2-se, ymax=haemo.cells.cm2+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("") + 
  theme_classic() + 
  ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  theme(legend.position = "none") +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  axis.line = element_line(colour = "black")); cellcounts_plot # Change axis line

ggsave(file="Output/Final_figures/Cell_counts_full.png", cellcounts_plot_full, width = 11, height = 6, units = c("in"))
```

## Statistics 

Subsetting into time points 

```{r}
mcap.counts <- haemo %>% subset(Species == "Montipora capitata") %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

mcap.counts.recovery <- haemo %>% subset(Species == "Montipora capitata") %>% subset(Timepoint == "12 week" | Timepoint == "16 week")

pacuta.counts <- haemo %>% subset(Species == "Pocillopora acuta") %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

hist(mcap.counts$haemo.cells.cm2) 
hist(pacuta.counts$haemo.cells.cm2) 
hist(mcap.counts.recovery$haemo.cells.cm2) 

counts.ttest <- union(mcap.counts, pacuta.counts)
```

Model selection 

```{r}
Pacuta_counts_LMER <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta.counts) 
Mcap_counts_LMER <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=mcap.counts) 
Mcap_counts_recovery_LMER <- lmer(log(haemo.cells.cm2) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=mcap.counts.recovery) 

qqPlot(residuals(Pacuta_counts_LMER)) 
qqPlot(residuals(Mcap_counts_LMER)) 
qqPlot(residuals(Mcap_counts_recovery_LMER)) 

hist(residuals(Pacuta_counts_LMER)) 
hist(residuals(Mcap_counts_LMER)) 
hist(residuals(Mcap_counts_recovery_LMER)) 

## Type III Wald chisquare tests
pacuta.counts.anova <- Anova(Pacuta_counts_LMER, ddf="lme4", type='III') 
mcap.counts.anova <- Anova(Mcap_counts_LMER, ddf="lme4", type='III') 
mcap.counts.recovery.anova <- Anova(Mcap_counts_recovery_LMER, ddf="lme4", type='III') 

tab_model(Pacuta_counts_LMER, Mcap_counts_LMER, Mcap_counts_recovery_LMER,
          dv.labels = c("P.acuta cell counts", "M. cap cell counts stress", "Mcap counts recovery"), string.ci = "Conf. Int (95%)",
          string.p = "P-Value", file = "Output/Statistics/Counts.doc")

capture.output(pacuta.counts.anova, file = "Output/Statistics/Stress_statistics/Counts_Pacuta.txt")
capture.output(mcap.counts.anova, file = "Output/Statistics/Stress_statistics/Counts_Mcap.txt")
capture.output(mcap.counts.recovery.anova, file = "Output/Statistics/Recovery_statistics/Counts_Mcap_recovery.txt")

spp.haemo.t <- t.test(haemo.cells.cm2~Species, data = counts.ttest)
capture.output(spp.haemo.t, file = "Output/Statistics/Stress_statistics/Counts_TTEST.txt")
```


