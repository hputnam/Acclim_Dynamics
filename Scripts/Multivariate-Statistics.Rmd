---
title: "Statistics.Rmd"
author: "EL Strand"
date: "2/11/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

Loading libraries. 
```{r}
library(ggplot2)
library(tidyverse)
library(plyr)
library(dplyr)
library(mgcv) # GAM function
library(ggfortify)
library(devtools)
install_github("vqv/ggbiplot")
library(lme4)
library(gridExtra)
library(vegan)
library(effects)
library(Rmisc)
library(lmerTest)
library(lessR)
library(car)
library(cowplot)
library(corrplot)
library(factoextra)
library(MuMIn)
library(broom)
```

### Read in data files to analyze. 

```{r}
Master <- read.csv("Environmental_data/Master_Fragment.csv") %>% select(Site.Name, Plug_ID, Species, ANALYSIS, Timepoint, Treatment, Tank, Temperature, CO2) %>%
  filter(ANALYSIS == "Physiology" | ANALYSIS == "Physiology/Molecular")
  
Photo.Resp <- read.csv("Physiology_variables/Respirometry/Output/Resp_AllRates.csv") %>% select(Fragment.ID.x, Pnet_umol.cm2.hr, Rdark_umol.cm2.hr, Pgross_umol.cm2.hr) %>%
  dplyr::rename(Plug_ID = Fragment.ID.x)
  Photo.Resp$Plug_ID <- gsub("P-", "", Photo.Resp$Plug_ID)
  Photo.Resp$Plug_ID <- gsub("M-", "", Photo.Resp$Plug_ID)
  Photo.Resp <- Photo.Resp %>% separate(Plug_ID, c("Plug_ID", "Date")) %>% select(-Date)

Chlorophyll <-  read.csv("Output/chlorophyll.csv") %>% select(Plug_ID, chla.ug.cm2, chlc2.ug.cm2)
Biomass <- read.csv("Output/Tissue_Biomass.csv")
Protein <- read.csv("Output/soluble_protein.csv") %>% select(Plug_ID, prot_mg.cm2)
Antioxidant <- read.csv("Output/antioxidant.csv") %>% select(Plug_ID, cre.umol.mgprot)
Counts <- read.csv("Output/cell_counts.csv") %>% select(Plug_ID, haemo.cells.cm2)

# come back to adding Color.Score and Growth back in and subsetting for where all three timepoint columns match 
# joining all datasets together, reshaping the AFDW partner into columns, renaming those columns, removing an NA column, and calculating S:H AFDW ratio
data <- join_all(list(Master, Photo.Resp, Chlorophyll, Biomass, Protein, Antioxidant, Counts), by='Plug_ID', type='left')
data$Timepoint <- factor(data$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week", "12 week", "16 week"))

data <- data %>% 
  write_csv(., file = "Output/results_physiology.csv")
```

### Subsetting data 
```{r}
# Subsetting to the stress timepoints with all variables
pca_data <- data[complete.cases(data), ] # only taking rows where all samples have data

# Removing respiration and photosynthesis to keep the recovery timepoints 
subsetted.data.noresp <- data %>% select(-Pnet_umol.cm2.hr, -Rdark_umol.cm2.hr, -Pgross_umol.cm2.hr)
subsetted.data.noresp.pca <- subsetted.data.noresp[complete.cases(subsetted.data.noresp), ] 

# Stress and recovery split by species 
Mcap.full.pca <- subsetted.data.noresp.pca %>% subset(Species == "Mcapitata")
Pacuta.full.pca <- subsetted.data.noresp.pca %>% subset(Species == "Pacuta")

# Stress time period split by species 
Mcap.stress.pca <- pca_data %>% subset(Species == "Mcapitata")
Pacuta.stress.pca <- pca_data %>% subset(Species == "Pacuta")
```

# Multivariate analysis 

## PCA dataframes and color choices 
```{r}
## Principal components on each data with center and scaling
Mcap_scaled_full_data <- prcomp(Mcap.full.pca[c(10:17)], scale=TRUE, center=TRUE) # columns 10-17 are the data values
Pacuta_scaled_full_data <- prcomp(Pacuta.full.pca[c(10:17)], scale=TRUE, center=TRUE) # columns 10-17 are the data values

Pacuta_scaled_stress_data <- prcomp(Pacuta.stress.pca[c(10:20)], scale=TRUE, center=TRUE) # columns 10-20 are the data values
Mcap_scaled_stress_data <- prcomp(Mcap.stress.pca[c(10:20)], scale=TRUE, center=TRUE) # columns 10-20 are the data values

## Screeplots
Pacuta_full_cov <- cov(Pacuta.full.pca[,c(10:17)])
Mcap_full_cov <- cov(Mcap.full.pca[,c(10:17)])
Pacuta_stress_cov <- cov(Pacuta.stress.pca[c(10:20)])
Mcap_stress_cov <- cov(Mcap.stress.pca[c(10:20)])

Pacuta_full_eigen <- eigen(Pacuta_full_cov)
Mcap_full_eigen <- eigen(Mcap_full_cov)
Pacuta_stress_eigen <- eigen(Pacuta_stress_cov)
Mcap_stress_eigen <- eigen(Mcap_stress_cov)

plot(Pacuta_full_eigen$values, xlab = 'Eigenvalue Number', ylab = 'Eigenvalue Size', main = 'Scree Graph') +   lines(Pacuta_full_eigen$values)
plot(Mcap_full_eigen$values, xlab = 'Eigenvalue Number', ylab = 'Eigenvalue Size', main = 'Scree Graph') +   lines(Mcap_full_eigen$values)
plot(Pacuta_stress_eigen$values, xlab = 'Eigenvalue Number', ylab = 'Eigenvalue Size', main = 'Scree Graph') +   lines(Pacuta_stress_eigen$values)
plot(Mcap_stress_eigen$values, xlab = 'Eigenvalue Number', ylab = 'Eigenvalue Size', main = 'Scree Graph') +   lines(Mcap_stress_eigen$values)
```

## Plotting PCAs

Means of each group's PC1
```{r}
Mcapitata.full.means <- Mcap_scaled_full_data %>%
  augment(Mcap.full.pca) %>% # add original dataset back in
  group_by(Timepoint, Temperature) %>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2)) %>% select(-.fittedPC4, -.fittedPC5, -.fittedPC6)

```

Mcap all treatments. 
```{r}

```



Mcap just temperature figures. 
```{r}
mcap.high.segments <- Mcapitata.full.means %>% subset(Temperature == "High") %>%
  select(Timepoint, Temperature, PC1.mean, PC2.mean) %>%
  gather(variable, value, -(Timepoint:Temperature)) %>%
  unite(group, Timepoint, variable) %>% distinct() %>%
  spread(group, value)

mcap.amb.segments <- Mcapitata.full.means %>% subset(Temperature == "Ambient") %>%
  select(Timepoint, Temperature, PC1.mean, PC2.mean) %>%
  gather(variable, value, -(Timepoint:Temperature)) %>%
  unite(group, Timepoint, variable) %>% distinct() %>%
  spread(group, value)

Mcapitata.all.fig <- ggplot(Mcapitata.full.means, aes(.fittedPC1, .fittedPC2, color = Temperature)) + 
  geom_segment(aes(x = `Day 1_PC1.mean`, y = `Day 1_PC2.mean`, xend = `Day 2_PC1.mean`, yend = `Day 2_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE) + # Day 1 to Day 2 HIGH
  geom_segment(aes(x = `Day 2_PC1.mean`, y = `Day 2_PC2.mean`, xend = `2 week_PC1.mean`, yend = `2 week_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE) + # Day 2 to 2 week HIGH
  geom_segment(aes(x = `2 week_PC1.mean`, y = `2 week_PC2.mean`, xend = `4 week_PC1.mean`, yend = `4 week_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE) + # 2 week to 4 week HIGH
  geom_segment(aes(x = `4 week_PC1.mean`, y = `4 week_PC2.mean`, xend = `6 week_PC1.mean`, yend = `6 week_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE) + # 4 week to 6 week HIGH
  geom_segment(aes(x = `6 week_PC1.mean`, y = `6 week_PC2.mean`, xend = `8 week_PC1.mean`, yend = `8 week_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE) + # 6 week to 8 week HIGH
  geom_segment(aes(x = `8 week_PC1.mean`, y = `8 week_PC2.mean`, xend = `12 week_PC1.mean`, yend = `12 week_PC2.mean`, colour = Temperature), data = mcap.high.segments, size=1, show.legend=FALSE, arrow = arrow()) + # 8 week to 12 week HIGH
  geom_segment(aes(x = `Day 2_PC1.mean`, y = `Day 2_PC2.mean`, xend = `2 week_PC1.mean`, yend = `2 week_PC2.mean`, colour = Temperature), data = mcap.amb.segments, size=1, show.legend=FALSE) + # Day 2 to 2 week AMB
  geom_segment(aes(x = `2 week_PC1.mean`, y = `2 week_PC2.mean`, xend = `4 week_PC1.mean`, yend = `4 week_PC2.mean`, colour = Temperature), data = mcap.amb.segments, size=1, show.legend=FALSE) + # 2 week to 4 week AMB
  geom_segment(aes(x = `4 week_PC1.mean`, y = `4 week_PC2.mean`, xend = `8 week_PC1.mean`, yend = `8 week_PC2.mean`, colour = Temperature), data = mcap.amb.segments, size=1, show.legend=FALSE) + # 4 week to 8 week AMB
  geom_segment(aes(x = `8 week_PC1.mean`, y = `8 week_PC2.mean`, xend = `12 week_PC1.mean`, yend = `12 week_PC2.mean`, colour = Temperature), data = mcap.amb.segments, size=1, show.legend=FALSE, arrow = arrow()) + # 8 week to 12 week AMB
  geom_point(size = 1.5, alpha=0.3) +
  geom_point(aes(x=PC1.mean, y=PC2.mean)) +
  geom_text(aes(PC1.mean, PC2.mean, label=Timepoint), vjust=-1.5, color="black") +
  theme_half_open(12) + background_grid() +
  ggtitle("Montipora capitata") + 
  theme(legend.position = c(0.8, 0.9)) +
  theme(plot.title = element_text(face = 'bold.italic', size = 14, hjust = 0)) +
  theme(legend.title = element_text(size=12, face="bold")) +
  scale_color_manual(values = c("deepskyblue", "firebrick1"), aesthetics = c("colour"))  
  #xlab("PC1 47%") + ylab("PC2 21%"); Mcapitata.all.fig 
```



```{r}
line.cols <- c("lightblue", "blue", "salmon", "red3", "lightblue", "blue", "salmon", "red3")
fill.cols <- c("white", "white", "white", "white", "lightblue", "blue", "salmon", "red3")

autoplot(Mcap_scaled_full_data, data = Mcap.full.pca, colour = 'Treatment', shape = "Timepoint",
         loadings = TRUE, loadings.colour = 'black', size=1, loadings.label = TRUE, 
         loadings.label.size = 3, loadings.label.colour = 'black', loadings.label.vjust=-1,
         frame=TRUE, frame.type = 'norm') + theme_bw() +
  scale_color_manual(values = line.cols) + scale_fill_manual(values = fill.cols) + ggtitle("M. capitata")
```



## Plotting stress timepoints. 
```{r}
# Choosing colors for PCA 
line.cols <- c("lightblue", "blue", "salmon", "red3", "lightblue", "blue", "salmon", "red3")
fill.cols <- c("white", "white", "white", "white", "lightblue", "blue", "salmon", "red3")

Mcap_group <- autoplot(Mcap_scaled_data, data = Mcap_data, colour = 'Group', shape = "Phase",
         loadings = TRUE, loadings.colour = 'black', size=1, loadings.label = TRUE, 
         loadings.label.size = 3, loadings.label.colour = 'black', loadings.label.vjust=-1,
         frame=TRUE, frame.type = 'norm') + theme_bw() +
  scale_color_manual(values = line.cols) + scale_fill_manual(values = fill.cols) + ggtitle("M. capitata"); Mcap_group

Pacuta_group <- autoplot(Pacuta_scaled_data, data = Pacuta_data, colour = 'Group', shape = "Phase", frame=TRUE, frame.type = 'norm',
         loadings = TRUE, loadings.colour = 'black', size=1, loadings.label = TRUE, 
         loadings.label.size = 3, loadings.label.colour = 'black', loadings.label.vjust=-1) + 
  theme(legend.position = "top") +
  theme_bw() + scale_color_manual(values = line.cols) + scale_fill_manual(values = fill.cols) + ggtitle("P. acuta"); Pacuta_group

Stress.PCAs <- arrangeGrob(Mcap_group, Pacuta_group, ncol=1)
ggsave(file="Output/Final_Figures/PCA-stress.pdf", Stress.PCAs, width = 8, height = 10, units = c("in"))
ggsave(file="Output/Final_Figures/PCA-stress.png", Stress.PCAs, width = 8, height = 10, units = c("in"))
```

## Plotting timeseries with recovery timepoints. 
```{r}
# Choosing colors for PCA 
time.line.cols <- c("lightblue", "blue", "salmon", "red3", "lightblue", "blue", "salmon", "red3", "lightblue", "blue", "salmon", "red3")
time.fill.cols <- c("white", "white", "white", "white", "lightblue", "blue", "salmon", "red3", "dodgerblue2", "navyblue", "firebrick3", "darkred")
plines.cols <- c("lightblue", "blue", "salmon", "red3", "lightblue", "blue", "salmon", "red3", "lightblue", "blue")
pfill.cols <- c("white", "white", "white", "white", "lightblue", "blue", "salmon", "red3", "dodgerblue2", "navyblue")
  
Pacuta_timeseries <- autoplot(Pacuta_scaled_timeseriesdata, data = Pacuta_timeseriesdata, colour = 'Group', shape = "Phase",
         loadings = TRUE, loadings.colour = 'black', size=1, loadings.label = TRUE, frame=TRUE, frame.type = 'norm',
         loadings.label.size = 3, loadings.label.colour = 'black', loadings.label.vjust=-1) + 
  theme_bw() + scale_color_manual(values = plines.cols) + scale_fill_manual(values = pfill.cols) + ggtitle("P. acuta"); Pacuta_timeseries

Mcap_timeseries <- autoplot(Mcap_scaled_timeseriesdata, data = Mcap_timeseriesdata, colour = 'Group', shape = "Phase",
         loadings = TRUE, loadings.colour = 'black', size=1, loadings.label = TRUE, 
         loadings.label.size = 3, loadings.label.colour = 'black', loadings.label.vjust=-1,
         frame=TRUE, frame.type = 'norm') + theme_bw() +
  scale_color_manual(values = time.line.cols) + scale_fill_manual(values = time.fill.cols) + ggtitle("M. capitata"); Mcap_timeseries

Timeseries.PCAs <- arrangeGrob(Mcap_timeseries, Pacuta_timeseries, ncol=1)
ggsave(file="Output/Final_Figures/PCA-timeseries.pdf", Timeseries.PCAs, width = 8, height = 10, units = c("in"))
ggsave(file="Output/Final_Figures/PCA-timeseries.png", Timeseries.PCAs, width = 8, height = 10, units = c("in"))
```


## PERMANOVA Analysis 

For P. acuta and M. cap. timeseries (without resp and photo). 
```{r}
## Pacuta - effect of treatment and timepoint
# scale data
pacuta_timeseries_vegan <- scale(Pacuta_timeseriesdata[ ,10:16])
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(pacuta_timeseries_vegan ~ Timepoint*Temperature*CO2, data = Pacuta_timeseriesdata, method='eu')
adonis(pacuta_timeseries_vegan ~ Phase*Temperature*CO2, data = Pacuta_timeseriesdata, method='eu')

## Mcap - effect of treatment and timepoint
# scale data
mcap_timeseries_vegan <- scale(Mcap_timeseriesdata[ ,10:16])
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(mcap_timeseries_vegan ~ Timepoint*Temperature*CO2, data = Mcap_timeseriesdata, method='eu')
adonis(mcap_timeseries_vegan ~ Phase*Temperature*CO2, data = Mcap_timeseriesdata, method='eu')
```

