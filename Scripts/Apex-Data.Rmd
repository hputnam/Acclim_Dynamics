---
title: "Apex-Data.Rmd"
author: "Emma Strand"
date: "6/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(janitor)
library(Rmisc)
library(scales)
```

### APEX TEMPERATURE AND pH DATA ### 

'Download1' = 0922, 0923, 0924.  
'Download2' = 0925 - 1119.   
These are kept separately because the files are formatted differently. 

```{r}
# read in tank to treatment values to bind dataframes together later on 
Trt.Tanks <- read.csv('Environmental_data/Tank_to_Treatment.csv') %>% select(-Tank.Name)
Trt.Tanks$Tank <- as.character(Trt.Tanks$Tank)

# binding all apex data files together. see above note about some need to be loaded differently
APEX.data1 <- list.files(path = 'Environmental_data/Apex_continuous_data/Download1', pattern = ".csv", full.names = TRUE) %>% # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.table, .id = "file.ID", header=FALSE, sep=",") %>% # join all files together in one data frame by file ID
  dplyr::group_by(file.ID) %>% # for each file do the following
  select(-V1) %>% 
  row_to_names(row_number=1) %>% rename(file.ID = "Environmental_data/Apex_continuous_data/Download1/Experimental_0922.csv") %>%
  filter(Date.Time != "Date.Time")

APEX.data2 <- list.files(path = 'Environmental_data/Apex_continuous_data/Download2', pattern = ".csv", full.names = TRUE) %>% # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.table, .id = "file.ID", header=FALSE, sep=",") %>% # join all files together in one data frame by file ID
  group_by(file.ID) %>% # for each file do the following
  select(-V1) %>%
  row_to_names(row_number=1) %>% rename(file.ID = "Environmental_data/Apex_continuous_data/Download2/Experimental_0925_0926.csv") %>%
  filter(Date.Time != "Date.Time")

# Changing format of the date and time column to be in POSIXct and UTC timezone.  
APEX.data1$Date.Time <- as.POSIXct(APEX.data1$Date.Time, tz="UTC")
APEX.data2$Date.Time <- as.POSIXct(APEX.data2$Date.Time, tz="UTC")

APEX.data <- APEX.data2[,c(1, 27, 20, 21, 12, 13, 16, 17, 25, 26, 6, 7, 18, 19, 22, 23, 10, 11, 4, 5, 14, 15, 8, 9, 2, 3, 24)]
APEX.data$Date.Time <- as.POSIXct(APEX.data$Date.Time, tz="UTC")

APEX.data <- union(APEX.data1, APEX.data)
```

Subsetting dataframes by stressor and calculating means. 
```{r}
## Creating temp and pH data frames, changing the format to be labeled by tank in one column and pH value in the other
apex.temperature <- APEX.data %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-17 08:00:00", tz="UTC"))) %>%
  select(Date.Time, contains("Tmp"))
colnames(apex.temperature) <- gsub("Tmp_","",colnames(apex.temperature))
apex.temperature <- gather(apex.temperature, "Tank", "Temperature", 3:14)

apex.pH <- APEX.data %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-17 08:00:00", tz="UTC"))) %>%
  select(Date.Time, contains("pH"))
colnames(apex.pH) <- gsub("pH_","",colnames(apex.pH))
apex.pH <- gather(apex.pH, "Tank", "pH", 3:14)

# Adding in treatment information
apex.temperature <- full_join(apex.temperature, Trt.Tanks, by = "Tank")
apex.pH <- full_join(apex.pH, Trt.Tanks, by = "Tank")

## Creating new date and time columns
apex.temperature$Date <- as.Date(apex.temperature$Date.Time)
apex.temperature$Time <- format(apex.temperature$Date.Time, "%H %M %S")
apex.temperature$Temperature <- as.numeric(apex.temperature$Temperature)

apex.pH$Date <- as.Date(apex.pH$Date.Time)
apex.pH$Time <- format(apex.pH$Date.Time, "%H %M %S")
apex.pH$pH <- as.numeric(apex.pH$pH)

## Averaging by date and treatment
apex.temp.avg.date <- summarySE(apex.temperature, measurevar = "Temperature", groupvars=c("Date", "Treatment")) #N, mean(Temperature), sd, se, ci
apex.pH.avg.date <- summarySE(apex.pH, measurevar = "pH", groupvars=c("Date", "Treatment")) #N, mean(Temperature), sd, se, ci

apex.date <- full_join(apex.temp.avg.date, apex.pH.avg.date)

## Averaging by treatment 
apex.temp.avg.trt <- summarySE(apex.temperature, measurevar = "Temperature", groupvars=c("Treatment")) 
apex.pH.avg.trt <- summarySE(apex.pH, measurevar = "pH", groupvars=c("Treatment")) 

apex.treatment <- full_join(apex.temp.avg.trt, apex.pH.avg.trt)

# Exporting hobo logger tables
write_csv(path = "Environmental_data/Apex-Temperature-Treatment.csv", apex.temp.avg.trt)
write_csv(path = "Environmental_data/Apex-pH-Treatment.csv", apex.pH.avg.trt)

write_csv(path = "Environmental_data/Apex-Temperature-Date.csv", apex.temp.avg.date)
write_csv(path = "Environmental_data/Apex-pH-Date.csv", apex.pH.avg.date)
```

Plotting 
```{r}
colors <- c("lightblue", "blue", "salmon", "red3")

apex.temperature.plot <- apex.temperature %>% filter(Temperature > 20)

APEX.TEMP.PLOT <- ggplot(data = apex.temperature.plot, aes(x = Date.Time, y = Temperature, color = Treatment)) +
  labs(x = "Date", y = "Temperature") + ggtitle("Apex Temperature Sensor") +
  geom_line() +
  scale_color_manual(values = colors) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "2 days", labels = date_format("%d %b")) +
  theme(legend.position="right", legend.background = element_blank()); APEX.TEMP.PLOT 

apex.pH.plot <- apex.pH %>% filter(pH < 9 & pH > 5.5)

APEX.pH.PLOT <- ggplot(data = apex.pH.plot, aes(x = Date.Time, y = pH, color = Treatment)) +
  labs(x = "Date", y = "pH") + ggtitle("Apex pH Sensor") +
  geom_line() +
  scale_color_manual(values = colors) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "2 days", labels = date_format("%d %b")) +
  theme(legend.position="right", legend.background = element_blank()); APEX.pH.PLOT 

ggsave(filename = "Output/Apex-pH.png", APEX.pH.PLOT, device = "png", width = 11, height = 8)
ggsave(filename = "Output/Apex-temp.png", APEX.TEMP.PLOT, device = "png", width = 11, height = 8)

```

Subsetting to one day to demonstrate daily fluctuation.

Starting with `apex.pH.plot` dataframe.

```{r}
dark.colors <- c("blue", "lightblue", "salmon", "red3")

apex.pH.daily <- apex.pH.plot #%>% subset(Date == "2018-10-07")
apex.pH.daily <- apex.pH.daily %>% separate(Date.Time, c("Date", "Time"), sep = " ", remove = FALSE) 
apex.pH.daily.mean <- summarySE(apex.pH.daily, measurevar = c("pH"), groupvars = c("Time", "Treatment"))

daily.plot <- ggplot(data = apex.pH.daily.mean, aes(x = Time, y = pH, color = Treatment)) +
  labs(x="", y = "pH NBS scale") +
  geom_point(size=1) +
  scale_color_manual(values = dark.colors) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  #scale_x_datetime(date_breaks = "2 hours", labels = date_format("%h %m")) +
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 17)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(legend.position="none", legend.background = element_blank()); daily.plot

ggsave(filename = "Output/Manuscript_figures/Apex-daily-pH-plot-mean-alldays.png", daily.plot, device = "png", width = 5, height = 3)
```


### LIGHT DATA ### 

Decide if want to visualize/statistically analyze the positions the readings were taken in (6 points in each tank)

Reading in both light data files. 
The PAR sensor was only in one tank so we only need to subset our Apex_data frame to one tank. 
```{r}
Licor_Light <- read.csv('data/Environmental/Discrete_Light_Licor193.csv', sep=",")

Light_tank_info <-read.csv('data/Environmental/Tank_to_Treatment.csv', header=T, sep=",") %>% select(-Tank.Name)
Licor_Light <- merge(Licor_Light, Light_tank_info, by="Tank") 
Licor_Light$Tank <- as.character(Licor_Light$Tank) # changing Tank values to character instead of numeric
```

Visualizing Apex light data. 
```{r}
# Changing character vector to numeric for PAR
# Filtering to experimental timeperiod 
APEX.data$PAR <- as.numeric(APEX.data$PAR)
APEX.PAR <- APEX.data %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-17 08:00:00", tz="UTC"))) %>% select(Date.Time, PAR)

write_csv(path = "Environmental_data/Apex-PAR.csv", APEX.PAR)

PAR.plot <- ggplot(APEX.PAR, aes(x=Date.Time, y = PAR)) + 
  geom_point(size=0.2) + theme_bw() +
  scale_y_continuous(limits = c(0, 850), breaks = seq(0, 850, by = 50)) +
  theme_classic() +
  xlab("Date") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + # x-axis label and rotating text on x axis
  ylab("PAR"); PAR.plot # y-axis label 

ggsave(filename = "Output/Apex-PAR.png", PAR.plot, device = "png", width = 11, height = 8)
```

Testing if is there a significant difference between tank positions. 
```{r} 
library(lubridate)

Licor_LICOR193 <- Licor_Light %>% 
  #subset(Measure_Type=="Six-point") %>% 
  subset(Instrument=="LICOR-193") %>% 
  select(-Notes, -Instrument) %>%
  filter(!is.na(PAR))

Licor_means <- summarySE(Licor_LICOR193, measurevar="PAR", groupvars=c("Treatment"))

Treatment_PAR <- aov(PAR ~ Treatment, data = Licor_LICOR193)
TRT_TK_PAR <- aov(PAR ~ Treatment*Tank, data = Licor_LICOR193)
summary(TRT_TK_PAR)

Light_model <- lmer(log(PAR) ~ Treatment + (1|Date) + (1|Tank), na.action=na.omit, data=Licor_LICOR193) 
qqPlot(residuals(Light_model)) 
hist(residuals(Light_model)) 
Light_model_anova <- Anova(Light_model, ddf="lme4", type='III') 

light.tukey <- emmeans(Light_model, list(pairwise ~ Treatment), adjust = "tukey")
light.tukey.df <- as.data.frame(light.tukey$`pairwise differences of Treatment`)
light.tukey.df %>% filter(p.value < 0.05)

### SIX VS ONE POINT
Licor_LICOR193_six <- Licor_LICOR193 %>%
  subset(Measure_Type == "Six-point")
Licor_six_means <- summarySE(Licor_LICOR193_six, measurevar="PAR", groupvars=c("Position", "Tank"))

summary(aov(PAR ~ Position*Tank, data = Licor_LICOR193_six))
```

Visualizing Licor light data. 
This includes six-point and one-point measurements, and both hand-held apogee and LICOR-193 instruments. 
```{r}
treatment_colors <- c("blue", "lightblue", "salmon", "red3")
tank_colors <- c("lightblue", "red3", "blue", "blue", "red3", "blue", "salmon", "red3", "lightblue", "salmon", "lightblue", "salmon")

## BY TREATMENT
light1 <- ggplot(Licor_LICOR193, aes(x=Treatment, y=PAR, fill=Treatment)) + 
  geom_boxplot() +
  scale_fill_manual(values = treatment_colors) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + 
  theme_classic() + 
  theme(legend.position="none", plot.title = element_text(size=11)) + 
  xlab("Treatment") + 
  ylab("PAR")

ggsave(filename = "output/Figures/LICOR-PAR.png", light1, device = "png", width = 9, height = 7)

## BY TREATMENT AND TANK
ggplot(Licor_LICOR193, aes(x=Tank, y=PAR, fill=Tank)) + 
  geom_boxplot() +
  scale_fill_manual(values = tank_colors) +
  scale_x_discrete(limits=c("1","6","8", "3", "11", "12", "4", "7", "9", "2", "5", "10")) + 
  geom_jitter(color="black", size=0.4, alpha=0.9) + 
  theme_classic() + 
  theme(legend.position="none", plot.title = element_text(size=11)) + 
  xlab("Tank Number") + 
  ylab("PAR")
```
