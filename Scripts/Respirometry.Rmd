---
title: "Respirometry"
author: "EL Strand"
date: "6/10/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

Load required packages. 
```{r,echo=T, results='hide'}
## Installing if package is not already downloaded
if ("devtools" %in% rownames(installed.packages()) == 'FALSE') install.packages('devtools') 
library(devtools)
if ("segmented" %in% rownames(installed.packages()) == 'FALSE') install.packages('segmented') 
if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("LoLinR" %in% rownames(installed.packages()) == 'FALSE') install_github('colin-olito/LoLinR') 
if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages('lubridate') 
if ("chron" %in% rownames(installed.packages()) == 'FALSE') install.packages('chron') 
if ("plyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('plyr') 
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr') 
if ("ggpubr" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggpubr') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggstatsplot') 
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 


## Read in libraries. 
install_github('colin-olito/LoLinR')
library("ggplot2")
library("segmented")
library("plotrix")
library("gridExtra")
library("LoLinR")
library("lubridate")
library("chron")
library('plyr')
library('dplyr')
library('stringr')
library('Rmisc')
library("ggpubr")
library("car")
library("ggstatsplot")
library("tidyverse")
```

# Load in respiration files and creating a blank data frame to be filled in by calculated data later on.  

```{r}
path.p <- "Physiology_variables/Respirometry/Raw_Data/" #the location of all your respirometry files 

file.names <- basename(list.files(path = path.p, pattern = "csv$", recursive = TRUE)) #list all csv file names in the folder and subfolders
#basename above removes the subdirectory name from the file

#generate a 3 column dataframe with specific column names
Photo.R <- data.frame(matrix(NA, nrow=length(file.names)*2, ncol=3)) 
colnames(Photo.R) <- c("Fragment.ID","Intercept", "umol.L.sec")

#add file names that include the subdirectory name
file.names.full <- list.files(path = path.p, pattern = "csv$", recursive = TRUE) #list all csv file names in the folder and subfolders
```

# Calculating respiration rates

```{r}
PR <- c('Photo', 'Resp')

for(i in 1:length(file.names.full)) { # for every file in list start at the first and run this following function
  Photo.Data1 <-read.table(file.path(path.p,file.names.full[i]), skip = 1, header=T, sep=",", na.string="NA", fill = TRUE, as.is=TRUE, fileEncoding="latin1") #reads in the data files
  Photo.Data1 <- Photo.Data1[with(Photo.Data1, order(Time)), ]
  Photo.Data1  <- Photo.Data1[,c(2,9,16)] #subset columns of interest
  n<-dim(Photo.Data1)[1] #identify length of data
  Photo.Data1 <-Photo.Data1[120:(n-3),] #start at data point ~2 minute in to avoid excess noise from start of run and remove last 3 lines containing text
  Photo.Data1$Time <- as.POSIXct(Photo.Data1$Time,format="%H:%M:%S", tz = "") #convert time from character to time
  Photo.Data1$x <- as.numeric(rownames(Photo.Data1))
  brk <- which(diff(Photo.Data1$Time) > 30) #look for breaks in time of x seconds or more
  brk <- Photo.Data1[brk,4]
  Photo <- subset(Photo.Data1, as.numeric(rownames(Photo.Data1)) < brk[1])  #subset by break in time stamp keeping everything before break
  Resp <- subset(Photo.Data1, as.numeric(rownames(Photo.Data1)) > brk[1]) #subset by break in time stamp keeping everything before break
  lt.levs <- list(Photo, Resp) #list levels of segmentation
  
  for(j in 1:length(lt.levs)){    
    Photo.Data <- as.data.frame(lt.levs[j])
    n<-dim(Photo.Data )[1] #identify length of data
    #Photo.Data <-Photo.Data [120:(n-3),] #start at data point ~2 minute in to avoid excess noise from start of run and remove last 3 lines containing text
    #n<-dim(Photo.Data )[1] #list length of trimmed data
    Photo.Data$sec <- 1:n #set seconds by one from start to finish of run
    
    #Save plot prior to and after data thinning to make sure thinning is not too extreme
    rename <- sub(".csv", "", file.names[i])
    pdf(paste0("Physiology_variables/Respirometry/Output/Data_thinning/",rename,"_",j,"thinning.pdf"))
    par(omi=rep(0.3, 4)) #set size of the outer margins in inches
    par(mfrow=c(1,2)) #set number of rows and columns in multi plot graphic
    plot(Value ~ sec, data=Photo.Data , xlab='Time (seconds)', ylab=substitute(' O'[2]~' (µmol/L)'), type='n', axes=FALSE) #plot data as a function of time
    usr  <-  par('usr')
    rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA)
    whiteGrid()
    box()
    points(Photo.Data$Value ~ Photo.Data $sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)
    axis(1)
    axis(2, las=1)
    
    #save original unthinned and thinned data figure for comparison
    thin <- 30
    alp <- 0.2
    Photo.Data.orig<-Photo.Data
    Photo.Data <-  thinData(Photo.Data ,by=thin)$newData1 #thin data by every x points for all the O2 values
    Photo.Data$sec <- as.numeric(rownames(Photo.Data)) #maintain numeric values for time
    Photo.Data$Temp<-NA
    Photo.Data$Temp <-  thinData(Photo.Data.orig,xy = c(1,3),by=thin)$newData1[,2] #thin data by every 20 points for the temp values
    
    plot(Value ~ sec, data=Photo.Data , xlab='Time (seconds)', ylab=substitute(' O'[2]~' (µmol/L)'), type='n', axes=FALSE) #plot thinned data
    usr  <-  par('usr') #plotting graphics using 'usr'
    rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA) #giving specific coordinates for plot using 'usr'
    whiteGrid()
    box()
    points(Photo.Data$Value ~ Photo.Data$sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)
    axis(1)
    axis(2, las=1)
    dev.off()
    
    ##Olito et al. 2017: It is running a bootstrapping technique and calculating the rate based on density
    Regs  <-  rankLocReg(xall=Photo.Data $sec, yall=Photo.Data $Value, alpha=alp, 
                         method="pc", verbose=TRUE) 
    pdf(paste0("Physiology_variables/Respirometry/Output/Regressions/",rename,"_",j,"regression.pdf"))
    plot(Regs)
    dev.off()
    
    s <- seq(0,nrow(Photo.R),length(lt.levs)) #to order the file output sequence in correct order in data frame
    Photo.R[j+s[i],2:3] <- Regs$allRegs[1,c(4,5)] #inserts slope and intercept in the dataframe
    Photo.R[j+s[i],1] <- rename #stores the file name in the Date column
    Photo.R[j+s[i],1] <- paste0(rename,"_",j) #stores the file name in the Date column
    Photo.R[j+s[i],4] <- mean(Photo.Data$Temp, na.rm=T)  #stores the Temperature in the Temp.C column
    Photo.R[j+s[i],5] <- PR[j] #stores whether it is photosynthesis or respiration
  }
}

write.csv(Photo.R, 'Physiology_variables/Respirometry/Output/Photo.R.csv')
```

# Reading the dataframe in to skip calculating all regressions each time. 

Start here once Photo.R dataframe is already made. 

```{r}
Photo.R <- read.csv(file="Physiology_variables/Respirometry/Output/Photo.R.csv", header=T) #read in volume and sample.info data
Photo.R <- Photo.R[,-1]

Photo.R$Fragment.ID <- str_sub(Photo.R$Fragment.ID, 1, str_length(Photo.R$Fragment.ID)-2) #Removing _1 or _2
```

Load sample info spreadsheet in and merge with Photo.R file. 
```{r}
#Load Sample Info
Sample.Info <- read.csv(file="Physiology_variables/Respirometry/Resp_DeltaTA_datasheet.csv", header=T) #read sample.info data
Sample.Info$Fragment.ID <- sub(".csv", "", Sample.Info$Fragment.ID)
Sample.Info$Blnk.Group <- paste(Sample.Info$Date, Sample.Info$Tank, Sample.Info$Light.or.Dark, sep = "_")
#Sample.Info$Merge.ID <- paste(Sample.Info$Fragment.ID, Sample.Info$Light.or.Dark, sep = "_") 

#Merge data with sample info
colnames(Photo.R) <- c("Fragment.ID", "Intercept","umol.L.sec", "Temp","Light.or.Dark" )
#Photo.R$Merge.ID <- paste(Photo.R$Fragment.ID, Photo.R$Light.or.Dark, sep = "_")
Data <- left_join(Photo.R,Sample.Info)

Data2 <-select(Data, c("Date","Timepoint","Date.Num","Species", "Treatment","Plug.ID","Tank", "Light.or.Dark","Vol.ml","Surface.Area","umol.L.sec"))
```

Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and remove per Liter.
```{r}
Data2$umol.sec <- Data2$umol.L.sec * (Data2$Vol.ml/1000)
Data2$Group <- paste(Data2$Date, Data2$Tank, Data2$Light.or.Dark, sep = "_")
```

Accounting for blank chamber rates. 
The blanks have to be specific to the response variable (i.e. photo or resp), tank, and timepoint 
```{r}
#Calculate Photo blank rate
blnk <- aggregate(umol.sec ~ Date*Species*Tank*Light.or.Dark, data=Data2, mean)
Blanks <- subset(blnk, Species == "Blank")
Blanks$Group <- paste(Blanks$Date, Blanks$Tank, Blanks$Light.or.Dark, sep = "_")
boxplot(Blanks$umol.sec ~ Blanks$Tank)

colnames(Blanks)[5] <- "Blank.umol.sec"
Data3 <- left_join(Data2, Blanks, by="Group")

#Account for blank rate Subtract Blank by the temperature blank
Data3$umol.sec.corr <- Data3$umol.sec - Data3$Blank.umol.sec
```

Normalize to surface area of the coral. 
```{r}
#normalize to surface area and h-1
Data3$umol.cm2.hr <- (Data3$umol.sec.corr*3600)/Data3$Surface.Area
```

Removing blanks from the dataset and exporting both respirometry and photosynthetic rates. 
```{r}
Photo <- subset(Data3, Light.or.Dark.x=="Photo")
Photo <- subset(Photo, Species.x!="Blank")
Resp <- subset(Data3, Light.or.Dark.x=="Resp")
Resp <- subset(Resp, Species.x!="Blank")

colnames(Resp)[20] <- "Rdark_umol.cm2.hr"
colnames(Photo)[20] <- "Pnet_umol.cm2.hr"

write.csv(Photo, file="Physiology_variables/Respirometry/Output/Photosynthesis.rates.csv")
write.csv(Resp, file="Physiology_variables/Respirometry/Output/Respiration.rates.csv")
```

Calculating gross photosynthesis (Pnet -  negative Rdark)
```{r}
#merge desired columns by id
resp.data <- left_join(Photo,Resp, by="Plug.ID")

# calculating Pgross
resp.data$Pgross_umol.cm2.hr <- resp.data$Pnet_umol.cm2.hr - resp.data$Rdark_umol.cm2.hr
```

The following corals have been lost in transit from HI to RI or in a freezer in either location. 
```{r}
# Taking out the missing P. acuta fragments
Missing.list <- c("2976", "3003", "2008", "2512", "2528", "2740", "1603", "2200", "2880", "2752", "25223", "2523", "2981", "2984", "1739", "2859")
Missing.list <- as.list(Missing.list)
Present <- resp.data[!grepl(paste(Missing.list, collapse = "|"), resp.data$Plug.ID),]

Present$PR <- Present$Pnet_umol.cm2.hr/(abs(Present$Rdark_umol.cm2.hr))

## Taking out the one P:R ratio that is 124... the next highest is 15
Present <- Present %>% filter(PR < 20)

#convert to long format
Present.long <- pivot_longer(Present, cols = c("Pnet_umol.cm2.hr","Pgross_umol.cm2.hr","Rdark_umol.cm2.hr", "PR")) %>%
  dplyr::rename(Measurement = name)

Present.DS <-  Present.long %>%
                group_by(Date.Num.x,Species.x.x,Treatment.x, Measurement) %>%
                dplyr::summarize(mean=mean(value),
                          sem=(sd(value)/sqrt(n())),
                          .groups = "keep")
colnames(Present.DS) <- c("Date",  "Species", "Treatment", "Measurement", "mean", "sem") 
Present.DS$Date <- as.Date(Present.DS$Date, format = "%m/%d/%y")
```

```{r}
Sp.labs <- c("M. capitata", "P. acuta")
names(Sp.labs) <- c("Montipora", "Pocillopora")

cols <- c("blue", "lightblue", "salmon", "red3")

Resp_plot <- ggplot(Present.DS, aes(x=Date, y = mean, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_wrap(~Species*Measurement, scales = "free", labeller = labeller(Species = Sp.labs)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab(bquote('('*mu~ 'mol' ~cm^-2*~ h^-1*')')) +
  theme_bw() + 
  ggtitle("Respirometry") +
  theme(legend.position = "left") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_continuous(breaks = c(17796,17797, 17803, 17810, 17824, 17838, 17852), labels = c("Day1", "Day2", "1 week", "2 week", "4 week", "6 week", "8 week"))+
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black"))

Resp_plot

ggsave(file="Output/Final_Figures/Respirometry.pdf", Resp_plot, width = 8, height =6, units = c("in"))
```

```{r}
Means <- summarySE(Present.long, measurevar="value", groupvars=c("Species.x.x", "Date.x.x", "Treatment.x", "Measurement")) %>% 
  filter(N>2) %>% na.omit() %>% dplyr::rename(Date = Date.x.x) %>% dplyr::rename(Species = Species.x.x) %>% dplyr::rename(Treatment = Treatment.x)

# exporting results 
Present.long %>% select(., Plug.ID, Measurement, value) %>% dplyr::rename(., Plug_ID = Plug.ID) %>% spread(Measurement, value) %>%
  write.csv(., file="Physiology_variables/Respirometry/Output/Resp_AllRates.csv") # raw data
```

Subsetting by species and changing respiration values to absolute value. 
```{r}
Means <- Means %>% 
  mutate(Timepoint = case_when(
    Date == "20180922" ~ "Day 1",
    Date == "20180923" ~ "Day 2", 
    Date == "20180929" ~ "1 week",
    Date == "20181006" ~ "2 week",
    Date == "20181020" ~ "4 week",
    Date == "20181103" ~ "6 week",
    Date == "20181117" ~ "8 week")
  ) %>%
  mutate(Species = case_when(
    Species == "Montipora" ~ "Montipora capitata",
    Species == "Pocillopora" ~ "Pocillopora acuta"
  )) %>%
  mutate(Measurement = case_when(
    Measurement == "Pgross_umol.cm2.hr" ~ "Gross Photosynthesis",
    Measurement == "Pnet_umol.cm2.hr" ~ "Net Photosynthesis",
    Measurement == "Rdark_umol.cm2.hr" ~ "Dark Respiration",
    Measurement == "PR" ~ "P:R Ratio")); Means

Means$Timepoint <- factor(Means$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week"))

Means <- Means %>% subset(Timepoint == "1 week" | Timepoint == "2 week" | Timepoint == "4 week" | Timepoint == "6 week" | Timepoint == "8 week")

## plotting means in absolute value for respiration rate
Means$value <- abs(Means$value)

# Separating by species 
Pact  <- subset(Means, Species=="Pocillopora")
Mcap <- subset(Means, Species=="Montipora")
```

Facet wrap figure.
```{r}
colors <- c("blue", "lightblue", "pink", "red")

Metabolism.fig <- Means %>% subset(!Measurement == "Gross Photosynthesis")

Resp_facetplot <- ggplot(Metabolism.fig, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement ~ Species, scales = "free") +
  theme(strip.text.x = element_text(
        size = 12, color = "black", face = "bold.italic")) +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = colors) + 
  xlab("Timepoint") + 
  ylab(bquote('Change in oxygen levels ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = "left") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 13)) +
  theme(legend.text = element_text(size = 10)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 12)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  axis.line = element_line(colour = "black")); Resp_facetplot
  
ggsave(file="Output/Final_Figures/Respirometry.pdf", Resp_facetplot, width = 11, height = 10, units = c("in"))
ggsave(file="Output/Final_Figures/Respirometry.png", Resp_facetplot, width = 11, height = 10, units = c("in"))
```

Pub figure 

```{r}
Resp_plot_full <- ggplot(Metabolism.fig, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement~Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(bquote('Change in oxygen levels ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
  theme(legend.position = c(0.6,0.3)) +
  #geom_vline(xintercept = c(5.2), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 18, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")) + theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 10)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 12)); Resp_plot_full # Change axis line

ggsave(file="Output/Final_figures/Supplemental_figures/fullrespcm2.png", Resp_plot_full, width = 9, height = 9, units = c("in"))
```




# Standardizing by cell density 

```{r}
Photo.cells <- read.csv("Physiology_variables/Respirometry/Output/Photosynthesis.rates.csv") %>% select(Plug.ID, umol.sec.corr)
  Photo.cells$Plug.ID <- as.character(Photo.cells$Plug.ID)
cell.density <- read.csv("Output/cell_counts.csv") %>% select(Plug_ID, Timepoint, Treatment, Tank, Temperature, CO2, Species, cells, haemo.cells.cm2) %>% dplyr::rename(Plug.ID = Plug_ID)
  cell.density$Plug.ID <- as.character(cell.density$Plug.ID)

Photo.cells <- full_join(Photo.cells, cell.density, by = "Plug.ID") %>% na.omit()
Photo.cells <- Photo.cells %>% 
  mutate(umol.cells.cm.hr = umol.sec.corr*3600/haemo.cells.cm2,
         umol.cells.hr = umol.sec.corr*3600/cells) %>% distinct() %>% gather("Measurement", "value", 11:12) 

Photo.cells %>% select(Plug.ID, Measurement, value) %>% dplyr::rename(Plug_ID = Plug.ID) %>% 
  spread(Measurement, value) %>% select(-umol.cells.cm.hr) %>%
  write.csv(., file="Physiology_variables/Respirometry/Output/Resp_AllRates_cells.csv") # raw data

Photo.cells.mean <- summarySE(Photo.cells, measurevar="value", groupvars=c("Species", "Treatment", "Timepoint", "Measurement")) %>% filter(N>2)
Photo.cells.mean$Timepoint <- factor(Photo.cells.mean$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week"))

Photo.cells.mean <- Photo.cells.mean %>% subset(!Timepoint == "Day 1" & !Timepoint == "Day 2") %>%
  subset(!Measurement == "umol.cells.cm.hr")

Photo.cells.plot <- ggplot(Photo.cells.mean, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = colors) + 
  xlab("Timepoint") + 
  ylab(bquote('Pnet: Change in oxygen levels ('*mu~ 'mol' ~cell^-1*~ h^-1*')')) + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  #scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Photo.cells.plot

Photo.cells.plot <- ggplot(Photo.cells.mean, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(~Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = colors) + 
  xlab("Timepoint") + 
  theme_classic() + 
  ylab(bquote('Pnet: Change in oxygen levels ('*mu~ 'mol' ~cell^-1*~ h^-1*')')) + # y-axis label and y axis range
  theme(legend.position = c(0.1,0.8)) +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 20, color = "black", face = "bold.italic"), # Change axis line
  axis.line = element_line(colour = "black")) + theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 13)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 15)); Photo.cells.plot # Change axis line

ggsave(file="Output/Final_figures/Supplemental_figures/pnet_cells.png", Photo.cells.plot, width = 11, height = 6, units = c("in"))
```


Trying to make one big figure for supplemental information 

```{r}
Photo.cells.mean <- Photo.cells.mean %>% select(Species, Treatment, Timepoint, value, se) %>%
  dplyr::rename('Photosynthetic rate (per cell)' = value) %>% dplyr::rename(Pnet_se = se)
Metabolism.fig_means <- Metabolism.fig %>% spread(Measurm)
```




### Statistics on umol.cells.hr

```{r}
Photo.cells.stats <- Photo.cells %>% spread(Measurement, value) %>% subset(!Timepoint == "Day 1") %>% subset(!Timepoint == "Day 2")
Pnet.mcap.cells.stats <- Photo.cells.stats %>% subset(Species == "Montipora capitata")
Pnet.pacuta.cells.stats <- Photo.cells.stats %>% subset(Species == "Pocillopora acuta")
  
Pnet_mcap_cells_lmer2 <- lmer(log(umol.cells.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=Pnet.mcap.cells.stats, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Pnet_mcap_cells_lmer <- lmer(log(umol.cells.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint), na.action=na.omit, data=Pnet.mcap.cells.stats) 

qqPlot(residuals(Pnet_mcap_cells_lmer2))
hist(residuals(Pnet_mcap_cells_lmer2)) 
qqPlot(residuals(Pnet_mcap_cells_lmer))
hist(residuals(Pnet_mcap_cells_lmer)) 

Pnet_pacuta_cells_lmer2 <- lmer(log(umol.cells.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint), na.action=na.omit, data=Pnet.pacuta.cells.stats, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Pnet_pacuta_cells_lmer <- lmer(log(umol.cells.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint), na.action=na.omit, data=Pnet.pacuta.cells.stats) 

pacuta_pnet_cells_anova <- Anova(Pnet_pacuta_cells_lmer, ddf="lme4", type='III') # Type III Wald chisquare tests
pacuta_pnet_cells_anova2 <- Anova(Pnet_pacuta_cells_lmer2, ddf="lme4", type='III') # Type III Wald chisquare tests
mcap_pnet_cells_anova <- Anova(Pnet_mcap_cells_lmer, ddf="lme4", type='III') # Type III Wald chisquare tests
mcap_pnet_cells_anova2 <- Anova(Pnet_mcap_cells_lmer2, ddf="lme4", type='III') # Type III Wald chisquare tests

pacuta_pnet_cells_anova
pacuta_pnet_cells_anova2
mcap_pnet_cells_anova
mcap_pnet_cells_anova2

capture.output(mcap_pnet_cells_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pnetcells_mcap_sums.txt")
capture.output(pacuta_pnet_cells_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pnetcells_pacuta_sums.txt")
```


# Statistics

### Photosynthetic Rates and Respiration 

Dataframe construction.

```{r}
master <- read.csv("Environmental_data/Master_Fragment.csv") %>% select(Plug_ID, Species, Treatment, Tank, Temperature, CO2, Site.Name, Timepoint) 
master$Plug_ID <- as.factor(master$Plug_ID)

Photo.Resp <- read.csv("Physiology_variables/Respirometry/Output/Resp_AllRates.csv") %>% dplyr::select(Plug.ID, Pnet_umol.cm2.hr, Rdark_umol.cm2.hr, Pgross_umol.cm2.hr) %>%
  dplyr::rename(Plug_ID = Plug.ID) %>%
  mutate(Ratio = Pnet_umol.cm2.hr/abs(Rdark_umol.cm2.hr))
  
Photo.Resp$Plug_ID <- as.factor(Photo.Resp$Plug_ID)

Photo.Resp <- full_join(Photo.Resp, master, by = "Plug_ID") 
Photo.Resp <- Photo.Resp %>% subset(!Timepoint == "Day 1") %>% subset(!Timepoint == "Day 2")
  
pacuta_photoresp <- Photo.Resp %>% subset(Species == "Pacuta")
mcap_photoresp <- Photo.Resp %>% subset(Species == "Mcapitata")
```


Raw data distribution view.
```{r}
hist(pacuta_photoresp$Pnet_umol.cm2.hr)
hist(pacuta_photoresp$Pgross_umol.cm2.hr)
hist(pacuta_photoresp$Rdark_umol.cm2.hr)

hist(mcap_photoresp$Pnet_umol.cm2.hr)
hist(mcap_photoresp$Pgross_umol.cm2.hr)
hist(mcap_photoresp$Rdark_umol.cm2.hr)
```

### Stress timepoints 

Net photosynthetic rates. 
```{r}
Pacuta_Pnet_LMER <- lmer(sqrt(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp) 
Mcap_Pnet_LMER <- lmer(sqrt(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp) 

Pacuta_Pnet_LMER2 <- lmer(sqrt(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Mcap_Pnet_LMER2 <- lmer(sqrt(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

qqPlot(residuals(Pacuta_Pnet_LMER))
qqPlot(residuals(Mcap_Pnet_LMER))

hist(residuals(Pacuta_Pnet_LMER)) 
hist(residuals(Mcap_Pnet_LMER)) 

pacuta_pnet_anova <- Anova(Pacuta_Pnet_LMER, ddf="lme4", type='III') # Type III Wald chisquare tests
pacuta_pnet_anova2 <- Anova(Pacuta_Pnet_LMER2, ddf="lme4", type='III') # Type III Wald chisquare tests

pacuta_pnet_anova
pacuta_pnet_anova2

mcap_pnet_anova <- Anova(Mcap_Pnet_LMER, ddf="lme4", type='III') # Type III Wald chisquare tests
mcap_pnet_anova2 <- Anova(Mcap_Pnet_LMER2, ddf="lme4", type='III') # Type III Wald chisquare tests

mcap_pnet_anova
mcap_pnet_anova2

capture.output(pacuta_pnet_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pnetcm2_Pacuta_sums.txt")
capture.output(mcap_pnet_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pnetcm2_Mcap_sums.txt")
```

Gross photosynthetic rates. 
```{r}
Pacuta_Pgross_LMER <- lmer((Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp) 
Mcap_Pgross_LMER <- lmer(log(Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp) 

Pacuta_Pgross_LMER2 <- lmer((Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Mcap_Pgross_LMER2 <- lmer(log(Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

qqPlot(residuals(Pacuta_Pgross_LMER)) 
qqPlot(residuals(Mcap_Pgross_LMER)) 

hist(residuals(Pacuta_Pgross_LMER)) 
hist(residuals(Mcap_Pgross_LMER)) 

## Type III Wald chisquare tests
pacuta_pgross_anova <- Anova(Pacuta_Pgross_LMER, ddf="lme4", type='III') 
mcap_pgross_anova <- Anova(Mcap_Pgross_LMER, ddf="lme4", type='III') 

pacuta_pgross_anova2 <- Anova(Pacuta_Pgross_LMER2, ddf="lme4", type='III') 
mcap_pgross_anova2 <- Anova(Mcap_Pgross_LMER2, ddf="lme4", type='III') 

pacuta_pgross_anova
pacuta_pgross_anova2

mcap_pgross_anova
mcap_pgross_anova2

capture.output(pacuta_pgross_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pgrosscm2_Pacuta_sums.txt")
capture.output(mcap_pgross_anova2, file = "Output/Statistics/Stress_statistics/Photosynthesis/Pgrosscm2_Mcap_sums.txt")
```

Respiration rates. 

```{r}
pacuta_photoresp$Timepoint <- as.factor(pacuta_photoresp$Timepoint)
pacuta_photoresp$Temperature <- as.factor(pacuta_photoresp$Temperature)
pacuta_photoresp$CO2 <- as.factor(pacuta_photoresp$CO2)

Pacuta_Resp_LMER <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Pacuta_Resp_LMER2 <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Pacuta_Resp_LMER3 <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.treatment", Temperature = "contr.treatment", CO2 = "contr.treatment")) 
Pacuta_Resp_LMER4 <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.treatment", Temperature = "contr.treatment", CO2 = "contr.treatment")) 
## choose Pacuta_Resp_LMER2


Mcap_Resp_LMER <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 
Mcap_Resp_LMER2 <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp, contrasts = list(Timepoint = "contr.treatment", Temperature = "contr.treatment", CO2 = "contr.treatment")) 
## choose 


qqPlot(residuals(Pacuta_Resp_LMER)) 
qqPlot(residuals(Mcap_Resp_LMER)) 

hist(residuals(Pacuta_Resp_LMER)) 
hist(residuals(Mcap_Resp_LMER)) 

# Type III Wald chisquare tests
pacuta_resp_anova <- Anova(Pacuta_Resp_LMER, ddf="lme4", type='III')
pacuta_resp_anova2 <- Anova(Pacuta_Resp_LMER2, ddf="lme4", type='III')
pacuta_resp_anova3 <- Anova(Pacuta_Resp_LMER3, ddf="lme4", type='III')
pacuta_resp_anova4 <- Anova(Pacuta_Resp_LMER4, ddf="lme4", type='III')

pacuta_resp_anova
pacuta_resp_anova2
pacuta_resp_anova3
pacuta_resp_anova4

mcap_resp_anova <- Anova(Mcap_Resp_LMER, ddf="lme4", type='III')
mcap_resp_anova2 <- Anova(Mcap_Resp_LMER2, ddf="lme4", type='III')

mcap_resp_anova
mcap_resp_anova2

tab_model(Pacuta_Resp_LMER, Mcap_Resp_LMER,
          dv.labels = c("P.acuta Respiration", "M. cap Respiration"), string.ci = "Conf. Int (95%)",
          string.p = "P-Value", file = "Output/Statistics/Respiration.doc")

capture.output(pacuta_resp_anova2, file = "Output/Statistics/Stress_statistics/Respiration/Respcm2_Pacuta_sums.txt")
capture.output(mcap_resp_anova, file = "Output/Statistics/Stress_statistics/Respiration/Respcm2_Mcap_sums.txt")

test <- pacuta_photoresp %>% subset(Timepoint == "8 week")
test.aov <- aov(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2, data = pacuta_photoresp)
summary(test.aov)

model.sel(pacuta_resp_anova, pacuta_resp_anova2, pacuta_resp_anova3, pacuta_resp_anova4)
model.sel(pacuta_resp_anova, pacuta_resp_anova2, pacuta_resp_anova3, pacuta_resp_anova4, rank = AIC, rank.args = alist(k = log(nobs(x))))
```

P:R Ratio 

```{r}
Pacuta_Ratio_LMER <- lmer((Ratio) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp) 
Pacuta_Ratio_LMER2 <- lmer((Ratio) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=pacuta_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

Mcap_Ratio_LMER <- lmer(log(Ratio) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp) 
Mcap_Ratio_LMER2 <- lmer(log(Ratio) ~ Timepoint*Temperature*CO2 + (1|Tank:Temperature:Timepoint) + (1|Tank:CO2:Timepoint), na.action=na.omit, data=mcap_photoresp, contrasts = list(Timepoint = "contr.sum", Temperature = "contr.sum", CO2 = "contr.sum")) 

qqPlot(residuals(Pacuta_Ratio_LMER)) 
qqPlot(residuals(Pacuta_Ratio_LMER2)) 
qqPlot(residuals(Mcap_Ratio_LMER)) 
qqPlot(residuals(Mcap_Ratio_LMER2)) 

hist(residuals(Pacuta_Ratio_LMER)) 
hist(residuals(Pacuta_Ratio_LMER2)) 
hist(residuals(Mcap_Ratio_LMER)) 
hist(residuals(Mcap_Ratio_LMER2)) 

pacuta_ratio_anova <- Anova(Pacuta_Ratio_LMER, ddf="lme4", type='III')
pacuta_ratio_anova2 <- Anova(Pacuta_Ratio_LMER2, ddf="lme4", type='III')
mcap_ratio_anova <- Anova(Mcap_Ratio_LMER, ddf="lme4", type='III')
mcap_ratio_anova2 <- Anova(Mcap_Ratio_LMER2, ddf="lme4", type='III')

pacuta_ratio_anova
pacuta_ratio_anova2
mcap_ratio_anova
mcap_ratio_anova2

capture.output(pacuta_ratio_anova2, file = "Output/Statistics/Stress_statistics/Respiration/Ratio_Pacuta_sums.txt")
capture.output(mcap_ratio_anova2, file = "Output/Statistics/Stress_statistics/Respiration/Ratio_Mcap_sums.txt")
```

#### Species comparison 

```{r}
spp.photo.resp <- Photo.Resp %>% subset(Timepoint == "1 week")
spp.photo.cells <- Photo.cells %>% subset(Timepoint == "1 week") %>% subset(Measurement == "umol.cells.hr")

spp.resp.t <- t.test(Rdark_umol.cm2.hr~Species, data = spp.photo.resp)
spp.pnetcm2.t <- t.test(Pnet_umol.cm2.hr~Species, data = spp.photo.resp)
spp.pgrosscm2.t <- t.test(Pgross_umol.cm2.hr~Species, data = spp.photo.resp)
spp.PRratio.t <- t.test(Ratio~Species, data = spp.photo.resp)
spp.Pnetcells.t <- t.test(value~Species, data = spp.photo.cells)

capture.output(spp.resp.t, file = "Output/Statistics/Species_comparison/Respiration.txt")
capture.output(spp.pnetcm2.t, file = "Output/Statistics/Species_comparison/Pnetcm2.txt")
capture.output(spp.pgrosscm2.t, file = "Output/Statistics/Species_comparison/Pgrosscm2.txt")
capture.output(spp.PRratio.t, file = "Output/Statistics/Species_comparison/Ratio.txt")
capture.output(spp.Pnetcells.t, file = "Output/Statistics/Species_comparison/Pnetcells.txt")
```

