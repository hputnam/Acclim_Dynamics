---
title: "Respirometry"
author: "EL Strand"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clears workspace. 
```{r}
rm(list=ls())
```

Load required packages. 
```{r,echo=T, results='hide'}
## Installing if package is not already downloaded
if ("devtools" %in% rownames(installed.packages()) == 'FALSE') install.packages('devtools') 
library(devtools)
if ("segmented" %in% rownames(installed.packages()) == 'FALSE') install.packages('segmented') 
if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("LoLinR" %in% rownames(installed.packages()) == 'FALSE') install_github('colin-olito/LoLinR') 
if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages('lubridate') 
if ("chron" %in% rownames(installed.packages()) == 'FALSE') install.packages('chron') 
if ("plyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('plyr') 
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr') 
if ("ggpubr" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggpubr') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggstatsplot') 
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 


## Read in libraries. 
install_github('colin-olito/LoLinR')
library("ggplot2")
library("segmented")
library("plotrix")
library("gridExtra")
library("LoLinR")
library("lubridate")
library("chron")
library('plyr')
library('dplyr')
library('stringr')
library('Rmisc')
library("ggpubr")
library("car")
library("ggstatsplot")
library("tidyverse")
```

Load in respiration files and creating a blank data frame to be filled in by calculated data later on.  
```{r}
path.p <- "Physiology_variables/Respirometry/Raw_Data/" #the location of all your respirometry files 

file.names <- basename(list.files(path = path.p, pattern = "csv$", recursive = TRUE)) #list all csv file names in the folder and subfolders
#basename above removes the subdirectory name from the file

#generate a 3 column dataframe with specific column names
Photo.R <- data.frame(matrix(NA, nrow=length(file.names)*2, ncol=3)) 
colnames(Photo.R) <- c("Fragment.ID","Intercept", "umol.L.sec")

#add file names that include the subdirectory name
file.names.full <- list.files(path = path.p, pattern = "csv$", recursive = TRUE) #list all csv file names in the folder and subfolders
```

Calculating respiration rates. 
```{r}
PR <- c('Photo', 'Resp')

for(i in 1:length(file.names.full)) { # for every file in list start at the first and run this following function
  Photo.Data1 <-read.table(file.path(path.p,file.names.full[i]), skip = 1, header=T, sep=",", na.string="NA", fill = TRUE, as.is=TRUE, fileEncoding="latin1") #reads in the data files
  Photo.Data1 <- Photo.Data1[with(Photo.Data1, order(Time)), ]
  Photo.Data1  <- Photo.Data1[,c(2,9,16)] #subset columns of interest
  n<-dim(Photo.Data1)[1] #identify length of data
  Photo.Data1 <-Photo.Data1[120:(n-3),] #start at data point ~2 minute in to avoid excess noise from start of run and remove last 3 lines containing text
  Photo.Data1$Time <- as.POSIXct(Photo.Data1$Time,format="%H:%M:%S", tz = "") #convert time from character to time
  Photo.Data1$x <- as.numeric(rownames(Photo.Data1))
  brk <- which(diff(Photo.Data1$Time) > 30) #look for breaks in time of x seconds or more
  brk <- Photo.Data1[brk,4]
  Photo <- subset(Photo.Data1, as.numeric(rownames(Photo.Data1)) < brk[1])  #subset by break in time stamp keeping everything before break
  Resp <- subset(Photo.Data1, as.numeric(rownames(Photo.Data1)) > brk[1]) #subset by break in time stamp keeping everything before break
  lt.levs <- list(Photo, Resp) #list levels of segmentation
  
  for(j in 1:length(lt.levs)){    
    Photo.Data <- as.data.frame(lt.levs[j])
    n<-dim(Photo.Data )[1] #identify length of data
    #Photo.Data <-Photo.Data [120:(n-3),] #start at data point ~2 minute in to avoid excess noise from start of run and remove last 3 lines containing text
    #n<-dim(Photo.Data )[1] #list length of trimmed data
    Photo.Data$sec <- 1:n #set seconds by one from start to finish of run
    
    #Save plot prior to and after data thinning to make sure thinning is not too extreme
    rename <- sub(".csv", "", file.names[i])
    pdf(paste0("Physiology_variables/Respirometry/Output/Data_thinning/",rename,"_",j,"thinning.pdf"))
    par(omi=rep(0.3, 4)) #set size of the outer margins in inches
    par(mfrow=c(1,2)) #set number of rows and columns in multi plot graphic
    plot(Value ~ sec, data=Photo.Data , xlab='Time (seconds)', ylab=substitute(' O'[2]~' (µmol/L)'), type='n', axes=FALSE) #plot data as a function of time
    usr  <-  par('usr')
    rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA)
    whiteGrid()
    box()
    points(Photo.Data$Value ~ Photo.Data $sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)
    axis(1)
    axis(2, las=1)
    
    #save original unthinned and thinned data figure for comparison
    thin <- 30
    alp <- 0.2
    Photo.Data.orig<-Photo.Data
    Photo.Data <-  thinData(Photo.Data ,by=thin)$newData1 #thin data by every x points for all the O2 values
    Photo.Data$sec <- as.numeric(rownames(Photo.Data)) #maintain numeric values for time
    Photo.Data$Temp<-NA
    Photo.Data$Temp <-  thinData(Photo.Data.orig,xy = c(1,3),by=thin)$newData1[,2] #thin data by every 20 points for the temp values
    
    plot(Value ~ sec, data=Photo.Data , xlab='Time (seconds)', ylab=substitute(' O'[2]~' (µmol/L)'), type='n', axes=FALSE) #plot thinned data
    usr  <-  par('usr') #plotting graphics using 'usr'
    rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA) #giving specific coordinates for plot using 'usr'
    whiteGrid()
    box()
    points(Photo.Data$Value ~ Photo.Data$sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)
    axis(1)
    axis(2, las=1)
    dev.off()
    
    ##Olito et al. 2017: It is running a bootstrapping technique and calculating the rate based on density
    Regs  <-  rankLocReg(xall=Photo.Data $sec, yall=Photo.Data $Value, alpha=alp, 
                         method="pc", verbose=TRUE) 
    pdf(paste0("Physiology_variables/Respirometry/Output/Regressions/",rename,"_",j,"regression.pdf"))
    plot(Regs)
    dev.off()
    
    s <- seq(0,nrow(Photo.R),length(lt.levs)) #to order the file output sequence in correct order in data frame
    Photo.R[j+s[i],2:3] <- Regs$allRegs[1,c(4,5)] #inserts slope and intercept in the dataframe
    Photo.R[j+s[i],1] <- rename #stores the file name in the Date column
    Photo.R[j+s[i],1] <- paste0(rename,"_",j) #stores the file name in the Date column
    Photo.R[j+s[i],4] <- mean(Photo.Data$Temp, na.rm=T)  #stores the Temperature in the Temp.C column
    Photo.R[j+s[i],5] <- PR[j] #stores whether it is photosynthesis or respiration
  }
}

write.csv(Photo.R, 'Physiology_variables/Respirometry/Output/Photo.R.csv')
```

Reading the dataframe in to skip calculating all regressions each time. 
```{r}
Photo.R <- read.csv(file="Physiology_variables/Respirometry/Output/Photo.R.csv", header=T) #read in volume and sample.info data
Photo.R <- Photo.R[,-1]

Photo.R$Fragment.ID <- str_sub(Photo.R$Fragment.ID, 1, str_length(Photo.R$Fragment.ID)-2) #Removing _1 or _2
```

Load sample info spreadsheet in and merge with Photo.R file. 
```{r}
#Load Sample Info
Sample.Info <- read.csv(file="Physiology_variables/Respirometry/Resp_DeltaTA_datasheet.csv", header=T) #read sample.info data
Sample.Info$Fragment.ID <- sub(".csv", "", Sample.Info$Fragment.ID)
Sample.Info$Blnk.Group <- paste(Sample.Info$Date, Sample.Info$Tank, Sample.Info$Light.or.Dark, sep = "_")
#Sample.Info$Merge.ID <- paste(Sample.Info$Fragment.ID, Sample.Info$Light.or.Dark, sep = "_") 

#Merge data with sample info
colnames(Photo.R) <- c("Fragment.ID", "Intercept","umol.L.sec", "Temp","Light.or.Dark" )
#Photo.R$Merge.ID <- paste(Photo.R$Fragment.ID, Photo.R$Light.or.Dark, sep = "_")
Data <- left_join(Photo.R,Sample.Info)

Data2 <-select(Data, c("Date","Timepoint","Date.Num","Species", "Treatment","Plug.ID","Tank", "Light.or.Dark","Vol.ml","Surface.Area","umol.L.sec"))

```

Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and remove per Liter.
```{r}
Data2$umol.sec <- Data2$umol.L.sec * (Data2$Vol.ml/1000)
Data2$Group <- paste(Data2$Date, Data2$Tank, Data2$Light.or.Dark, sep = "_")
```

Accounting for blank chamber rates. 
The blanks have to be specific to the response variable (i.e. photo or resp), tank, and timepoint 
```{r}
#Calculate Photo blank rate
blnk <- aggregate(umol.sec ~ Date*Species*Tank*Light.or.Dark, data=Data2, mean)
Blanks <- subset(blnk, Species == "Blank")
Blanks$Group <- paste(Blanks$Date, Blanks$Tank, Blanks$Light.or.Dark, sep = "_")
boxplot(Blanks$umol.sec ~ Blanks$Tank)

colnames(Blanks)[5] <- "Blank.umol.sec"
Data3 <- left_join(Data2, Blanks, by="Group")

#Account for blank rate Subtract Blank by the temperature blank
Data3$umol.sec.corr <- Data3$umol.sec - Data3$Blank.umol.sec
```

Normalize to surface area of the coral. 
```{r}
#normalize to surface area and h-1
Data3$umol.cm2.hr <- (Data3$umol.sec.corr*3600)/Data3$Surface.Area
```

Removing blanks from the dataset and exporting both respirometry and photosynthetic rates. 
```{r}
Photo <- subset(Data3, Light.or.Dark.x=="Photo")
Photo <- subset(Photo, Species.x!="Blank")
Resp <- subset(Data3, Light.or.Dark.x=="Resp")
Resp <- subset(Resp, Species.x!="Blank")

colnames(Resp)[20] <- "Rdark_umol.cm2.hr"
colnames(Photo)[20] <- "Pnet_umol.cm2.hr"

write.csv(Photo, file="Physiology_variables/Respirometry/Output/Photosynthesis.rates.csv")
write.csv(Resp, file="Physiology_variables/Respirometry/Output/Respiration.rates.csv")
```

Calculating gross photosynthesis (Pnet -  negative Rdark)
```{r}
#merge desired columns by id
resp.data <- left_join(Photo,Resp, by="Plug.ID")

# calculating Pgross
resp.data$Pgross_umol.cm2.hr <- resp.data$Pnet_umol.cm2.hr - resp.data$Rdark_umol.cm2.hr
```

The following corals have been lost in transit from HI to RI or in a freezer in either location. 
```{r}
# Taking out the missing P. acuta fragments
Missing.list <- c("2976", "3003", "2008", "2512", "2528", "2740", "1603", "2200", "2880", "2752", "25223", "2523", "2981", "2984", "1739", "2859")
Missing.list <- as.list(Missing.list)
Present <- resp.data[!grepl(paste(Missing.list, collapse = "|"), resp.data$Plug.ID),]

#convert to long format
Present.long <- pivot_longer(Present, cols = c("Pnet_umol.cm2.hr","Pgross_umol.cm2.hr","Rdark_umol.cm2.hr")) %>%
  dplyr::rename(Measurement = name)

Present.DS <-  Present.long %>%
                group_by(Date.Num.x,Species.x.x,Treatment.x, Measurement) %>%
                dplyr::summarize(mean=mean(value),
                          sem=(sd(value)/sqrt(n())),
                          .groups = "keep")
colnames(Present.DS) <- c("Date",  "Species", "Treatment", "Measurement", "mean", "sem") 
Present.DS$Date <- as.Date(Present.DS$Date, format = "%m/%d/%y")

# Present.DS %>%
#   ggplot(aes(x = Date, y = mean, color = Treatment)) +
#   scale_color_manual(values = trt.colors) +
#   facet_wrap(Measurement*Species ~ .) +
#   labs(x = "", y = "Temperature °C") +
#   geom_jitter(width = 0.1) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1), 
#   panel.border = element_blank(),
#   panel.grid.major = element_blank(),
#   panel.grid.minor = element_blank(),
#   panel.background = element_blank(),
#   strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
#   axis.line = element_line(colour = "black"))
```

```{r}

Sp.labs <- c("M. capitata", "P. acuta")
names(Sp.labs) <- c("Montipora", "Pocillopora")

cols <- c("lightblue", "blue", "salmon", "red3")

Resp_plot <- ggplot(Present.DS, aes(x=Date, y = mean, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_wrap(~Species*Measurement, scales = "free", labeller = labeller(Species = Sp.labs)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem), width=.2) +
  scale_color_manual(values = cols) + 
  xlab("Timepoint") + 
  ylab(bquote('('*mu~ 'mol' ~cm^-2*~ h^-1*')')) +
  theme_bw() + 
  ggtitle("Respirometry") +
  theme(legend.position = "left") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  scale_x_continuous(breaks = c(17796,17797, 17803, 17810, 17824, 17838, 17852), labels = c("Day1", "Day2", "1 week", "2 week", "4 week", "6 week", "8 week"))+
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  strip.text.x = element_text(size = 12, color = "black", face = "bold.italic"),
  # Change axis line
  axis.line = element_line(colour = "black"))

Resp_plot

ggsave(file="Output/Final_Figures/Respirometry.pdf", Resp_plot, width = 8, height =6, units = c("in"))
```


Calculating means.
```{r}
# AllMeans <- ddply(Present, c('Date.x','Species.x', 'Treatment'), summarize,
#                   #pnet
#                   Pnet.mean= mean(Pnet_umol.cm2.hr, na.rm=T), #mean pnet
#                   N = sum(!is.na(Pnet_umol.cm2.hr)), # sample size
#                   Pnet.se = sd(Pnet_umol.cm2.hr, na.rm=T)/sqrt(N), #SE
#                   #Rdark
#                   Rdark.mean= mean(Rdark_umol.cm2.hr, na.rm=T), #mean rdark
#                   Rdark.se = sd(Rdark_umol.cm2.hr, na.rm=T)/sqrt(N), #SE
#                   #Pgross
#                   Pgross.mean  = mean(Pgross_umol.cm2.hr, na.rm=TRUE),
#                   Pgross.se = sd (Pgross_umol.cm2.hr, na.rm=TRUE)/sqrt(N))
# AllMeans
# colnames(AllMeans) <- c("Date", "Species", "Treatment", "Pnet.mean", "N",   "Pnet.se",  "Rdark.mean",   "Rdark.se", "Pgross.mean",  "Pgross.se")
# AllMeans$Group <- paste(AllMeans$Species, AllMeans$Treatment, sep = "_")
# 
# # checking sample sizes
# dplyr::filter(AllMeans, N < 6)
# 
# # exporting results 
# write.csv(resp.data, file="Physiology_variables/Respirometry/Output/Resp_AllRates.csv") # raw data
# write.csv(AllMeans, file="Physiology_variables/Respirometry/Output/Resp_AllMeans.csv") # Mean data
```

```{r}
Missing <- Missing %>% select(Fragment.ID.x, Date.x, Species.x, Treatment, Pnet_umol.cm2.hr, Pgross_umol.cm2.hr, Rdark_umol.cm2.hr) %>%
  gather("Measurement", "Value", 5:7) 
Means <- summarySE(Present.long, measurevar="value", groupvars=c("Species.x.x", "Date.x.x", "Treatment.x", "Measurement")) %>% 
  filter(N>2) %>% na.omit() %>% dplyr::rename(Date = Date.x.x) %>% dplyr::rename(Species = Species.x.x) %>% dplyr::rename(Treatment = Treatment.x)

#AllMeans <- ddply(Missing, c('Date.x','Species.x', 'Treatment'), summarize,
                  #pnet
                 # Pnet.mean= mean(Pnet_umol.cm2.hr, na.rm=T), #mean pnet
                 # N = sum(!is.na(Pnet_umol.cm2.hr)), # sample size
                #  Pnet.se = sd(Pnet_umol.cm2.hr, na.rm=T)/sqrt(N), #SE
                  #Rdark
                #  Rdark.mean= mean(Rdark_umol.cm2.hr, na.rm=T), #mean rdark
                #  Rdark.se = sd(Rdark_umol.cm2.hr, na.rm=T)/sqrt(N), #SE
                  #Pgross
                 # Pgross.mean  = mean(Pgross_umol.cm2.hr, na.rm=TRUE),
                #  Pgross.se = sd (Pgross_umol.cm2.hr, na.rm=TRUE)/sqrt(N))
#AllMeans
#colnames(AllMeans) <- c("Date", "Species", "Treatment", "Pnet.mean", "N",   "Pnet.se",  "Rdark.mean",   "Rdark.se", "Pgross.mean",  "Pgross.se")
#AllMeans$Group <- paste(AllMeans$Species, AllMeans$Treatment, sep = "_")

# checking sample sizes
#dplyr::filter(AllMeans, N < 6)

# exporting results 
write.csv(resp.data, file="Physiology_variables/Respirometry/Output/Resp_AllRates.csv") # raw data
write.csv(AllMeans, file="Physiology_variables/Respirometry/Output/Resp_AllMeans.csv") # Mean data
```

Taking out outliers. 
```{r}
ggplot(Missing, aes(x=Treatment, y=Value)) + geom_boxplot() + theme_classic() + 
  facet_wrap(~ Measurement) + 
  ylab("umol.cm2.hr")
```



Subsetting by species and changing respiration values to absolute value. 
```{r}
# # Adding timepoint column to AllMeans 
# AllMeans <- AllMeans %>% 
#   mutate(Timepoint = case_when(
#     Date == "20180922" ~ "Day 1",
#     Date == "20180923" ~ "Day 2", 
#     Date == "20180929" ~ "1 week",
#     Date == "20181006" ~ "2 week",
#     Date == "20181020" ~ "4 week",
#     Date == "20181103" ~ "6 week",
#     Date == "20181117" ~ "8 week")
#   )
# 
# AllMeans$Timepoint <- factor(AllMeans$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week"))
# 
# # Separating by species 
# Pact  <- subset(AllMeans, Species=="Pocillopora")
# Mcap <- subset(AllMeans, Species=="Montipora")
# 
# # Changing respiration rates to absolute values
# Pact$Rdark.mean <- abs(Pact$Rdark.mean)
# Mcap$Rdark.mean <- abs(Mcap$Rdark.mean)

# Adding timepoint column to AllMeans 
Means <- Means %>% 
  mutate(Timepoint = case_when(
    Date == "20180922" ~ "Day 1",
    Date == "20180923" ~ "Day 2", 
    Date == "20180929" ~ "1 week",
    Date == "20181006" ~ "2 week",
    Date == "20181020" ~ "4 week",
    Date == "20181103" ~ "6 week",
    Date == "20181117" ~ "8 week")
  ) %>%
  mutate(Species = case_when(
    Species == "Montipora" ~ "Montipora capitata",
    Species == "Pocillopora" ~ "Pocillopora acuta"
  )) %>%
  mutate(Measurement = case_when(
    Measurement == "Pgross_umol.cm2.hr" ~ "Gross Photosynthesis",
    Measurement == "Pnet_umol.cm2.hr" ~ "Net Photosynthesis",
    Measurement == "Rdark_umol.cm2.hr" ~ "Dark Respiration"
  )); Means

Means$Timepoint <- factor(Means$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week"))

# Separating by species 
Pact  <- subset(Means, Species=="Pocillopora")
Mcap <- subset(Means, Species=="Montipora")

# Changing respiration rates to absolute values
#Pact$Rdark.mean <- abs(Pact$Rdark.mean)
#Mcap$Rdark.mean <- abs(Mcap$Rdark.mean)
```

Plotting respiration and photosynthetic rates. 
To plot a response variable with both species on one graph, use facet_wrap(~Species) function.
```{r}
# colors <- c("lightblue", "blue", "salmon", "red3")
# 
# ## Montipora capitata
# Mcap.Pg <- ggplot(Mcap, aes(x=Timepoint, y = Pgross.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() +
#   geom_errorbar(aes(ymin=Pgross.mean-Pgross.se, ymax=Pgross.mean+Pgross.se), width=.2) + 
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") +
#   ylab(bquote('Gross Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) +
#   ylim(c(0, 4.5)) + # y-axis label and y axis range
#   labs(title = "M. capitata") +
#   theme_classic() + 
#   theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x=element_blank(),
#         plot.title = element_text(face="bold.italic", hjust=0.5, size=20)) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Mcap.Pg 
# 
# Mcap.Pn <- ggplot(Mcap, aes(x=Timepoint, y = Pnet.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() +
#   geom_errorbar(aes(ymin=Pnet.mean-Pnet.se, ymax=Pnet.mean+Pnet.se), width=.2) +
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") + theme(axis.text.x=element_text(angle=60, hjust=1)) + # x-axis label and rotating text on x axis
#   ylab(bquote('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + 
#   ylim(c(0, 3.5)) + # y-axis label and y axis range
#   theme_classic()+
#   theme(legend.position = "none",axis.title.x = element_blank(), axis.text.x=element_blank(), plot.title = element_text(face="bold")) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Mcap.Pn
# 
# Mcap.Rd <- ggplot(Mcap, aes(x=Timepoint, y = Rdark.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() + 
#   geom_errorbar(aes(ymin=Rdark.mean-Rdark.se, ymax=Rdark.mean+Rdark.se), width=.2)+
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") +
#   ylab(bquote('Dark Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) +  
#   ylim(c(0, 1.1)) + # y-axis label and y axis range
#   theme_classic() + 
#   theme(legend.position = "none",plot.title = element_text(face="bold")) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Mcap.Rd
# 
# ## Pocillopora acuta
# Pact.Pg <- ggplot(Pact, aes(x=Timepoint, y = Pgross.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() +
#   geom_errorbar(aes(ymin=Pgross.mean-Pgross.se, ymax=Pgross.mean+Pgross.se), width=.2) +
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") + 
#   ylab(bquote('Gross Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + 
#   ylim(c(0, 4.5)) + # y-axis label and y axis range
#   labs(title = "P. acuta") +
#   theme_classic() + 
#   theme(legend.position = c(0.8, 0.9), axis.title.x = element_blank(), axis.text.x=element_blank(),
#         plot.title = element_text(face="bold.italic", hjust=0.5, size=20)) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Pact.Pg
# 
# Pact.Pn <- ggplot(Pact, aes(x=Timepoint, y = Pnet.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() + 
#   geom_errorbar(aes(ymin=Pnet.mean-Pnet.se, ymax=Pnet.mean+Pnet.se), width=.2) +
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") + theme(axis.text.x=element_text(angle=60, hjust=1)) + # x-axis label and rotating text on x axis
#   ylab(bquote('Net Photosynthesis ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
#   ylim(c(0, 3.5)) + # y-axis label and y axis range
#   theme_classic()+
#   theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x=element_blank()) + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Pact.Pn
# 
# Pact.Rd <- ggplot(Pact, aes(x=Timepoint, y = Rdark.mean, group = Treatment, color = Treatment)) +
#   geom_line() + geom_point() +
#   geom_errorbar(aes(ymin=Rdark.mean-Rdark.se, ymax=Rdark.mean+Rdark.se), width=.2) +
#   scale_color_manual(values = colors) + 
#   xlab("Timepoint") + 
#   ylab(bquote('Dark Respiration ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
#   ylim(c(0, 1.1)) + # y-axis label and y axis range
#   theme_classic() + 
#   theme(legend.position = "none") + 
#   theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) #Set the text angle
# Pact.Rd
# 
# # Resp.Figs <- combine_plots(Mcap.Pg, Pact.Pg, Mcap.Pn, Pact.Pn, Mcap.Rd,Pact.Rd,
#   # labels = c("A", "D", "B", "E", "C", "F"), ncol=2)
# 
# Resp.Figs <- arrangeGrob(Mcap.Pg, Pact.Pg, Mcap.Pn, Pact.Pn, Mcap.Rd, Pact.Rd, ncol=2)
# 
# ggsave(file="Output/Final_Figures/Respirometry.pdf", Resp.Figs, width = 11, height = 10, units = c("in"))
# ggsave(file="Output/Final_Figures/Respirometry.png", Resp.Figs, width = 11, height = 10, units = c("in"))
```

Facet wrap figure.
```{r}
colors <- c("lightblue", "blue", "salmon", "red3")

Resp_facetplot <- ggplot(Means, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = colors) + 
  xlab("Timepoint") + 
  ylab(bquote('Change in oxygen levels ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  #scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Resp_facetplot

ggsave(file="Output/Final_Figures/Respirometry.pdf", Resp_facetplot, width = 11, height = 10, units = c("in"))
ggsave(file="Output/Final_Figures/Respirometry.png", Resp_facetplot, width = 11, height = 10, units = c("in"))
```
# Standardizing by cell density 

```{r}
Photo.cells <- read.csv("Physiology_variables/Respirometry/Output/Photosynthesis.rates.csv") %>% select(Plug.ID, umol.sec.corr)
  Photo.cells$Plug.ID <- as.character(Photo.cells$Plug.ID)
cell.density <- read.csv("Output/cell_counts.csv") %>% select(Plug_ID, Timepoint, Treatment, Temperature, CO2, Species, cells, haemo.cells.cm2) %>% dplyr::rename(Plug.ID = Plug_ID)
  cell.density$Plug.ID <- as.character(cell.density$Plug.ID)

Photo.cells <- full_join(Photo.cells, cell.density, by = "Plug.ID") %>% na.omit()
Photo.cells <- Photo.cells %>% 
  mutate(umol.cells.cm.hr = umol.sec.corr*3600/haemo.cells.cm2,
         umol.cells.hr = umol.sec.corr*3600/cells) %>% distinct() %>% gather("Measurement", "value", 10:11)

Photo.cells.mean <- summarySE(Photo.cells, measurevar="value", groupvars=c("Species", "Treatment", "Timepoint", "Measurement")) %>% filter(N>2)
Photo.cells.mean$Timepoint <- factor(Photo.cells.mean$Timepoint, levels=c("Day 1","Day 2","1 week","2 week","4 week","6 week","8 week"))

Photo.cells.plot <- ggplot(Photo.cells.mean, aes(x=Timepoint, y = value, group = Treatment, color = Treatment)) +
  geom_line() + geom_point() +
  facet_grid(Measurement ~ Species, scales = "free") +
  geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.2) +
  scale_color_manual(values = colors) + 
  xlab("Timepoint") + 
  ylab(bquote('Change in oxygen levels ('*mu~ 'mol' ~cm^-2*~ h^-1*')')) + # y-axis label and y axis range
  theme_classic() + 
  theme(legend.position = "left") +
  geom_vline(xintercept = c(7.8), colour="black", linetype="dotted") +
  theme(plot.title = element_text(face = 'bold.italic', size = 12, hjust = 0)) + 
  #scale_x_discrete(breaks = c("Week1", "Week2", "Week4", "Week6", "Week8", "Week12", "Week16"), labels = c("1 week", "2 week", "4 week", "6 week", "8 week", "12 week", "16 week")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1.2, hjust = 1.3)) + #Set the text angle
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Change axis line
  axis.line = element_line(colour = "black")); Photo.cells.plot

ggsave(file="Output/Final_Figures/Respirometry_photo_cells.pdf", Photo.cells.plot, width = 11, height = 10, units = c("in"))
ggsave(file="Output/Final_Figures/Respirometry_photo_cells.png", Photo.cells.plot, width = 11, height = 10, units = c("in"))
```


# Statistics

### Photosynthetic Rates and Respiration 

Dataframe 
```{r}
master <- read.csv("Environmental_data/Master_Fragment.csv") %>% select(Plug_ID, Species, Treatment, Tank, Temperature, CO2, Site.Name, Timepoint) 
master$Plug_ID <- as.factor(master$Plug_ID)

Photo.Resp <- read.csv("Physiology_variables/Respirometry/Output/Resp_AllRates.csv") %>% select(Fragment.ID.x, Pnet_umol.cm2.hr, Rdark_umol.cm2.hr, Pgross_umol.cm2.hr) %>%
  dplyr::rename(Plug_ID = Fragment.ID.x)
  Photo.Resp$Plug_ID <- gsub("P-", "", Photo.Resp$Plug_ID)
  Photo.Resp$Plug_ID <- gsub("M-", "", Photo.Resp$Plug_ID)
  Photo.Resp <- Photo.Resp %>% separate(Plug_ID, c("Plug_ID", "Date")) %>% select(-Date)

Photo.Resp <- full_join(Photo.Resp, master, by = "Plug_ID") 
Photo.Resp <- Photo.Resp %>% subset(!Timepoint == "Day 1") %>% subset(!Timepoint == "Day 2")
  
pacuta_full_data <- Photo.Resp %>% subset(Species == "Pacuta")
mcap_full_data <- Photo.Resp %>% subset(Species == "Mcapitata")
```


Raw data distribution view.
```{r}
hist(pacuta_full_data$Pnet_umol.cm2.hr)
hist(pacuta_full_data$Pgross_umol.cm2.hr)
hist(pacuta_full_data$Rdark_umol.cm2.hr)

hist(mcap_full_data$Pnet_umol.cm2.hr)
hist(mcap_full_data$Pgross_umol.cm2.hr)
hist(mcap_full_data$Rdark_umol.cm2.hr)
# mcap doesn't look normal, the models should account for this but might need to transform post models 
```

*P. acuta* linear mixed effect models.  
Net photosynthetic rates. 
```{r}
## Pnet model selection
Pacuta_Pnet_LMER <- lmer(Pnet_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta_full_data) 
#Pacuta_Pnet_LMER.reef <- lmer(Pnet_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=pacuta_full_data)
#model.sel(Pacuta_Pnet_LMER, Pacuta_Pnet_LMER.reef) # model selection function
## Pacuta Pnet with reef and tank was the best AIC = 215.5 compared to AIC = 216.3 for just tank

#anova(Pacuta_Pnet_LMER, Pacuta_Pnet_LMER.reef) # report AIC values 

## summary of the model chosen from above
## plot(Pacuta_Pnet_LMER) in console to view diagnostic plots
summary(Pacuta_Pnet_LMER)
qqPlot(residuals(Pacuta_Pnet_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_Pnet_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
#leveneTest(residuals(Pacuta_Pnet_LMER))
leveneTest(pacuta_full_data$Pnet_umol.cm2.hr ~ pacuta_full_data$Timepoint*pacuta_full_data$Temperature*pacuta_full_data$CO2)
#bartlett.test(Pacuta_Pnet_LMER)


## significance of model
pacuta_pnet_anova <- Anova(Pacuta_Pnet_LMER, ddf="lme4", type='III') # Type III Wald chisquare tests
#Anova(Pacuta_Pnet_LMER.reef, ddf="lme4", type='III') # Type III Wald chisquare tests

capture.output(pacuta_pnet_anova, file = "Output/Statistics/Pnet_pacuta_stats.txt")
```

Gross photosynthetic rates. 
```{r}
## Pgross 
Pacuta_Pgross_LMER <- lmer(Pgross_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta_full_data) 
Pacuta_Pgross_LMER.reef <- lmer(Pgross_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=pacuta_full_data)
model.sel(Pacuta_Pgross_LMER, Pacuta_Pgross_LMER.reef) # model selection function
## With reef model chosen AIC = 254.0 vs. without reef AIC = 256.9 

## summary of the model chosen from above
## plot(Pacuta_Pgross_LMER) in console to view diagnostic plots
summary(Pacuta_Pgross_LMER)
qqPlot(residuals(Pacuta_Pgross_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_Pgross_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(pacuta_full_data$Pgross_umol.cm2.hr ~ pacuta_full_data$Timepoint*pacuta_full_data$Temperature*pacuta_full_data$CO2)

## Type III Wald chisquare tests
pacuta_pgross_anova <- Anova(Pacuta_Pgross_LMER, ddf="lme4", type='III') 
Anova(Pacuta_Pgross_LMER.reef, ddf="lme4", type='III') 

capture.output(pacuta_pgross_anova, file = "Output/Statistics/Pgross_pacuta_stats.txt")
```

```{r}
## Dark Resp
Pacuta_Resp_LMER <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=pacuta_full_data) #GLMM
Pacuta_Resp_LMER.reef <- lmer(Rdark_umol.cm2.hr ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=pacuta_full_data)
model.sel(Pacuta_Resp_LMER, Pacuta_Resp_LMER.reef) # model selection function
## Model with just tank chosen AIC = -152.2 vs. AIC = -143.7 for both tank and reef 

## summary of the model chosen from above
## plot(Pacuta_Resp_LMER) in console to view diagnostic plots
summary(Pacuta_Resp_LMER)
qqPlot(residuals(Pacuta_Resp_LMER)) # qqplot and histogram 
hist(residuals(Pacuta_Resp_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(pacuta_full_data$Rdark_umol.cm2.hr ~ pacuta_full_data$Timepoint*pacuta_full_data$Temperature*pacuta_full_data$CO2)

# Type III Wald chisquare tests
pacuta_resp_anova <- Anova(Pacuta_Resp_LMER, ddf="lme4", type='III')

capture.output(pacuta_resp_anova, file = "Output/Statistics/Resp_pacuta_stats.txt")
```

*M.capitata* linear mixed effect models 

Net photosynthetic rates. 
```{r}
## Pnet
Mcap_Pnet_LMER <- lmer(log(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=mcap_full_data) 
Mcap_Pnet_LMER.reef <- lmer(log(Pnet_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=mcap_full_data)
model.sel(Mcap_Pnet_LMER, Mcap_Pnet_LMER.reef) # model selection function
## Model with just tank chosen AIC = 189.6 vs AIC = 190 for both tank and site 

## summary of the model chosen from above
## plot(Mcap_Pnet_LMER) in console to view diagnostic plots
summary(Mcap_Pnet_LMER)
qqPlot(residuals(Mcap_Pnet_LMER)) # qqplot and histogram 
hist(residuals(Mcap_Pnet_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(mcap_full_data$Pnet_umol.cm2.hr ~ mcap_full_data$Timepoint*mcap_full_data$Temperature*mcap_full_data$CO2)

# Type III Wald chisquare tests
mcap_pnet_anova <- Anova(Mcap_Pnet_LMER, ddf="lme4", type='III') 

capture.output(mcap_pnet_anova, file = "Output/Statistics/Pnet_mcap_stats.txt")
```

```{r}
## Pgross
Mcap_Pgross_LMER <- lmer(log(Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=mcap_full_data) 
Mcap_Pgross_LMER.reef <- lmer(log(Pgross_umol.cm2.hr) ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=mcap_full_data)
model.sel(Mcap_Pgross_LMER, Mcap_Pgross_LMER.reef) # model selection function
## With tank AIC = 171.9; with tank and reef AIC = 174.9. Just tank chosen 

## summary of the model chosen from above
## plot(Mcap_Pnet_LMER) in console to view diagnostic plots
summary(Mcap_Pgross_LMER)
qqPlot(residuals(Mcap_Pgross_LMER)) # qqplot and histogram 
hist(residuals(Mcap_Pgross_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(mcap_full_data$Pgross_umol.cm2.hr ~ mcap_full_data$Timepoint*mcap_full_data$Temperature*mcap_full_data$CO2)

## Type III Wald chisquare tests
mcap_pgross_anova <- Anova(Mcap_Pgross_LMER, ddf="lme4", type='III') 

capture.output(mcap_pgross_anova, file = "Output/Statistics/Pgross_mcap_stats.txt")
```

```{r}
## Dark Resp 
mcap_full_data$Rdarkplus1 <- mcap_full_data$Rdark_umol.cm2.hr+1
  
Mcap_Resp_LMER <- lmer((Rdarkplus1^2) ~ Timepoint*Temperature*CO2 + (1|Tank), na.action=na.omit, data=mcap_full_data)  
Mcap_Resp_LMER.reef <- lmer(log(Rdarkplus1) ~ Timepoint*Temperature*CO2 + (1|Tank) + (1|Site.Name), na.action=na.omit, data=mcap_full_data)
model.sel(Mcap_Resp_LMER, Mcap_Resp_LMER.reef) # model selection function 
## With tank AIC = 254.4; with tank and reef AIC = 257.6. Just tank chosen 

## summary of the model chosen from above
## plot(Mcap_Resp_LMER) in console to view diagnostic plots
summary(Mcap_Resp_LMER)
qqPlot(residuals(Mcap_Resp_LMER)) # qqplot and histogram 
hist(residuals(Mcap_Resp_LMER)) 
## checking homogeneity of variance using levene test (can also use Bartlett's test function)
leveneTest(mcap_full_data$Rdark_umol.cm2.hr ~ mcap_full_data$Timepoint*mcap_full_data$Temperature*mcap_full_data$CO2)

## Type III Wald chisquare tests
mcap_resp_anova <- Anova(Mcap_Resp_LMER, ddf="lme4", type='III') 

capture.output(mcap_resp_anova, file = "Output/Statistics/Resp_mcap_stats.txt")
```



