---
title: "Environmental_Data"
author: "EL Strand"
date: "5/27/2020"
output:
---

Clear workspace. 

```{r}
rm(list=ls()) 
```

Required packages for the below analyses.
```{r}
library(plyr) # plyr needs to be loaded before dplyr
library(dplyr)
library(tidyr)
library(xml2)
library(tidyverse)
library(ggplot2)
library(scales)
library(lubridate)
library(patchwork) # To display 2 charts together
library(hrbrthemes)
library(reshape2)
library(gridExtra)
library(plotrix)
library(Rmisc)
library(lattice)
library(viridis)
library(dygraphs)
library(xts)
library(graphics)
library(janitor)

colors <- c("lightblue", "blue", "salmon", "red3")
```

### NOAA BUOY DATA ###

**CRIMP2 NOAA Buoy Data files**: 
Nov 2012 - June 2013
June 2013 - Nov 2013
Nov 2013 - June 2014 
June 2014 - May 2015
Aug 2015 - Sept 2016  
Nov 2016 - Dec 2017  (missing Oct 2016)
Dec 2017 - May 2018  
May 2018 - Feb 2019 

```{r}
#bind all CRIMP logger data sets together
CRIMP2.data <-
  list.files(path = 'Environmental_data/CRIMP2-buoy', pattern = ".csv", full.names = TRUE) %>% # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.table, .id = "file.ID", header=FALSE, skip=5, sep=",") %>% # join all files together in one data frame by file ID
  group_by(file.ID) %>% # for each file do the following
  select(V4, V5, V15, V22) %>% # I ran lines 58-62 first to view the column names and decide which ones I wanted to keep and then changed skip=4 to skip=5
  dplyr::rename(Date=`V4`, # Date
                Time=`V5`, # Time
                Temp=`V15`, # SST C
                pCO2=`V22`) %>% #pCO2 SW (sat) uatm chosen
  unite(Date.Time, Date, Time, sep=" ")

CRIMP2.data$Date.Time <- mdy_hm(CRIMP2.data$Date.Time, quiet=FALSE, tz="UTC", truncated=0) #format date and time 
CRIMP2.data$Data.Source <- "CRIMP2"

crimp.colors <- c("lightblue", "blue", "black", "salmon", "red3")

#### Temperature
CRIMP2.temp <- CRIMP2.data %>% select(-pCO2) %>% filter(Temp>0)
## need to run HOBO logger section prior to overlaying experimental data on CRIMP2's data
EXPT.temp <- Hobo.means %>% select(Date.Time, Treatment, Temperature) %>% dplyr::rename(Data.Source = Treatment, Temp = Temperature)
EXPT.temp$file.ID <- "EXPT"
CRIMP2.EXPT.temp <- bind_rows(CRIMP2.temp, EXPT.temp) #combining both dataframes 

# generate all combinations of year/group
d <- expand.grid(min(CRIMP2.EXPT.temp$Date):max(CRIMP2.EXPT.temp$Date), unique(CRIMP2.EXPT.temp$Date.Source))
# fill NA if combination is missing
d$val <- apply(d, 1,
               function(x) if (nrow(subset(CRIMP2.EXPT.temp, Date.Time == x[1] & Data.Source == x[2]))) 0 else NA)
# modify the original dataset
names(d) <- c("year", "group", "value")
data <- rbind(data, d[is.na(d$val), ])
ggplot(data, aes(x=year, y=value,
                 group=as.factor(group), colour=as.factor(group))) + geom_line()


CRIMP.TEMP.PLOT <- ggplot(data = CRIMP2.EXPT.temp, aes(x = Date.Time, y = Temp, color = Data.Source)) +
  labs(x = "Date (Month-Year)", y = "Sea Surface Temperature (°C)") + ggtitle("CRIMP2 NOAA Buoy") +
  geom_line(size=0.15) +
  scale_color_manual(values = crimp.colors) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "60 days", labels = date_format("%b %y")) +
  geom_hline(aes(yintercept = 29.5), col = "red", linetype="dotted") +
  theme(legend.position="right", legend.background = element_blank()); CRIMP.TEMP.PLOT 

ggsave(file="Output/CRIMP2-Temperature.png", CRIMP.TEMP.PLOT, width = 11, height = 6, units = c("in"))

#### pCO2
CRIMP2.pCO2 <- CRIMP2.data %>% select(-Temp) %>% filter(pCO2>0)
## need to run Carb Chem script to get output to overlay experimental data on CRIMP'S data 
EXPT.pCO2 <- read.csv("Environmental_data/Seawater_chemistry_table_Output_All.csv") %>% select(Timepoint, Treatment, pCO2) %>% 
  dplyr::rename(Data.Source = Treatment, Date = Timepoint) %>% filter(Data.Source != "Acclimation")
EXPT.pCO2$file.ID <- "EXPT"
EXPT.pCO2$Time <- "11:00"
EXPT.pCO2 <- EXPT.pCO2 %>% unite(Date.Time, Date, Time, sep=" ")
EXPT.pCO2$Date.Time <- ymd_hm(EXPT.pCO2$Date.Time, quiet=FALSE, tz="UTC", truncated=0) #format date and time the order of ymd_hm will depend on original format

CRIMP2.EXPT.pCO2 <- bind_rows(CRIMP2.pCO2, EXPT.pCO2) #combining both dataframes 

CRIMP.pCO2.PLOT <- ggplot(data = CRIMP2.EXPT.pCO2, aes(x = Date.Time, y = pCO2, color = Data.Source)) +
  labs(x = "Date (Month-Year)", y = "pCO2 (uatm)") + ggtitle("CRIMP2 NOAA Buoy") +
  geom_line(size=0.15) +
  scale_color_manual(values = crimp.colors) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "60 days", labels = date_format("%b %y")) +
  theme(legend.position="right", legend.background = element_blank()); CRIMP.pCO2.PLOT 

ggsave(file="Output/CRIMP2-pCO2.png", CRIMP.pCO2.PLOT, width = 11, height = 6, units = c("in"))
```

### HOBO LOGGER TEMPERATURE DATA ###  

Reading in and transforming hobo logger data. 
```{r}
tankIDs <- read.csv('Environmental_data/Tank_to_Treatment.csv')
tankIDs$Tank <- as.character(tankIDs$Tank)
  
#bind all hobo logger data sets together
Hobo.data <-
  list.files(path = 'Environmental_data/Temp_Hobo_Loggers', pattern = ".csv", full.names = TRUE) %>% # list files in directory following a particular pattern
  set_names(.) %>% # get the column names
  map_dfr(read.table, .id = "file.ID", header=FALSE, skip=1, sep=",") %>% # join all files together in one data frame by file ID
  group_by(file.ID) %>% # for each file do the following
  select(-V1) %>% dplyr::rename(Date.Time = V2, Temperature = V3)

Hobo.data$Date.Time <- mdy_hm(Hobo.data$Date.Time, quiet=FALSE, tz="UTC", truncated=0) #format date and time 

file.name <- c("Environmental_data/Temp_Hobo_Loggers/20190117_Tank1.csv", 
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank2.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank3.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank4.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank5.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank6.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank7.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank8.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank9.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank10.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank11.csv",
               "Environmental_data/Temp_Hobo_Loggers/20190117_Tank12.csv")
tank.ID <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12")
Hobo.data$Tank <- tank.ID[match(Hobo.data$file.ID, file.name)] #adding a tank number column based on the file.ID column 
Hobo.data$Tank <- as.character(Hobo.data$Tank) 

Hobo.data <- left_join(Hobo.data, tankIDs) %>% select(-Tank.Name) #adding treatment info to each tank

## Filtering for when hobo loggers were out of the tanks 

Hobo.data.filtered <- Hobo.data %>% na.omit() %>% 
  filter(!(Date.Time > as.POSIXct("2018-09-04 23:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-06 00:00:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-09-07 23:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-09 00:00:00", tz="UTC"))) %>%
  filter(!(Tank == "6" & Date.Time > as.POSIXct("2018-09-13 14:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-13 17:00:00", tz="UTC"))) %>%
  filter(!(Tank == "8" & Date.Time > as.POSIXct("2018-09-14 10:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-14 14:00:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-09-18 8:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-18 17:00:00", tz="UTC"))) %>%
  filter(!(Tank == "11" & Date.Time > as.POSIXct("2018-09-27 08:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-27 09:40:00", tz="UTC"))) %>%
  filter(!(Tank == "12" & Date.Time > as.POSIXct("2018-09-27 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-27 10:40:00", tz="UTC"))) %>%
  filter(!(Tank == "6" & Date.Time > as.POSIXct("2018-09-27 10:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-27 11:20:00", tz="UTC"))) %>%
  filter(!(Tank == "5" & Date.Time > as.POSIXct("2018-09-27 11:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-27 12:20:00", tz="UTC"))) %>%
  filter(!(Tank == "4" & Date.Time > as.POSIXct("2018-09-28 08:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 09:40:00", tz="UTC"))) %>%
  filter(!(Tank == "10" & Date.Time > as.POSIXct("2018-09-28 09:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 12:40:00", tz="UTC"))) %>%
  filter(!(Tank == "9" & Date.Time > as.POSIXct("2018-09-28 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 11:10:00", tz="UTC"))) %>%
  filter(!(Tank == "3" & Date.Time > as.POSIXct("2018-09-28 10:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 14:50:00", tz="UTC"))) %>%
  filter(!(Tank == "7" & Date.Time > as.POSIXct("2018-09-28 11:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 12:40:00", tz="UTC"))) %>%
  filter(!(Tank == "8" & Date.Time > as.POSIXct("2018-09-28 11:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 12:30:00", tz="UTC"))) %>%
  filter(!(Tank == "1" & Date.Time > as.POSIXct("2018-09-28 12:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 13:30:00", tz="UTC"))) %>%
  filter(!(Tank == "2" & Date.Time > as.POSIXct("2018-09-28 13:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-28 14:30:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-09-29 10:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-09-29 11:40:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-10-08 09:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 10:10:00", tz="UTC"))) %>%
  filter(!(Tank == "6" & Date.Time > as.POSIXct("2018-10-08 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 11:20:00", tz="UTC"))) %>%
  filter(!(Tank == "12" & Date.Time > as.POSIXct("2018-10-08 10:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 11:50:00", tz="UTC"))) %>%
  filter(!(Tank == "5" & Date.Time > as.POSIXct("2018-10-08 11:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 13:10:00", tz="UTC"))) %>%
  filter(!(Tank == "11" & Date.Time > as.POSIXct("2018-10-08 14:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 14:50:00", tz="UTC"))) %>%
  filter(!(Tank == "4" & Date.Time > as.POSIXct("2018-10-08 14:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 16:10:00", tz="UTC"))) %>%
  filter(!(Tank == "10" & Date.Time > as.POSIXct("2018-10-08 15:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-08 17:10:00", tz="UTC"))) %>%
  filter(!(Tank == "1" & Date.Time > as.POSIXct("2018-10-09 09:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 10:20:00", tz="UTC"))) %>%
  filter(!(Tank == "7" & Date.Time > as.POSIXct("2018-10-09 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 11:10:00", tz="UTC"))) %>%
  filter(!(Tank == "8" & Date.Time > as.POSIXct("2018-10-09 10:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 11:40:00", tz="UTC"))) %>%
  filter(!(Tank == "2" & Date.Time > as.POSIXct("2018-10-09 11:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 12:10:00", tz="UTC"))) %>%
  filter(!(Tank == "9" & Date.Time > as.POSIXct("2018-10-09 11:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 12:20:00", tz="UTC"))) %>%
  filter(!(Tank == "3" & Date.Time > as.POSIXct("2018-10-09 23:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 14:50:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-10-09 23:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-10 11:00:00", tz="UTC"))) %>%
  filter(!(Tank == "4" & Date.Time > as.POSIXct("2018-10-11 23:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-12 02:50:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-10-16 10:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-09 12:50:00", tz="UTC"))) %>%
  filter(!(Tank == "6" & Date.Time > as.POSIXct("2018-10-21 10:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 11:50:00", tz="UTC"))) %>%
  filter(!(Tank == "4" & Date.Time > as.POSIXct("2018-10-21 10:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 11:50:00", tz="UTC"))) %>%
  filter(!(Tank == "8" & Date.Time > as.POSIXct("2018-10-21 11:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 12:20:00", tz="UTC"))) %>%
  filter(!(Tank == "12" & Date.Time > as.POSIXct("2018-10-21 11:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 12:50:00", tz="UTC"))) %>%
  filter(!(Tank == "1" & Date.Time > as.POSIXct("2018-10-21 12:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 13:50:00", tz="UTC"))) %>%
  filter(!(Tank == "11" & Date.Time > as.POSIXct("2018-10-21 12:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 14:30:00", tz="UTC"))) %>%
  filter(!(Tank == "5" & Date.Time > as.POSIXct("2018-10-21 13:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 15:10:00", tz="UTC"))) %>%
  filter(!(Tank == "3" & Date.Time > as.POSIXct("2018-10-21 14:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 50:00:00", tz="UTC"))) %>%
  filter(!(Tank == "9" & Date.Time > as.POSIXct("2018-10-21 14:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 15:20:00", tz="UTC"))) %>%
  filter(!(Tank == "10" & Date.Time > as.POSIXct("2018-10-21 15:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 15:50:00", tz="UTC"))) %>%
  filter(!(Tank == "7" & Date.Time > as.POSIXct("2018-10-21 15:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 16:30:00", tz="UTC"))) %>%
  filter(!(Tank == "2" & Date.Time > as.POSIXct("2018-10-21 15:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 17:10:00", tz="UTC"))) %>%
  filter(!(Tank == "12" & Date.Time > as.POSIXct("2018-10-21 09:30:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 10:50:00", tz="UTC"))) %>%
  filter(!(Tank == "11" & Date.Time > as.POSIXct("2018-10-21 10:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 11:50:00", tz="UTC"))) %>%
  filter(!(Tank == "10" & Date.Time > as.POSIXct("2018-10-21 12:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 14:10:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-11-01 00:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-02 11:10:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-11-08 08:40:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-08 12:20:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-11-08 12:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-08 13:10:00", tz="UTC"))) %>%
  filter(!(Tank == "12" & Date.Time > as.POSIXct("2018-11-09 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-09 10:50:00", tz="UTC"))) %>%
  filter(!(Tank == "5" & Date.Time > as.POSIXct("2018-11-09 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-09 10:50:00", tz="UTC"))) %>%
  filter(!(Tank == "9" & Date.Time > as.POSIXct("2018-11-09 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-09 11:20:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-11-28 12:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-28 14:00:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-12-05 09:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-12-05 10:40:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-12-12 11:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-12-12 12:10:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-12-19 10:10:00", tz="UTC") & Date.Time < as.POSIXct("2018-12-19 11:10:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-12-26 12:20:00", tz="UTC") & Date.Time < as.POSIXct("2018-12-26 13:10:00", tz="UTC"))) %>%
  filter(!(Date.Time == as.POSIXct("2018-11-19 09:40:00", tz="UTC"))) %>% # abnormally low temp in ATAC -2C than the 10 min after and before 
  filter(!(Date.Time > as.POSIXct("2018-11-19 09:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-19 11:00:00", tz="UTC"))) %>% # HTHC low; heaters broke?
  filter(!(Date.Time > as.POSIXct("2018-11-07 16:00:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-07 16:40:00", tz="UTC"))) %>% # HTHC were low; heaters broken? We had a lot of trouble with outlets. If I had to put my hand in the tank I would've turned them off briefly
  filter(!(Date.Time == as.POSIXct("2018-11-08 12:20:00", tz="UTC"))) %>%
  filter(!(Date.Time > as.POSIXct("2018-10-20 23:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-10-21 10:30:00", tz="UTC")))

Hobo.filtered.means <- summarySE(Hobo.data.filtered, measurevar = "Temperature", groupvars=c("Date.Time", "Treatment")) #N, mean(Temperature), sd, se, ci
Hobo.means <- summarySE(Hobo.data, measurevar = "Temperature", groupvars=c("Date.Time", "Treatment")) #N, mean(Temperature), sd, se, ci

Hobo.daily <- Hobo.data %>% separate(Date.Time, c("Date", "Time"), sep = " ") %>% filter(!is.na(Temperature))
Hobo.daily.means <- summarySE(Hobo.daily, measurevar = "Temperature", groupvars=c("Time", "Treatment"))
```

```{r}
Expt.hobo <- Hobo.data %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-17 08:00:00", tz="UTC"))) %>% na.omit()
Expt.hobo$Date <- as.Date(Expt.hobo$Date.Time)
Expt.hobo$Time <- format(Expt.hobo$Date.Time, "%H %M %S")

Hobo.treatment <- summarySE(Expt.hobo, measurevar = "Temperature", groupvars=c("Treatment")) #N, mean(Temperature), sd, se, ci
Hobo.date <- summarySE(Expt.hobo, measurevar = "Temperature", groupvars=c("Treatment", "Date")) #N, mean(Temperature), sd, se, ci

write_csv(file = "Environmental_data/HOBO-Temperature-Treatment.csv", Hobo.treatment)
write_csv(file = "Environmental_data/HOBO-Temperature-Date.csv", Hobo.date)
```

#### Parsing `Hobo.data.filtered` into acclimation and treatment dfs 

For final figure (part of Figure 1)

```{r}
## subsetting acclimation period means 
acclimation.period <- Hobo.data.filtered %>% filter((Date.Time < as.POSIXct("2018-09-22 06:50:00", tz="UTC"))) %>% 
  filter(Temperature < 29)
acc.period.means <- summarySE(acclimation.period, measurevar = "Temperature", groupvars=c("Date.Time"))
acc.period.means$Treatment <- "Acclimation"

## subseting the means table from above but just to treatment 
treatment.period.means <- Hobo.filtered.means %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC")))

means.figure.one <- bind_rows(acc.period.means, treatment.period.means)

fig1.colors <- c("black", "blue", "lightblue", "salmon", "red3")

fig1 <- ggplot(data = means.figure.one, aes(x = Date.Time, y = Temperature, colour = Treatment)) +
  geom_point(size=0.1) +
  scale_color_manual(values = fig1.colors) +
  labs(x = "Date",
       y = "Temperature (°C)") +
  #geom_line(aes(group=Treatment)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "20 days", labels = date_format("%b")) +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-09-22 07:00:00"))), col = "black", linetype="dotted", size=2) +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-11-17 07:00:00"))), col = "black", linetype="dotted", size=2) +
  #geom_text(aes(x="Sep 21", label="treatment starts", y=20), colour="blue", angle=90, text=element_text(size=11)) +
  theme(legend.position=c(0.85, 0.75), legend.background = element_blank()) +
  theme(axis.text = element_text(size = 12)) + 
  theme(axis.title = element_text(size = 15)) +
  theme(legend.text = element_text(size = 13)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  theme(legend.title = element_text(size = 15))

ggsave(filename = "Output/Manuscript_figures/Hobo-loggers-figure1.png", fig1, device = "png", width = 9, height = 5)

means.figure.one.daily <- means.figure.one %>%
  separate(Date.Time, c("Date", "Time"), sep = " ") #%>% subset(Date == "2018-10-05")

fig1_subset_daily <- ggplot(data = Hobo.daily.means, aes(x = Time, y = Temperature, color = Treatment)) +
  labs(x="", y = "Temperature (°C)") +
  geom_point(size=1) +
  scale_color_manual(values = c("blue", "lightblue", "salmon", "red3")) + 
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  #scale_x_datetime(date_breaks = "2 hours", labels = date_format("%h %m")) +
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 17)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(legend.position="none", legend.background = element_blank()); fig1_subset_daily
  
ggsave(filename = "Output/Manuscript_figures/Hobo-loggers-figure1-daily.png", fig1_subset_daily, device = "png", width = 5, height = 3)
```



 Visualizing data. 
```{r}
colors <- c("lightblue", "blue", "salmon", "red3")

Hobo <- ggplot(data = Hobo.means, aes(x = Date.Time, y = Temperature, colour = Treatment)) +
  #geom_point(size=0.2) +
  scale_color_manual(values = colors) +
  labs(x = "Date",
       y = "Temperature (°C)") +
  geom_line(aes(group=Treatment)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "7 days", labels = date_format("%b %d")) +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-09-22 07:00:00"))), col = "black", linetype="dotted") +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-11-17 07:00:00"))), col = "black", linetype="dotted") +
  theme(legend.position=c(0.9, 0.8), legend.background = element_blank()) 

Hobo.parsed <- ggplot(data = Hobo.filtered.means, aes(x = Date.Time, y = Temperature, colour = Treatment)) +
  #geom_point(size=0.2) +
  scale_color_manual(values = colors) +
  labs(x = "Date",
       y = "Temperature (°C)") +
  geom_line(aes(group=Treatment)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_datetime(date_breaks = "7 days", labels = date_format("%b %d")) +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-09-22 07:00:00"))), col = "black", linetype="dotted") +
  geom_vline(aes(xintercept = as.integer(as.POSIXct("2018-11-17 07:00:00"))), col = "black", linetype="dotted") +
  theme(legend.position=c(0.9, 0.8), legend.background = element_blank()) 

ggsave(filename = "Output/Hobo-loggers.pdf", Hobo, device = "pdf", width = 11, height = 8)
ggsave(filename = "Output/Hobo-loggers.png", Hobo, device = "png", width = 11, height = 8)

ggsave(filename = "Output/Hobo-loggers-parsed.pdf", Hobo.parsed, device = "pdf", width = 11, height = 8)
ggsave(filename = "Output/Hobo-loggers-parsed.png", Hobo.parsed, device = "png", width = 11, height = 8)
```

Export data table. 
```{r}
#install.packages("kableExtra")
library(kableExtra)

# CURRENTLY DONE WITH FILTERED DATA 
# separating date and time to then average by date, month, etc.. 
dt <- Hobo.filtered.means %>% na.omit()
dt$Date <- as.Date(dt$Date.Time)
dt$Time <- format(dt$Date.Time, "%H:%M:%S")

dt.treatment <- dt %>% filter((Date.Time > as.POSIXct("2018-09-22 06:50:00", tz="UTC") & Date.Time < as.POSIXct("2018-11-17 08:00:00", tz="UTC")))

dt.date.avg.hobo <- summarySE(dt, measurevar = "Temperature", groupvars=c("Date", "Treatment")) #N, mean(Temperature), sd, se, ci
dt.trt.avg.hobo <- summarySE(dt.treatment, measurevar = "Temperature", groupvars=c("Treatment")) 

# Exporting hobo logger tables
write_csv(path = "Environmental_data/Hobologger-Treatment.csv", dt.trt.avg.hobo)
write_csv(path = "Environmental_data/Hobologger-Date.csv", dt.date.avg.hobo)
```


### FLOW RATES ### 

Reading in flow rate and tank to treatment data files. 
```{r}
Flow_tank_info <-read.csv('Environmental_data/Tank_to_Treatment.csv', header=T, sep=",") %>% select(-Tank.Name)
Flow_Data <- read.csv('Environmental_data/Flow_rate.csv', header=T, sep=",") %>% select(-Trial, -Rate)
Flow_Data <- subset(Flow_Data, Final_Rate=="Yes") # subsetting to only the final rates 
Flow_Data$Tank <- as.character(Flow_Data$Tank) # changing Tank values to character instead of numeric
```

Merging the two datafiles by Tank and ordering by specific Tank name (based on treatments)
```{r}
Flow_Data <- merge(Flow_Data, Flow_tank_info, by="Tank")
Flow_Data$ml.sec <- Flow_Data$Volume.ml/Flow_Data$Time.sec
```

Visualizing flow rate data. 
```{r}
treatment_colors <- c("blue", "lightblue", "salmon", "red3")
tank_colors <- c("blue", "red3", "lightblue", "lightblue", "red3", "lightblue", "salmon", "red3", "blue", "salmon", "blue", "salmon")

## BY TREATMENT
ggplot(Flow_Data, aes(x=Treatment, y=ml.sec, fill=Treatment)) + 
  geom_boxplot() +
  scale_fill_manual(values = treatment_colors) +
  geom_jitter(color="black", size=0.4, alpha=0.9) + 
  theme_classic() + 
  theme(legend.position="none", plot.title = element_text(size=11)) + 
  xlab("Treatment") + 
  ylab("Flow Rates (mL/sec)")

## BY TREATMENT AND TANK
ggplot(Flow_Data, aes(x=Tank, y=ml.sec, fill=Tank)) + 
  geom_boxplot() +
  scale_fill_manual(values = tank_colors) +
  scale_x_discrete(limits=c("1","6","8", "3", "11", "12", "4", "7", "9", "2", "5", "10")) + 
  geom_jitter(color="black", size=0.4, alpha=0.9) + 
  theme_classic() + 
  theme(legend.position="none", plot.title = element_text(size=11)) + 
  xlab("Tank Number") + 
  ylab("Flow Rates (mL/sec)")
```

Statistical analyses. 
```{r}
tank.lm <- lm(ml.sec ~ Tank, data=Flow_Data)
tank.anova <- aov(ml.sec ~ Tank, data=Flow_Data)
summary(tank.lm)
summary(tank.anova)

trt.lm <- lm(ml.sec ~ Treatment, data=Flow_Data)
trt.anova <- aov(ml.sec ~ Treatment, data=Flow_Data)
summary(trt.lm)
summary(trt.anova)
```

### CREATING ENV. DATA TABLE ### 

```{r}
HOBO.dt.date <- read.csv("Environmental_data/HOBO-Temperature-Treatment.csv")
HOBO.dt.trt <- read.csv("Environmental_data/HOBO-Temperature-Date.csv")

APEX.dt.temp.date <- read.csv("Environmental_data/Apex-Temperature-Date.csv")
APEX.dt.temp.trt <- read.csv("Environmental_data/Apex-Temperature-Treatment.csv")

APEX.dt.pH.date <- read.csv("Environmental_data/Apex-pH-Date.csv")
APEX.dt.pH.trt <- read.csv("Environmental_data/Apex-pH-Treatment.csv")



```

